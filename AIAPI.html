<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Gemini/Gemma API</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            options: { enableMenu: false },
            chtml: { fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2' }
        };
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff;
            --ai-bg: #ffffff;
            --user-bg: #007bff;
            --body-bg: #f0f2f5;
        }
        
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; margin: 0; background: var(--body-bg); display: flex; flex-direction: column; height: 100vh; }
        header { background: #2c3e50; color: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h3 { margin: 0; font-weight: 400; letter-spacing: 1px; }

        .main-container { display: flex; flex: 1; padding: 20px 40px; gap: 20px; overflow: hidden; }
        #chat-box { flex: 1; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); padding: 30px; overflow-y: auto; display: flex; flex-direction: column; border: 1px solid #e0e0e0; }

        .info-panel { width: 400px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .info-card { background: #ffffff; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); font-size: 14px; border: 1px solid #e0e0e0; }
        
        .quota-item { margin: 12px 0; color: #555; line-height: 1.5; }
        .quota-tag { background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-weight: bold; color: #2c3e50; }
        .status-active { color: #28a745; font-weight: bold; }
        .status-off { color: #6c757d; font-weight: bold; }

        .setting-input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 12px; }
        .proxy-group { display: flex; gap: 5px; align-items: flex-end; }
        
        .btn-help { 
            background: #f8f9fa; color: #6c757d; border: 1px solid #ddd; 
            width: 28px; height: 28px; border-radius: 50%; font-size: 14px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;
        }
        .btn-help:hover { background: #e2e6ea; color: #2c3e50; border-color: #adb5bd; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { 
            background: white; 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 25px; border-radius: 15px; width: 90%; max-width: 600px;
            max-height: 85vh; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translate(-50%, -60%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .code-block { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 8px; font-family: monospace; position: relative; margin-top: 15px; overflow-x: auto; white-space: pre; }
        .copy-btn { position: absolute; right: 10px; top: 10px; background: #4e4e4e; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; }
        .copy-btn:hover { background: #666; }

        .msg { margin: 15px 0; padding: 15px 20px; border-radius: 18px; word-wrap: break-word; max-width: 85%; line-height: 1.7; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .user { background: var(--user-bg); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .ai { background: var(--ai-bg); color: #333; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #eee; }

        .typing { font-style: italic; color: #999; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        pre { background: #1e1e1e; color: #dcdcdc; padding: 15px; border-radius: 10px; overflow-x: auto; margin: 10px 0; }
        code { font-family: 'Consolas', 'Monaco', monospace; font-size: 0.95em; }
        :not(pre) > code { background: #f0f0f0; color: #444; padding: 2px 5px; border-radius: 4px; }

        .file-attachment-tag { display: block; font-size: 12px; background: rgba(255, 255, 255, 0.2); padding: 4px 8px; border-radius: 5px; margin-bottom: 8px; border-left: 3px solid #fff; }
        mjx-container { max-width: 100%; overflow-x: auto; overflow-y: hidden; vertical-align: middle; }

        .ai table { border-collapse: collapse; width: 100%; margin: 15px 0; font-size: 14px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .ai th { background: #f8f9fa; padding: 12px; border: 1px solid #ddd; }
        .ai td { padding: 12px; border: 1px solid #ddd; }
        .ai tr:nth-child(even) { background-color: #fafafa; }

        .footer-input { padding: 15px 40px; background: #fff; border-top: 1px solid #ddd; }
        .input-group { display: flex; gap: 12px; max-width: 1200px; margin: 0 auto; align-items: center; }
        input[type="text"] { flex: 1; padding: 15px; border: 2px solid #eee; border-radius: 10px; outline: none; font-size: 16px; transition: 0.3s; }
        input[type="text"]:focus { border-color: var(--primary-color); }
        
        button { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 15px; transition: 0.2s; }
        #sendBtn { background: #28a745; color: white; }
        #sendBtn:hover { background: #218838; }
        #sendBtn:disabled { background: #ccc; cursor: not-allowed; }
        
        .btn-file { background: #6c757d; color: white; white-space: nowrap; }
        .btn-file:hover { background: #5a6268; }

        #file-preview-area { 
            max-width: 1200px; margin: 0 auto 10px auto; 
            padding: 8px 15px; background: #fff3cd; color: #856404;
            border-radius: 8px; font-size: 13px; display: none;
            border: 1px solid #ffeeba;
        }

        .mode-btn { width: 100%; margin-top: 5px; padding: 10px; font-size: 13px; }
        .btn-on { background: #28a745; color: white; margin-bottom: 5px; }
        .btn-off { background: #6c757d; color: white; }
    </style>
</head>
<body>

    <header>
        <h3>Gemini/Gemma API</h3>
    </header>

    <div id="proxyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeProxyModal()">&times;</span>
            <h4 style="margin-top:0">ğŸ’¡ Proxy ä½ˆç½²ä»£ç¢¼èªªæ˜</h4>
            <p style="font-size: 14px; color: #666;">è«‹è¤‡è£½ä¸‹æ–¹ä»£ç¢¼ä¸¦éƒ¨ç½²è‡³æ‚¨çš„æœå‹™ç’°å¢ƒï¼š</p>
            <div class="code-block">
                <button class="copy-btn" onclick="copyProxyCode()">è¤‡è£½å…§å®¹</button>
                <code id="proxyCodeContent">export default {
  async fetch(request, env) {
    const corsHeaders = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type",
    };

    if (request.method === "OPTIONS") return new Response(null, { headers: corsHeaders });

    const url = new URL(request.url);
    const targetUrl = `https://generativelanguage.googleapis.com${url.pathname}${url.search}`;

    try {
      const modifiedRequest = new Request(targetUrl, {
        method: request.method,
        headers: { "Content-Type": "application/json" },
        body: request.method === "POST" ? await request.text() : null
      });

      const response = await fetch(modifiedRequest);
      const resBody = await response.text(); 
      
      return new Response(resBody, {
        status: response.status,
        headers: { ...corsHeaders, "Content-Type": "application/json" }
      });
    } catch (e) {
      return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: corsHeaders });
    }
  }
}</code>
            </div>
            <p style="font-size: 12px; color: #999; margin-top: 15px;">â€» æç¤ºï¼šä½ˆç½²å®Œæˆå¾Œè«‹ç¢ºä¿ç¶²å€æ­£ç¢ºå¡«å…¥ Proxy æ¬„ä½ã€‚</p>
        </div>
    </div>

    <div class="main-container">
        <div id="chat-box"></div>

        <div class="info-panel">
            <div class="info-card">
                <h4>ğŸ“Š Information</h4>
                <div class="quota-item">Modelï¼š
                    <select id="modelSelect" class="setting-input">
                        <option value="gemma-3-1b-it">Gemma 3 1B</option>
                        <option value="gemma-3-4b-it">Gemma 3 4B</option>
                        <option value="gemma-3-12b-it">Gemma 3 12B</option>
                        <option value="gemma-3-27b-it">Gemma 3 27B</option>
                        <option value="gemini-flash-latest">Gemini 2.0 Flash</option>
                        <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    </select>
                </div>
                <div class="quota-item" style="overflow-x: auto;">å…è²»æµé‡é…é¡ï¼š
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 8px; text-align: left; line-height: 1.2;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                                <th style="padding: 4px; border: 1px solid #eee;">æ¨¡å‹</th>
                                <th style="padding: 4px; border: 1px solid #eee;">RPM</th>
                                <th style="padding: 4px; border: 1px solid #eee;">TPM</th>
                                <th style="padding: 4px; border: 1px solid #eee;">RPD</th>
                                <th style="padding: 4px; border: 1px solid #eee;">å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee;">Gemma 3 1B</td>
                                <td style="padding: 4px; border: 1px solid #eee;">30</td>
                                <td style="padding: 4px; border: 1px solid #eee;">15K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">14.4K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">å›ç­”å¿« é‚è¼¯å·®</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee;">Gemma 3 4B</td>
                                <td style="padding: 4px; border: 1px solid #eee;">30</td>
                                <td style="padding: 4px; border: 1px solid #eee;">15K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">14.4K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">...</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee;">Gemma 3 12B</td>
                                <td style="padding: 4px; border: 1px solid #eee;">30</td>
                                <td style="padding: 4px; border: 1px solid #eee;">15K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">14.4K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">...</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee;">Gemma 3 27B</td>
                                <td style="padding: 4px; border: 1px solid #eee;">30</td>
                                <td style="padding: 4px; border: 1px solid #eee;">15K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">14.4K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">å›ç­”æ…¢ é‚è¼¯å·®</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee;">Gemini 2.5 Flash Lite</td>
                                <td style="padding: 4px; border: 1px solid #eee;">10</td>
                                <td style="padding: 4px; border: 1px solid #eee;">250K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">20</td>
                                <td style="padding: 4px; border: 1px solid #eee;">å¯è®€é™„ä»¶-è¼ƒå¼±</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee;">Gemini 2.5 Flash</td>
                                <td style="padding: 4px; border: 1px solid #eee;">5</td>
                                <td style="padding: 4px; border: 1px solid #eee;">250K</td>
                                <td style="padding: 4px; border: 1px solid #eee;">20</td>
                                <td style="padding: 4px; border: 1px solid #eee;">å¯è®€é™„ä»¶-æœ€å¼·</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <hr style="border:0; border-top:1px solid #eee">
                <div class="quota-item">å°è©±æ¨¡å¼ï¼š<span id="mode-status" class="status-off">ç¨ç«‹å°è©± (ç„¡è¨˜æ†¶)</span></div>
                
                <button class="mode-btn btn-on" onclick="setContext(true)">é–‹å•Ÿé€£è²«å°è©±</button>
                <button class="mode-btn btn-off" onclick="setContext(false)">é—œé–‰é€£è²«å°è©±</button>
                
                <button onclick="clearHistory()" style="background:#f8f9fa; color:#666; border:1px solid #ddd; width:100%; padding:8px; font-size:12px; margin-top:10px;">æ‰‹å‹•æ¸…é™¤æ­·å²ç´€éŒ„</button>
            </div>

            <div class="info-card">
                <h4>âš™ï¸ API & Proxyè¨­å®š</h4>
                <div class="quota-item">
                    Gemini API Key:
                    <input type="password" id="apiKeyInput" class="setting-input" value="AIzaSyBJoMzyeqQ2ZuKP7grMc7_gXMV_4h0NZlk" placeholder="è¼¸å…¥ API Key...">
                </div>
                <div class="quota-item">
                    Proxy ç¶²å€:
                    <div class="proxy-group">
                        <input type="text" id="proxyUrlInput" class="setting-input" value="https://twilight-hat-0814.postle841220.workers.dev" placeholder="https://...">
                        <button class="btn-help" onclick="openProxyModal()" title="æŸ¥çœ‹ Proxy ä»£ç¢¼ç¯„ä¾‹">?</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-input">
        <div id="file-preview-area"></div>
        <div class="input-group">
            <input type="file" id="fileInput" accept=".pdf,.docx" style="display:none">
            <button class="btn-file" onclick="document.getElementById('fileInput').click()">é¸æ“‡é™„ä»¶ (PDF/Word)</button>
            <input type="text" id="userInput" placeholder="è«‹è¼¸å…¥... (æŒ‰Enteré€å‡º)">
            <button id="sendBtn" onclick="sendMessage()">å‚³é€è¨Šæ¯</button>
        </div>
    </div>

    <script>
        let chatHistory = [];
        let isContextEnabled = false; 
        let currentFilePart = null;
        let currentFileName = "";

        function openProxyModal() { document.getElementById('proxyModal').style.display = 'block'; }
        function closeProxyModal() { document.getElementById('proxyModal').style.display = 'none'; }
        window.onclick = function(event) { if (event.target == document.getElementById('proxyModal')) closeProxyModal(); }
        
        function copyProxyCode() {
            const code = document.getElementById('proxyCodeContent').innerText;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.innerText = 'å·²è¤‡è£½ï¼';
                setTimeout(() => { btn.innerText = 'è¤‡è£½å…§å®¹'; }, 2000);
            });
        }

        function setContext(enabled) {
            isContextEnabled = enabled;
            const status = document.getElementById('mode-status');
            if (enabled) {
                status.innerText = "é€£è²«å°è©±ä¸­";
                status.className = "status-active";
            } else {
                status.innerText = "ç¨ç«‹å°è©± (ç„¡è¨˜æ†¶)";
                status.className = "status-off";
            }
        }

        function clearHistory() {
            chatHistory = [];
            document.getElementById('chat-box').innerHTML = '<div class="msg ai">å°è©±è¨˜æ†¶å·²é‡ç½®ã€‚</div>';
        }

        document.getElementById('userInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ä¿®æ”¹é»ï¼šåœ¨æ­¤è™•åŠ å…¥æ¨¡å‹åˆ¤æ–·é‚è¼¯
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // åˆ¤æ–·ç•¶å‰é¸æ“‡çš„æ¨¡å‹
            const selectedModel = document.getElementById('modelSelect').value;
            const allowedModels = ['gemini-2.5-flash-lite', 'gemini-2.5-flash'];
            
            if (!allowedModels.includes(selectedModel)) {
                alert("âš ï¸ ç›®å‰æ‰€é¸çš„æ¨¡å‹ä¸æ”¯æŒä¸Šå‚³é™„ä»¶ã€‚\nè«‹åˆ‡æ›è‡³ Gemini 2.5 Flash æˆ– Lite ç‰ˆæœ¬ã€‚");
                this.value = ""; // æ¸…ç©ºé¸æ“‡
                return;
            }

            currentFileName = file.name;
            const previewArea = document.getElementById('file-preview-area');
            previewArea.style.display = "block";
            previewArea.innerHTML = `â³ è®€å–ä¸­ï¼š<b>${file.name}</b>`;

            if (file.type === "application/pdf") {
                const reader = new FileReader();
                reader.onload = function() {
                    currentFilePart = { inline_data: { mime_type: "application/pdf", data: reader.result.split(',')[1] } };
                    previewArea.innerHTML = `âœ… ç›®å‰å¤¾å¸¶ï¼š<b>${file.name}</b> (PDF)`;
                };
                reader.readAsDataURL(file);
            } else if (file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const result = await mammoth.extractRawText({ arrayBuffer: event.target.result });
                        currentFilePart = { text: `[æ–‡ä»¶å…§å®¹]:\n${result.value}` };
                        previewArea.innerHTML = `âœ… ç›®å‰å¤¾å¸¶ï¼š<b>${file.name}</b> (Word)`;
                    } catch (err) {
                        previewArea.innerHTML = `âŒ æª”æ¡ˆè®€å–å¤±æ•—`;
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        async function sendMessage() {
            const API_KEY = document.getElementById('apiKeyInput').value;
            const WORKER_URL = document.getElementById('proxyUrlInput').value;
            const MODEL_NAME = document.getElementById('modelSelect').value; 

            const input = document.getElementById('userInput');
            const btn = document.getElementById('sendBtn');
            const previewArea = document.getElementById('file-preview-area');
            const text = input.value.trim();

            if (!text && !currentFilePart) return;

            appendMsg('user', text, currentFileName);
            input.value = '';
            btn.disabled = true;
            previewArea.style.display = "none";

            const typingDiv = document.createElement('div');
            typingDiv.className = 'msg ai typing';
            typingDiv.id = 'ai-typing-indicator';
            typingDiv.innerText = `ğŸš€ ${MODEL_NAME} æ­£åœ¨æ€è€ƒä¸­...`;
            document.getElementById('chat-box').appendChild(typingDiv);
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;

            const currentParts = [];
            if (currentFilePart) currentParts.push(currentFilePart);
            if (text) currentParts.push({ text: text });

            chatHistory.push({ role: "user", parts: currentParts });

            try {
                const payload = isContextEnabled ? chatHistory : [{ role: "user", parts: currentParts }];
                const response = await fetch(`${WORKER_URL}/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: payload })
                });

                const data = await response.json();
                const indicator = document.getElementById('ai-typing-indicator');
                if (indicator) indicator.remove();

                if (data.candidates && data.candidates[0].content) {
                    const aiRawText = data.candidates[0].content.parts[0].text;
                    appendMsg('ai', aiRawText);
                    chatHistory.push({ role: "model", parts: [{ text: aiRawText }] });
                } else {
                    appendMsg('ai', "âŒ é‡åˆ°å•é¡Œï¼š\n" + JSON.stringify(data));
                }
            } catch (err) {
                const indicator = document.getElementById('ai-typing-indicator');
                if (indicator) indicator.remove();
                appendMsg('ai', "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚\n" + err.message);
            } finally {
                btn.disabled = false;
                currentFilePart = null;
                currentFileName = "";
                document.getElementById('fileInput').value = "";
            }
        }

        function appendMsg(role, content, fileName = "") {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            let htmlContent = role === 'user' && fileName ? `<small class="file-attachment-tag">ğŸ“ æª”æ¡ˆï¼š${fileName}</small>` : "";
            div.innerHTML = htmlContent + marked.parse(content);
            if (window.MathJax && window.MathJax.typesetPromise) { window.MathJax.typesetPromise([div]); }
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>