<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多因子模型 (僅美股用)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a; --bg-panel: #1e293b; --text-main: #f8fafc; --text-sub: #94a3b8;
            --accent-blue: #3b82f6; --accent-green: #10b981; --accent-red: #ef4444; --accent-yellow: #f59e0b;
            --border: #334155; --risk-bg: #450a0a;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }

        /* 頂部控制列 */
        .header {
            background: var(--bg-panel); padding: 20px; border-radius: 12px;
            display: flex; gap: 15px; align-items: flex-end; border: 1px solid var(--border);
            margin-bottom: 20px; flex-wrap: wrap;
        }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.85rem; color: var(--text-sub); }
        input { background: #0b1120; border: 1px solid #475569; color: white; padding: 10px; border-radius: 6px; }
        /* API Key 專用樣式 */
        #inpApiKey { width: 280px; letter-spacing: 2px; color: #facc15; font-family: monospace; }

        button {
            background: var(--accent-blue); color: white; border: none; padding: 11px 25px;
            border-radius: 6px; cursor: pointer; font-weight: 600; height: 42px; width: 220px;
        }
        button:disabled { background: #475569; cursor: not-allowed; }

        /* ★ V9.0 總經矩陣 (保留樣式) */
        .macro-container {
            display: none; grid-template-columns: 2fr 1fr; gap: 20px;
            background: rgba(15, 23, 42, 0.8); border: 1px solid var(--accent-blue); border-radius: 12px;
            padding: 20px; margin-bottom: 20px; display: none; height: auto; overflow: visible;
        }
        .matrix-box { background: var(--bg-panel); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
        .matrix-header { background: #334155; padding: 10px 15px; font-weight: bold; color: var(--accent-yellow); display: flex; justify-content: space-between; align-items: center; }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .matrix-table th { text-align: left; padding: 8px 15px; color: var(--text-sub); border-bottom: 1px solid var(--border); }
        .matrix-table td { padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .score-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; }
        .tag-pos { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .tag-neg { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .tag-neu { background: rgba(148, 163, 184, 0.2); color: var(--text-sub); }

        .macro-summary { display: flex; flex-direction: column; justify-content: space-between; }
        .impact-box { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent-blue); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 10px; }
        .impact-score { font-size: 2.5rem; font-weight: 800; line-height: 1; margin: 5px 0; }
        .formula-text { font-size: 0.8rem; color: var(--text-sub); line-height: 1.4; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }

        /* 主佈局 */
        .grid-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; opacity: 0; transition: opacity 0.5s; }
        .report-card {
            background: var(--bg-panel); 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            height: auto; 
        }

        .total-score-box { text-align: center; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .score-display {
            font-size: 5rem; 
            font-weight: 800; 
            line-height: 1.2; 
            margin: 10px 0;
            color: #f8fafc; /* 預設白色，JS 會根據分數改色 */
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); /* 增加一點發光質感 */
        }

        .verdict { font-size: 1.2rem; font-weight: bold; padding: 5px 15px; border-radius: 20px; display: inline-block; }

        /* 策略卡 */
        .strategy-card { background: rgba(59, 130, 246, 0.08); border: 1px solid var(--accent-blue); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .strategy-header { font-weight: bold; color: var(--accent-blue); font-size: 1.1rem; margin-bottom: 15px; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 10px; }
        .st-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .st-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }
        .st-label { font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        .st-val { font-size: 1.1rem; font-family: monospace; font-weight: bold; color: white; }
        .st-formula { font-size: 0.75rem; color: #64748b; margin-top: 2px; }

        .metric-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 15px; }
        .metric-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .metric-title { font-size: 1rem; font-weight: bold; color: #e2e8f0; }
        
        .metric-score-box { 
            background: #0f172a; border: 1px solid #475569; padding: 2px 10px; border-radius: 6px; 
            font-family: monospace; font-weight: bold; font-size: 1.1rem; color: #facc15; 
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .metric-score-box:hover { background: #334155; border-color: var(--accent-yellow); transform: scale(1.05); }
        .metric-score-box::after { content: 'ℹ️'; font-size: 0.7rem; opacity: 0.7; }

        .bar-bg { height: 6px; background: #334155; border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.8s ease-out; }
        .metric-status { font-size: 0.9rem; font-weight: bold; margin-bottom: 4px; color: #f8fafc; }
        .metric-logic { font-size: 0.8rem; color: #94a3b8; line-height: 1.4; }

        .charts-area { display: flex; flex-direction: column; gap: 15px; }
        .chart-box { background: var(--bg-panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); position: relative; }
        #chartMainBox { height: 500px; } .sub-chart { height: 300px; }
        .loading { color: var(--accent-blue); display: none; margin-left: 10px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #1e293b; border: 1px solid var(--accent-blue); width: 500px; border-radius: 12px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); position: relative;
        }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }
        .modal-title { font-size: 1.4rem; font-weight: bold; color: white; margin-bottom: 5px; }
        .modal-weight { display: inline-block; background: var(--accent-blue); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 15px; }
        .formula-list { list-style: none; padding: 0; margin: 0; font-size: 0.95rem; color: #cbd5e1; }
        .formula-list li { margin-bottom: 10px; padding-left: 15px; border-left: 3px solid #475569; }
    </style>
</head>
<body>

<div class="modal-overlay" id="scoreModal" onclick="closeModal(event)">
    <div class="modal-content">
        <span class="modal-close" onclick="document.getElementById('scoreModal').style.display='none'">&times;</span>
        <div class="modal-title" id="mTitle">指標名稱</div>
        <div class="modal-weight" id="mWeight">權重: 20%</div>
        <ul class="formula-list" id="mFormula">
            </ul>
    </div>
</div>

<div class="container">
    <div class="header">
        <div class="input-group">
            <label>股票代號</label>
            <input type="text" id="inpSymbol" value="TSLA" style="width: 100px;">
        </div>
        <div class="input-group">
            <label>年限</label>
            <input type="number" id="inpYears" value="1" min="1" max="5" style="width: 80px;">
        </div>
        <div class="input-group">
            <label>API Key</label>
            <input type="password" id="inpApiKey" value="e9e9c1790b11411abfb50f990984fbf1" oncopy="return false" oncut="return false">
        </div>
        <button onclick="startSystem()" id="btnStart">RUN MODEL</button>
        <div class="loading" id="loadingMsg">跑一下.. 很快</div>
    </div>


<div id="stockInfoPanel" style="width: 100%; margin-bottom: 20px; display: none;">
    <div style="background: var(--bg-panel); border: 1px solid #334155; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
        <div style="display: flex; align-items: baseline; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 10px; flex-wrap: wrap;">
            <div style="font-size: 1.8rem; font-weight: bold; color: var(--text-main);" id="infoPrice">--</div>
            <div style="font-size: 0.9rem; color: var(--text-sub); margin-left: 8px;">(<span id="infoDateMain">--</span> 價格)</div>
            
            <div style="display: flex; gap: 15px; font-size: 0.85rem; margin-left: 30px;">
                <div style="color: var(--text-sub);">日: <span id="chgDay">--</span></div>
                <div style="color: var(--text-sub);">週: <span id="chgWeek">--</span></div>
                <div style="color: var(--text-sub);">月: <span id="chgMonth">--</span></div>
                <div style="color: var(--text-sub);">季: <span id="chgQuarter">--</span></div>
                <div style="color: var(--text-sub);">年: <span id="chgYear">--</span></div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px; font-size: 0.85rem; color: var(--text-sub); align-items: center;">
            <div>開: <span id="infoOpen" style="color: var(--text-main);">--</span></div>
            <div>高: <span id="infoHigh" style="color: var(--text-main);">--</span></div>
            <div>低: <span id="infoLow" style="color: var(--text-main);">--</span></div>
            <div>收: <span id="infoClose" style="color: var(--text-main);">--</span></div>
            <div>量: <span id="infoVol" style="color: var(--text-main);">--</span></div>
            <div style="grid-column: span 2;">52週範圍: <span id="info52Range" style="color: var(--text-main);">--</span></div>
        </div>
    </div>
</div>



    <div class="grid-container" id="mainLayout" style="margin-bottom: 40px;">
        <div class="report-card">
            <div class="total-score-box">
                <div style="color:var(--text-sub); font-size:0.9rem; letter-spacing:1px; text-transform:uppercase;">Alpha Strategy Score</div>
                <div class="score-display" id="finalScore">--</div>
                <div class="verdict" id="finalVerdict">--</div>
            </div>

            <div id="metricsContainer"></div>
        </div>

        <div class="charts-area">
            <div class="chart-box" id="chartMainBox"><canvas id="cMain"></canvas></div>
            <div class="chart-box sub-chart"><canvas id="cKD"></canvas></div>
            <div class="chart-box sub-chart"><canvas id="cRSI"></canvas></div>
            <div class="chart-box sub-chart"><canvas id="cMACD"></canvas></div>
            <div class="chart-box sub-chart"><canvas id="cVolat"></canvas></div>

        </div>
    </div>

    <div class="macro-container" id="macroPanel" style="display:none; grid-template-columns: 1fr; gap: 30px; margin-top:50px; border-top:1px solid #334155; padding-top:30px;">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
            <div class="matrix-box">
                <div class="matrix-header">
                    <span>宏觀多空矩陣 (Macro Matrix)</span>
                    <span style="font-size:0.8rem; opacity:0.8">Data Source: SPY & VIX</span>
                </div>
                <table class="matrix-table">
                    <thead><tr><th width="35%">量化檢測因子 (Factors)</th><th width="20%">目前數值</th><th width="30%">模型判定</th><th width="15%">權重修正</th></tr></thead>
                    <tbody id="macroTableBody"></tbody>
                </table>
            </div>

            <div class="macro-summary">
                <div class="impact-box">
                    <div style="font-size:1rem; color:var(--accent-blue); font-weight:bold;">總體經濟風險係數 (Macro Risk Alpha)</div>
                    <div class="impact-score" id="impactVal">0</div>
                    <div style="font-size:0.85rem; opacity:0.8">此係數代表系統性風險對個股期望值的修正幅度</div>
                </div>
                <div class="formula-box" style="flex-grow:1; display:flex; flex-direction:column;">
                    <div style="font-weight:bold; margin-bottom:10px; color:#cbd5e1; border-bottom:1px solid #475569; padding-bottom:5px;">📝 量化模型評分機制詳解 (Quantitative Scoring Methodology)：</div>
                    <div class="formula-text" style="font-size:0.85rem; line-height:1.7; color:#94a3b8; overflow-y:auto; max-height:300px;">
                        <p style="margin:0 0 8px 0;">本系統採用<b>多因子量化模型 (Multi-Factor Model)</b>，針對市場趨勢、波動率與動能進行加權評估。基準分為 0 分，正值代表順風（Tailwind），負值代表逆風（Headwind）。</p>
                        
<strong style="color:#e2e8f0;">1. 趨勢因子 (Multi-Timeframe Trend Factor)：</strong>
<ul style="margin:5px 0 10px 0; padding-left:20px;">
    <li><b>長線趨勢 (Weight 15%)：</b>檢測 60MA 與 200MA 關係。黃金交叉且價格在年線上為強勢 (+15)；跌破年線視為長線走空，給予 <b>-15分</b> 懲罰。</li>
    <li><b>中長線趨勢 (Weight 10%)：</b>檢測 20MA 與 60MA 關係。多頭排列（20>60）代表中期動能向上 (+10)；反之若 20MA 跌破 60MA 則扣 <b>-10分</b>。</li>
    <li><b>短線趨勢 (Weight 5%)：</b>檢測 5MA 與 20MA 關係。5MA 在 20MA 之上為短線噴發 (+5)；若跌破則視為短線回檔 <b>-5分</b>。</li>
</ul>


                        <strong style="color:#e2e8f0;">2. 波動率風險因子 (Volatility Risk Factor)：</strong>
                        <ul style="margin:5px 0 10px 0; padding-left:20px;">
                            <li><b>VIX 絕對水位 (Absolute Level)：</b>採用級距式扣分模型。VIX>20 開始扣分，>30 視為高度恐慌 (-8分)，>35 視為崩盤前兆 (-12分)。</li>
                            <li><b>布林通道壓力測試 (Bollinger Stress Test)：</b>當 VIX 突破布林上軌 (Upper Band)，代表發生 2個標準差 (2σ) 以上的極端恐慌事件，觸發 <b>-15分</b> 的熔斷機制。</li>
                            <li><b>歷史波動率異常 (HV Z-Score)：</b>計算過去 200日波動率的標準分數。若 Z-Score > 2.5，代表市場處於統計學上的極端不穩定狀態。</li>
                        </ul>

                        <strong style="color:#e2e8f0;">3. 動能因子 (Momentum Factor)：</strong>
                        <ul style="margin:5px 0 0 0; padding-left:20px;">
                            <li><b>恐慌動能 (VIX Momentum)：</b>透過 VIX 5日線與 20日線的交叉關係，判斷恐慌情緒是在「加速升溫」還是「降溫冷卻」。</li>
                            <li><b>短線乖離 (Short-term BIAS)：</b>檢測 SPY 與月線的乖離，過大則視為過熱 (0分)，適中則視為強勢 (+3分)。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
            <div class="chart-box" style="min-height:400px !important; padding:0; overflow:hidden; border-radius:12px; border:1px solid #334155;">
                <div id="tv_chart_spy" style="height:100%; width:100%;"></div>
            </div>
            <div class="chart-box" style="min-height:400px !important; padding:0; overflow:hidden; border-radius:12px; border:1px solid #334155;">
                <div id="tv_chart_vix" style="height:100%; width:100%;"></div>
            </div>
        </div>
    </div>


<div id="riskManagementPanel" style="width: 100%; margin-bottom: 20px; display: none;">
    <div style="background: var(--bg-panel); border: 1px solid #334155; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding-bottom: 12px; margin-bottom: 15px;">
            <div style="font-size: 1.1rem; font-weight: bold; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                Volatility-Adjusted Risk Model <span style="font-size: 0.8rem; color: var(--text-sub); font-weight: normal;">(for reference)</span>
            </div>
            <button onclick="showRiskFormula()" style="cursor: pointer; font-size: 0.85rem; background: rgba(59, 130, 246, 0.1); color: var(--accent-blue); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(59, 130, 246, 0.3); transition: all 0.2s hover:background:rgba(59,130,246,0.2);">
                模型計算說明
            </button>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px;">
            <div class="risk-item">
                <div style="color: var(--text-sub); font-size: 0.75rem; margin-bottom: 4px;">20日平均波幅 (ATR)</div>
                <div id="rkATR" style="font-size: 1.25rem; font-weight: bold; color: var(--text-main);">--</div>
            </div>
            <div class="risk-item">
                <div style="color: var(--text-sub); font-size: 0.75rem; margin-bottom: 4px;">初始停損位 (Initial SL)</div>
                <div id="rkInitialSL" style="font-size: 1.25rem; font-weight: bold; color: var(--accent-red);">--</div>
            </div>
            <div class="risk-item">
                <div style="color: var(--text-sub); font-size: 0.75rem; margin-bottom: 4px;">移動止盈位 (Trailing)</div>
                <div id="rkTrailingStop" style="font-size: 1.25rem; font-weight: bold; color: var(--accent-yellow);">--</div>
            </div>
            <div class="risk-item">
                <div style="color: var(--text-sub); font-size: 0.75rem; margin-bottom: 4px;">獲利目標 (TP1 / TP2)</div>
                <div id="rkTPGoal" style="font-size: 1.15rem; font-weight: bold; color: var(--accent-green);">--</div>
            </div>
            <div class="risk-item">
                <div style="color: var(--text-sub); font-size: 0.75rem; margin-bottom: 4px;">單日 VaR 風險 (95%)</div>
                <div id="rkVaR" style="font-size: 1.25rem; font-weight: bold; color: var(--accent-red);">--</div>
            </div>
            <div class="risk-item">
                <div style="color: var(--text-sub); font-size: 0.75rem; margin-bottom: 4px;">建議倉位 ($100風險)</div>
                <div id="rkPosition" style="font-size: 1.15rem; font-weight: bold; color: var(--text-main);">--</div>
            </div>
        </div>
        
        <div id="riskWarning" style="margin-top: 20px; padding: 12px; background: rgba(30, 41, 59, 0.5); border-radius: 8px; font-size: 0.85rem; color: var(--text-sub); line-height: 1.6; border: 1px dashed #475569;">
            -- 待系統分析完成後顯示即時風險建議 --
        </div>
    </div>
</div>

<div id="rkDataStore" style="display:none;"></div>



</div>


<script>
    // 數學運算
    const calcAvg = (d, n) => { let r=[]; for(let i=0;i<d.length;i++){ if(i<n-1){r.push(null);continue;} let s=0; for(let j=0;j<n;j++)s+=d[i-j]; r.push(s/n); } return r; };
    const calcEMA = (d, n) => { let k=2/(n+1), r=new Array(d.length).fill(null), s=0; for(let i=0;i<n;i++)s+=d[i]; r[n-1]=s/n; for(let i=n;i<d.length;i++)r[i]=d[i]*k+r[i-1]*(1-k); return r; };
    const calcBollinger = (d, n=20) => { const sma=calcAvg(d, n), u=[], l=[]; for(let i=0;i<d.length;i++){ if(!sma[i]){u.push(null);l.push(null);continue;} let ss=0; for(let j=0;j<n;j++)ss+=Math.pow(d[i-j]-sma[i],2); let std=Math.sqrt(ss/n); u.push(sma[i]+std*2); l.push(sma[i]-std*2); } return {upper:u, lower:l}; };
    const calcRSI = (d, n=14) => { let r=new Array(d.length).fill(null), g=[], l=[]; for(let i=1;i<d.length;i++){ let df=d[i]-d[i-1]; g.push(df>0?df:0); l.push(df<0?Math.abs(df):0); } for(let i=n;i<d.length;i++){ let ag=g.slice(i-n,i).reduce((a,b)=>a+b)/n, al=l.slice(i-n,i).reduce((a,b)=>a+b)/n; r[i]=al===0?100:100-(100/(1+ag/al)); } return r; };
    const calcMACD = (d) => { const e12=calcEMA(d,12), e26=calcEMA(d,26), dif=d.map((v,i)=>(e12[i]&&e26[i])?e12[i]-e26[i]:null); let vd=dif.filter(x=>x!==null), vs=calcEMA(vd,9), sig=new Array(dif.length-vs.length).fill(null).concat(vs), h=dif.map((v,i)=>(v!==null&&sig[i]!==null)?v-sig[i]:null); return {dif,sig,hist:h}; };
    const calcKD = (c, h, l, n=9) => { let K=[], D=[], k=50, d=50; for(let i=0;i<c.length;i++){ if(i<n-1){K.push(null);D.push(null);continue;} let mx=-Infinity, mn=Infinity; for(let j=0;j<n;j++){ mx=Math.max(mx,h[i-j]); mn=Math.min(mn,l[i-j]); } let rsv=mx===mn?50:((c[i]-mn)/(mx-mn))*100; k=(2/3)*k+(1/3)*rsv; d=(2/3)*d+(1/3)*k; K.push(k); D.push(d); } return {K,D}; };
    const calcATR = (h, l, c, n=14) => { let tr=[h[0]-l[0]]; for(let i=1;i<h.length;i++) tr.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1]))); let atr=new Array(h.length).fill(null), s=0; for(let i=0;i<n;i++)s+=tr[i]; atr[n-1]=s/n; for(let i=n;i<h.length;i++)atr[i]=(atr[i-1]*(n-1)+tr[i])/n; return atr; };
    const calcFib = (h, l) => { const mx=Math.max(...h), mn=Math.min(...l), d=mx-mn; return {f618:mx-d*0.618, f500:mx-d*0.5, f382:mx-d*0.382}; };

    let charts = {};
    let countdown = 0;

     async function getYahooVIX() {
        // Yahoo API 目標網址
        const targetUrl = "https://query1.finance.yahoo.com/v8/finance/chart/%5EVIX?interval=1d&range=1y";
        
        // 定義兩個不同的 CORS Proxy 服務作為備援
        const proxies = [
            // 代理 1: corsproxy.io (速度快，但偶爾會擋)
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            // 代理 2: allorigins.win (速度稍慢，但穩定性高)
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
        ];

        // 內部解析函數 (統一處理 Yahoo 的 JSON 格式)
        const parseYahooData = (data) => {
            if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                throw new Error("Yahoo API 回傳格式錯誤");
            }
            const result = data.chart.result[0];
            const timestamps = result.timestamp;
            const quotes = result.indicators.quote[0].close;
            
            if (!timestamps || !quotes) throw new Error("無 VIX 數據");

            let formattedData = [];
            for (let i = 0; i < timestamps.length; i++) {
                if (quotes[i] != null) {
                    let date = new Date(timestamps[i] * 1000);
                    // 修正時區問題，確保日期準確
                    let dateStr = date.toISOString().split('T')[0];
                    formattedData.push({
                        datetime: dateStr,
                        close: quotes[i]
                    });
                }
            }
            return { values: formattedData.reverse() }; // 轉為由新到舊
        };

        // ★ 自動切換代理機制
        for (let i = 0; i < proxies.length; i++) {
            try {
                const proxyUrl = proxies[i](targetUrl);
                console.log(`嘗試抓取 VIX (代理 ${i+1})...`);
                
                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                
                const data = await res.json();
                const parsed = parseYahooData(data);
                
                console.log("VIX 抓取成功！");
                return parsed; // 成功就回傳，跳出迴圈

            } catch (e) {
                console.warn(`代理 ${i+1} 失敗:`, e.message);
                // 如果是最後一個代理也失敗，才拋出錯誤
                if (i === proxies.length - 1) {
                    throw new Error("所有 VIX 來源皆無法連線，請稍後再試。");
                }
                // 否則繼續嘗試下一個代理
            }
        }
    }



async function startSystem() {
    const apiKey = document.getElementById('inpApiKey').value.trim();
    const symbol = document.getElementById('inpSymbol').value.toUpperCase();
    let years = parseFloat(document.getElementById('inpYears').value) || 1;
    if(years > 5) years = 5;
    const fetchYears = years + 1;
    const size = Math.ceil(fetchYears * 260);
 
    const btn = document.getElementById('btnStart');
    const loader = document.getElementById('loadingMsg');
   
    btn.disabled = true;
    loader.style.display = 'inline';
    document.getElementById('mainLayout').style.opacity = '0.3';
    document.getElementById('macroPanel').style.display = 'none';
   
    if(document.getElementById('riskManagementPanel')) document.getElementById('riskManagementPanel').style.display = 'none';
    if(document.getElementById('stockInfoPanel')) document.getElementById('stockInfoPanel').style.display = 'none';
 
    try {
        const pStock = fetch(`https://api.twelvedata.com/time_series?symbol=${symbol}&interval=1day&outputsize=${size}&apikey=${apiKey}`).then(r=>r.json());
        const pSpy = fetch(`https://api.twelvedata.com/time_series?symbol=SPY&interval=1day&outputsize=400&apikey=${apiKey}`).then(r=>r.json());
      
        let vixData = null;
        try { vixData = await getYahooVIX(); } catch (vixErr) { console.warn("VIX 失敗，使用備援模式"); }
 
        const [stockData, spyData] = await Promise.all([pStock, pSpy]);
        if(stockData.status === 'error') throw new Error("API 錯誤: " + stockData.message);
 
        const raw = stockData.values.reverse();
        const C = raw.map(x=>parseFloat(x.close)), H = raw.map(x=>parseFloat(x.high)), L = raw.map(x=>parseFloat(x.low)), V = raw.map(x=>parseFloat(x.volume)), T = raw.map(x=>x.datetime);
        const idx = C.length - 1;
        const curPrice = C[idx];
 
        // --- 1. 計算股票基本資料與漲跌幅 ---
        const getChg = (pastIdx) => pastIdx >= 0 ? ((curPrice - C[pastIdx]) / C[pastIdx] * 100).toFixed(2) : "N/A";
        const fmtChg = (id, val) => {
            const el = document.getElementById(id);
            if(!el) return;
            const num = parseFloat(val);
            if(isNaN(num)) { el.innerText = "--"; return; }
            el.innerText = (num > 0 ? "+" : "") + val + "%";
            el.style.color = num >= 0 ? "var(--accent-green)" : "var(--accent-red)";
        };
 
        if(document.getElementById('stockInfoPanel')) {
            // 更新主價格
            document.getElementById('infoPrice').innerText = `$ ${curPrice.toFixed(2)}`;
            
            // 更新日期 (最新資料日期)
            const dObj = new Date(T[idx]);
            const dStr = (dObj.getMonth() + 1) + "月" + dObj.getDate() + "日";
            document.getElementById('infoDateMain').innerText = dStr;

            // 報酬率更新
            fmtChg('chgDay', getChg(idx - 1));
            fmtChg('chgWeek', getChg(idx - 5));
            fmtChg('chgMonth', getChg(idx - 21));
            fmtChg('chgQuarter', getChg(idx - 63));
            fmtChg('chgYear', getChg(idx - 252));
 
            // 詳細數據
            document.getElementById('infoOpen').innerText = raw[idx].open;
            document.getElementById('infoHigh').innerText = raw[idx].high;
            document.getElementById('infoLow').innerText = raw[idx].low;
            document.getElementById('infoClose').innerText = raw[idx].close;
            document.getElementById('infoVol').innerText = (V[idx] / 1000000).toFixed(2) + "M";
 
            const lastYearH = Math.max(...H.slice(Math.max(0, idx - 252)));
            const lastYearL = Math.min(...L.slice(Math.max(0, idx - 252)));
            document.getElementById('info52Range').innerText = `${lastYearL.toFixed(2)} - ${lastYearH.toFixed(2)}`;
            document.getElementById('stockInfoPanel').style.display = 'block';
        }
 
        // --- 2. 指標計算 ---
        const sma5=calcAvg(C,5), sma20=calcAvg(C,20), sma60=calcAvg(C,60), sma200=calcAvg(C,200);
        const bb=calcBollinger(C,20), rsi=calcRSI(C,14), macd=calcMACD(C), kd=calcKD(C,H,L,9), atr=calcATR(H,L,C,14), fib=calcFib(H,L);
 
        // --- 3. 計算年歷史波動度 (HV) ---
        const hvSeries = new Array(C.length).fill(0);
        const hvWindow = 252;
        for (let i = hvWindow; i < C.length; i++) {
            let returns = [];
            for (let j = i - hvWindow + 1; j <= i; j++) { returns.push(Math.log(C[j] / C[j - 1])); }
            let mean = returns.reduce((a, b) => a + b, 0) / returns.length;
            let variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (returns.length - 1);
            hvSeries[i] = Math.sqrt(variance * 252) * 100;
        }
 
        const macroAnalysis = analyzeMacroConditions(spyData, vixData || { current: 20, history: [] });
        updateMacroUI(macroAnalysis);
        document.getElementById('macroPanel').style.display = 'grid';
        loadTradingViewWidgets();
 
        // --- 4. 多因子評分系統 ---
        let scores = {};
        let sL = 50; if(sma200[idx]) sL = 50 + (((curPrice-sma200[idx])/sma200[idx])*60) + (((sma60[idx]-sma200[idx])/sma200[idx])*90);
        scores.trendLong = clamp(Math.round(sL));
        let sM = 50; if(sma60[idx]) sM = 50 + (((curPrice-sma60[idx])/sma60[idx])*100) + (((sma20[idx]-sma60[idx])/sma60[idx])*150);
        scores.trendMid = clamp(Math.round(sM));
        let sS = 50; if(sma20[idx]) sS = 50 + (((curPrice-sma20[idx])/sma20[idx])*150) + (((sma5[idx]-sma20[idx])/sma20[idx])*250);
        scores.trendShort = clamp(Math.round(sS));
 
        let pb=(curPrice-bb.lower[idx])/(bb.upper[idx]-bb.lower[idx]); scores.pos=clamp(pb<0?100:(pb>1?0:100-(pb*100)));
        let vS=50, vR=V[idx]/calcAvg(V,20)[idx]; if(C[idx]>C[idx-1])vS+=(vR>1?(vR-1)*20:-(1-vR)*20); else vS+=(vR>1?-(vR-1)*20:(1-vR)*10); scores.vol=clamp(vS);
        let rV=rsi[idx], rS=rV<30?80+(30-rV):(rV>70?20-(rV-70):50+(50-rV)); scores.rsi=clamp(rS);
        let kV=kd.K[idx], dV=kd.D[idx], kS=kV<20?80+(20-kV):(kV>80?20-(kV-80):50+(50-kV)); if(kV>dV && kd.K[idx-1]<=kd.D[idx-1])kS+=15; if(kV<dV && kd.K[idx-1]>=kd.D[idx-1])kS-=15; scores.kd=clamp(kS);
        let mH=macd.hist[idx], pH=macd.hist[idx-1], mS=mH>0?(mH>pH?70:55):(mH>pH?50:30); scores.macd=clamp(mS);
 
        const curHV = hvSeries[idx], hvHistory = hvSeries.slice(Math.max(0, idx - 252), idx + 1).filter(v => v > 0);
        const hvMean = hvHistory.reduce((a, b) => a + b, 0) / hvHistory.length;
        const hvSD = Math.sqrt(hvHistory.reduce((a, b) => a + Math.pow(b - hvMean, 2), 0) / hvHistory.length);
        let sHV = 60; if (hvSD > 0) {
            const z = (curHV - hvMean) / hvSD;
            if (z >= 0) sHV = 60 - (Math.min(z, 1)*15) - (Math.max(0,Math.min(z-1,1))*10) - (Math.max(0,z-2)*10);
            else { const az = Math.abs(z); sHV = 60 + (Math.min(az, 1)*15) + (Math.max(0,Math.min(az-1,1))*10) + (Math.max(0,az-2)*10); }
        }
        scores.hv = clamp(Math.round(sHV));
 
        let rawTotal = (scores.trendLong*0.13) + (scores.trendMid*0.09) + (scores.trendShort*0.05) + (scores.pos*0.20) + (scores.vol*0.15) + (scores.rsi*0.08) + (scores.kd*0.08) + (scores.macd*0.08) + (scores.hv*0.14);
        let finalScore = clamp(Math.round(rawTotal + macroAnalysis.totalImpact));
        document.getElementById('finalScore').innerText = finalScore;
 
        const elVerdict = document.getElementById('finalVerdict');
        if(finalScore>=80) { elVerdict.innerText="🔥 強力買進"; elVerdict.style.color="#10b981"; }
        else if(finalScore>=70) { elVerdict.innerText="✅ 偏多操作"; elVerdict.style.color="#3b82f6"; }
        else if(finalScore>=60) { elVerdict.innerText="👀 觀望盤整"; elVerdict.style.color="#f59e0b"; }
        else { elVerdict.innerText="⛔ 偏空操作"; elVerdict.style.color="#ef4444"; }
 
        // --- 5. 風控 UI 更新 ---
        const cATR = atr[idx], isBullish = finalScore >= 60;
        const initialSL = isBullish ? (curPrice - 2.5 * cATR) : (curPrice + 2.5 * cATR);
        const trailingStop = isBullish ? (curPrice - 1.5 * cATR) : (curPrice + 1.5 * cATR);
        const riskAmount = Math.abs(curPrice - initialSL);
        const tp1 = isBullish ? (curPrice + 2.0 * riskAmount) : (curPrice - 2.0 * riskAmount);
        const tp2 = isBullish ? (curPrice + 4.0 * riskAmount) : (curPrice - 4.0 * riskAmount);
        const rrRatio = (Math.abs(tp1 - curPrice) / riskAmount).toFixed(2);
        const dailyVaR = (curPrice * (curHV / 100) * 1.65 / Math.sqrt(252)).toFixed(2);
 
        const rkPanel = document.getElementById('riskManagementPanel');
        if(rkPanel) {
            document.getElementById('rkATR').innerText = cATR.toFixed(2);
            document.getElementById('rkInitialSL').innerText = initialSL.toFixed(2);
            document.getElementById('rkTrailingStop').innerText = trailingStop.toFixed(2);
            document.getElementById('rkTPGoal').innerText = `${tp1.toFixed(2)} / ${tp2.toFixed(2)}`;
            document.getElementById('rkVaR').innerText = `$ ${dailyVaR}`;
            document.getElementById('rkPosition').innerText = `${Math.floor(100 / riskAmount)} 股`;


            // 彈窗詳解內容
            window.currentRiskDetail = `
                <li style="margin-bottom:10px;"><b>● 預期盈虧比 (R/R Ratio)：</b> <span style="color:var(--accent-blue); font-weight:bold;">1 : ${rrRatio}</span><br>
                基於第一止盈目標(TP1)與初始停損距離之比值。高於 1.5 代表具備優質獲利潛力。</li>
                <li style="margin-bottom:10px;"><b>● 20日平均波幅 (ATR)：</b> 衡量個股每日真實波動範圍。計算包含跳空缺口，能更精準反映當前市場的隨機噪音水平。</li>
                <li style="margin-bottom:10px;"><b>● 初始停損 (Initial SL)：</b> 採用 <span style="color:var(--accent-red)">2.5×ATR</span> 模型。該位階旨在給予股價足夠的「呼吸空間」，避開 95% 以上的隨機噪音波動。</li>
                <li style="margin-bottom:10px;"><b>● 移動止盈 (Trailing)：</b> 採用 <span style="color:var(--accent-yellow)">1.5×ATR</span> 追蹤。隨價格有利波動而上移，用於鎖定利潤並平衡回撤。</li>
                <li style="margin-bottom:10px;"><b>● 年化 VaR (95% 置信度)：</b> 估計極端情況下的單日潛在跌幅。公式：Price × (HV/100) × 1.65 / √252。</li>
                <li style="margin-bottom:10px;"><b>● 倉位建議：</b> 採用固定風險百分比模型。確保單筆失敗的損失嚴格控制在總資產的預期百分比內。</li>
            `;
            // 風險警告
            const elWarning = document.getElementById('riskWarning');
            const hvZScore = (curHV - hvMean) / hvSD;
            if (hvZScore > 1.5) {
                elWarning.innerText = "⚠️ 極高波動警告：當前個股歷史波動率異常升高，建議將停損距離拉寬至 3.5×ATR 並將倉位減半，提防非理性洗盤。";
                elWarning.style.background = "rgba(239, 68, 68, 0.2)";
                elWarning.style.color = "#fca5a5";
            } else if (hvZScore < -1.0) {
                elWarning.innerText = "ℹ️ 波動壓縮提醒：個股波動處於歷史低位，可能正待突破，可採用較窄的停損(2.0×ATR)以提高勝率。";
                elWarning.style.background = "rgba(16, 185, 129, 0.1)";
                elWarning.style.color = "#a7f3d0";
            } else {
                elWarning.innerText = "✅ 波動正常：個股當前波動符合歷史平均，建議遵循標準 ATR 風險模型。";
                elWarning.style.background = "rgba(30, 41, 59, 0.5)";
                elWarning.style.color = "var(--text-sub)";
            }
            rkPanel.style.display = 'block';
        }

         updateMetricsUI(scores, { price: curPrice, prevPrice: C[idx-1], ma5: sma5[idx], ma20: sma20[idx], ma60: sma60[idx], ma200: sma200[idx], volR: vR, rsiV: rV, kdV: {k:kd.K[idx], d:kd.D[idx]}, macdH: macd.hist[idx], hv: curHV, hvMean: hvMean, hvSD: hvSD });
      
        const showCount = Math.ceil(years * 260);
        const sliceStart = C.length - showCount;
        drawCharts(T.slice(sliceStart), C.slice(sliceStart), V.slice(sliceStart), sma5.slice(sliceStart), sma20.slice(sliceStart), sma60.slice(sliceStart), sma200.slice(sliceStart), {upper:bb.upper.slice(sliceStart), lower:bb.lower.slice(sliceStart)}, rsi.slice(sliceStart), {dif:macd.dif.slice(sliceStart), sig:macd.sig.slice(sliceStart), hist:macd.hist.slice(sliceStart)}, {K:kd.K.slice(sliceStart), D:kd.D.slice(sliceStart)}, fib, hvSeries.slice(sliceStart), hvMean, hvSD);
      
        document.getElementById('mainLayout').style.opacity = '1';
        startCooldown(15);
    } catch (e) { alert("系統錯誤: " + e.message); console.error(e); btn.disabled = false; }
    finally { loader.style.display = 'none'; } }



    function loadTradingViewWidgets() {
        // 1. SPY Widget (大盤走勢)
        new TradingView.widget({
            "width": "100%", "height": "100%",
            "symbol": "AMEX:SPY", // 明確指定交易所
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1", // 蠟燭圖
            "locale": "zh_TW",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_top_toolbar": false,
            "allow_symbol_change": false,
            "container_id": "tv_chart_spy",
            "studies": [
                "MASimple@tv-basicstudies", 
                "MASimple@tv-basicstudies"  
            ] 
        });

        new TradingView.widget({
            "width": "100%", "height": "100%",
            "symbol": "VIXY", 
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "2", // 線圖
            "locale": "zh_TW",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_top_toolbar": false,
            "allow_symbol_change": false,
            "container_id": "tv_chart_vix",
            "studies": ["BollingerBands@tv-basicstudies"] 
        });
    }





     function drawMacroCharts(spyData, vixData) {
        const process = (d, name) => {
            if(!d || !d.values || d.values.length === 0) {
                console.warn(`${name} 無數據可繪圖`);
                return null; }
            const raw = [...d.values].reverse();
           
            const slice = raw.slice(-120);
            
            return {
                L: slice.map(x => x.datetime.substring(5)),
                C: slice.map(x => parseFloat(x.close)),
                Raw: slice.map(x => parseFloat(x.close))};};

        const spy = process(spyData, "SPY");
        const vix = process(vixData, "VIX");

        if(!spy || !vix) return; 

        const spyMA50 = calcAvg(spy.Raw, 50);
        const spyMA200 = calcAvg(spy.Raw, 200);
        const vixMA5 = calcAvg(vix.Raw, 5); 
        const vixMA20 = calcAvg(vix.Raw, 20);

        const opts = (title) => ({
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                title: { display: true, text: title, color: '#94a3b8', font:{size:12} },
                legend: { labels: { color: '#cbd5e1', boxWidth:10, font:{size:10} } } 
            },
            scales: { x: { display: false }, y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', font:{size:10} } } },
            elements: { point: { radius: 0, hoverRadius: 4 } }
        });

        // 繪製 SPY
        if(charts.spy) charts.spy.destroy();
        charts.spy = new Chart(document.getElementById('cSPY'), {
            type: 'line',
            data: {
                labels: spy.L,
                datasets: [
                    { label: 'SPY', data: spy.C, borderColor: '#fff', borderWidth: 2 },
                    { label: 'MA50', data: spyMA50, borderColor: '#3b82f6', borderWidth: 1 },
                    { label: 'MA200', data: spyMA200, borderColor: '#f59e0b', borderWidth: 1 }
                ]
            }, options: opts('SPY Trend (200MA / 50MA)')
        });

        // 繪製 VIX
        if(charts.vix) charts.vix.destroy();
        charts.vix = new Chart(document.getElementById('cVIX'), {
            type: 'line',
            data: {
                labels: vix.L,
                datasets: [
                    { label: 'VIX', data: vix.C, borderColor: '#ef4444', borderWidth: 2 },
                    { label: '5MA(動能)', data: vixMA5, borderColor: '#22d3ee', borderWidth: 1, borderDash:[2,2] },
                    { label: '20MA(趨勢)', data: vixMA20, borderColor: '#facc15', borderWidth: 1 }
                ]
            }, options: opts('VIX Momentum (5MA / 20MA)')});}


    function showFormula(type) {
        const modal = document.getElementById('scoreModal');
        const title = document.getElementById('mTitle');
        const weight = document.getElementById('mWeight');
        const list = document.getElementById('mFormula');
        
        list.innerHTML = '';
        modal.style.display = 'flex';

        if(type === 'TrendLong') {
            title.innerText = "長線趨勢 (Trend Long)";
            weight.innerText = "權重: 13%";
            list.innerHTML = `
                <li><b>保守線性公式：</b>Score = 50 + (價格乖離率 × 60) + (均線乖離率 × 90)</li>
                <li><b>價格乖離：</b>計算 股價 對比 200MA (年線) 的偏離百分比。</li>
                <li><b>結構乖離：</b>計算 60MA (季線) 對比 200MA 的偏離百分比。</li>
                <li><b>評分特性：</b>需股價偏離年線約 ±35% 才會觸及極端 0/100 分，提供極其細膩的長線強弱變化。</li>
            `;
        } else if(type === 'TrendMid') {
            title.innerText = "中長線趨勢 (Trend Mid)";
            weight.innerText = "權重: 9%";
            list.innerHTML = `
                <li><b>中性線性公式：</b>Score = 50 + (價格乖離率 × 100) + (均線乖離率 × 150)</li>
                <li><b>價格乖離：</b>計算 股價 對比 60MA (季線) 的偏離百分比。</li>
                <li><b>結構乖離：</b>計算 20MA (月線) 對比 60MA 的偏離百分比。</li>
                <li><b>評分特性：</b>需中期乖離達約 ±25% 才會觸及極端分，精準捕捉中期波段的動能增減。</li>
            `;
        } else if(type === 'TrendShort') {
            title.innerText = "短線趨勢 (Trend Short)";
            weight.innerText = "權重: 5%";
            list.innerHTML = `
                <li><b>敏銳線性公式：</b>Score = 50 + (價格乖離率 × 150) + (均線乖離率 × 250)</li>
                <li><b>價格乖離：</b>計算 股價 對比 20MA (月線) 的偏離百分比。</li>
                <li><b>結構乖離：</b>計算 5MA (週線) 對比 20MA 的偏離百分比。</li>
                <li><b>評分特性：</b>反映短線熱度，需乖離達約 ±15% 才會觸及極值，避免頻繁出現 0/100 分。</li>
            `;

        } else if(type === 'Pos') {
            title.innerText = "價格位階 (Position)";
            weight.innerText = "權重: 20%";
            list.innerHTML = `
                <li><b>公式：</b>使用布林通道 %B 指標</li>
                <li><b>便宜：</b>接近通道下緣分數高 (破底給 100分)</li>
                <li><b>昂貴：</b>接近通道上緣分數低 (突破給 0分)</li>
                <li><b>線性計算：</b>Score = 100 - (%B × 100)</li>
            `;
        } else if(type === 'Vol') {
            title.innerText = "量價分析 (Volume)";
            weight.innerText = "權重: 15%";
            list.innerHTML = `
                <li><b>基礎分 (50分)</b></li>
                <li><b>價漲量增：</b>成交量 > 均量，大幅加分 (+20分)</li>
                <li><b>價漲量縮：</b>量價背離，扣分 (-20分)</li>
                <li><b>價跌量縮：</b>惜售整理，小加分 (+10分)</li>
                <li><b>價跌量增：</b>恐慌拋售，重扣分 (-20分)</li>
            `;
        } else if(type === 'RSI') {
            title.innerText = "RSI 動能";
            weight.innerText = "權重: 8%";
            list.innerHTML = `
                <li><b>超賣區 (<30)：</b>視為反彈機會，分數提高 (最高 80+30=110)</li>
                <li><b>超買區 (>70)：</b>視為過熱風險，分數降低 (最低 20-30=-10)</li>
                <li><b>中性區 (30-70)：</b>線性遞減，越低分越高</li>
            `;
        } else if(type === 'KD') {
            title.innerText = "KD 指標";
            weight.innerText = "權重: 8%";
            list.innerHTML = `
                <li><b>基礎分：</b>類似 RSI，低檔鈍化給高分，高檔鈍化給低分</li>
                <li><b>黃金交叉：</b>K > D 且昨日 K < D (+15分)</li>
                <li><b>死亡交叉：</b>K < D 且昨日 K > D (-15分)</li>
            `;
        } else if(type === 'MACD') {
            title.innerText = "MACD 趨勢";
            weight.innerText = "權重: 8%";
            list.innerHTML = `
                <li><b>多頭增強：</b>紅柱且變長 (70分)</li>
                <li><b>多頭減弱：</b>紅柱但變短 (55分)</li>
                <li><b>空頭收斂：</b>綠柱但變短 (50分)</li>
                <li><b>空頭增強：</b>綠柱且變長 (30分)</li>
            `;
        } else if(type === 'HV') {
            title.innerText = "歷史波動度 (Annual HV)";
            weight.innerText = "權重: 14%";
            list.innerHTML = `
                <li><b>基準分 (60分)：</b>當前年化波動度等於過去一年平均值時。</li>
                <li><b>波動風險：</b>波動增加則扣分，波動減少則加分（穩定度越高分數越高）。</li>
                <li><b>精確級距：</b>
                    <ul>
                        <li>±1 標準差：調整 15 分</li>
                        <li>±2 標準差：調整 25 分</li>
                        <li>±3 標準差：調整 35 分</li>
                    </ul>
                </li>
                <li><b>目的：</b>評估價格穩定度，過高的波動通常與趨勢末端或恐慌性殺盤相關。</li>
            `;

        }
    }

    function closeModal(e) { if(e.target.id === 'scoreModal') e.target.style.display = 'none'; }

     function updateMetricsUI(s, d) {
        // 安全格式化數字
        const fmt = (v) => (v !== undefined && v !== null) ? v.toFixed(2) : "N/A";
        const fmtM = (v) => (v !== undefined && v !== null) ? v.toFixed(4) : "N/A";

        // 1. 長期趨勢深度解析 (15%)
        const trendDist = (d.price && d.ma200) ? ((d.price - d.ma200) / d.ma200 * 100).toFixed(2) : "0.00";
        let trendLongText = "";
        if(s.trendLong >= 65) {
            trendLongText = `目前股價穩定運行於年線(200MA)之上 ${trendDist}%。由於本模型採保守評分，高分代表長線趨勢極度穩固且季線(60MA)已展現強大助漲力。這顯示長線資金籌碼已進入鎖碼階段，長線保護短線效果極佳，適合波段持有。`;
        } else if(s.trendLong >= 40) {
            trendLongText = `股價與年線處於低乖離狀態，呈現「糾結築底」或「高位橫盤」特徵。多空力道在此交鋒，分數越接近 50 代表趨勢越中性，需等待股價帶量脫離年線區域以確認新一輪長線方向。`;
        } else {
            trendLongText = `股價目前處於年線之下 ${Math.abs(trendDist)}%。保守公式下出現低分代表長期下行趨勢沈重，均線呈現標準空頭排列。上方各均線反壓明顯，任何技術性反彈皆應視為解套賣壓區，建議操作維持高度保守。`;
        }

        // 2. 中長線趨勢深度解析 (10%)
        let trendMidText = "";
        if(s.trendMid >= 65) {
            trendMidText = `月線(20MA)與季線(60MA)結構良好，乖離穩定擴張，代表中期動能正處於爆發成長期。此分數反映了主力資金在中期波段的持續控盤意願，季線目前提供強大剛性支撐，是波段操作者獲利最豐厚的階段。`;
        } else if(s.trendMid >= 40) {
            trendMidText = `中期動能進入沉澱期，月線與季線距離縮減，股價進行橫向換手整理。此位階代表市場對中期方向產生分歧，若分數持續往 50 靠攏，代表波段方向不明，操作宜縮小頭寸，靜待趨勢轉強。`;
        } else {
            trendMidText = `月線低於季線且乖離加大，中期趨勢呈現疲軟格局。這顯示中期籌碼鬆動，主力資金撤離明顯，季線已由支撐轉為強大壓力帶。操作上應嚴防股價持續盤跌，並以降低部位風險為首要任務。`;
        }

        // 3. 短線趨勢深度解析 (5%)
        let trendShortText = "";
        if(s.trendShort >= 65) {
            trendShortText = `5日線與月線形成強勢攻擊角，短線動能極速噴發。在保守評分下能達到此分數，顯示股價正處於極強勢的熱點行情中，市場情緒亢奮，有利於極短線價差操作，直到 5 日線轉折走平為止。`;
        } else if(s.trendShort >= 40) {
            trendShortText = `短線波動趨於收斂，5日線與月線頻繁交織，屬於典型的「震盪洗盤」格局。市場正在消化短線獲利回吐賣壓或累積上攻動能，建議減少頻繁交易以避免遭手續費磨損，等待短線方向表態。`;
        } else {
            trendShortText = `5日線跌破月線並呈下彎，短線動能大幅衰竭。這反映了市場短線獲利了結壓力沈重，股價正進行必要的回檔修正。若分數持續探底，需注意短線修正演變為中期調整的可能性。`;
        }

        // 4. 價格位階深度解析
        const pb = (100 - s.pos) / 100;
        let posText = "";
        if(pb > 1.0) posText = `布林通道 %B 值達 ${(pb*100).toFixed(0)}%，股價突破上軌。此為極強勢的「軋空行情」，但也伴隨乖離過大風險。若無量能配合，需提防假突破真拉回。`;
        else if(pb > 0.8) posText = `股價運行於中軌與上軌間的「強勢整理區」。操作宜沿 20MA 順勢操作，只要不破中軌，多頭動能延續，是勝率較高的位階。`;
        else if(pb < 0) posText = `布林通道 %B 為負，股價跌破下軌。市場出現非理性「恐慌拋售」，隨時可能出現「報復性反彈」，但需注意是否為重大利空導致的崩盤。`;
        else if(pb < 0.2) posText = `股價位於下軌附近，位階便宜但走勢疲弱。此區屬「左側交易」觀察區，需等待長紅 K 棒表態止跌，否則可能沿下軌持續盤跌。`;
        else posText = `股價位於布林通道中性區間，方向未明。建議減少進出，等待突破上軌或回測下軌有撐後再行佈局。`;

        // 5. 量價分析深度解析
        let volText = "";
        const vRatio = (d.volR || 0).toFixed(2);
        if(d.price > d.prevPrice) { 
            if(d.volR > 1.2) volText = `呈現「價漲量增」健康格局，成交量為均量 ${vRatio} 倍。主力資金積極換手，攻擊意願強，有利後續挑戰新高。`;
            else if(d.volR < 0.8) volText = `呈現「價漲量縮」背離。追價意願不足或主力鎖碼，若後續無法補量，需提防多頭力竭的拉回風險。`;
            else volText = `價漲且量能溫和，屬於穩健推升格局，籌碼未失控，有利趨勢延續。`;
        } else {
            if(d.volR > 1.2) volText = `呈現「價跌量增」，成交量放大至 ${vRatio} 倍。顯示出現恐慌性停損或獲利了結賣壓，空方力道強，底部恐難浮現。`;
            else volText = `呈現「價跌量縮」，賣壓逐漸衰竭，市場出現惜售心理。若後續能出現量增紅K，有機會形成短期底部。`;
        }

        // 6. RSI 解析
        let rsiText = "";
        const rsiVal = (d.rsiV || 0).toFixed(1);
        if(d.rsiV >= 75) rsiText = `RSI(${rsiVal}) 進入「過熱區」。雖多頭氣勢強，但短線乖離過大。若股價創高但 RSI 未創高(背離)，為強烈回檔訊號。`;
        else if(d.rsiV <= 25) rsiText = `RSI(${rsiVal}) 進入「超賣區」。市場情緒極度悲觀，依鐘擺效應，隨時可能出現技術性反彈，不宜追空。`;
        else if(d.rsiV >= 50) rsiText = `RSI(${rsiVal}) 位於多方攻擊區 (50-75)。動能充沛且未過熱，是趨勢交易者最舒適的持股區間。`;
        else rsiText = `RSI(${rsiVal}) 位於空方抵抗區 (<50)。反彈力道疲弱，任何反彈至 50 附近若無法突破，皆是減碼時機。`;

        // 7. KD 解析
        let kdText = "";
        const kVal = (d.kdV.k || 0).toFixed(1);
        if(d.kdV.k > d.kdV.d) kdText = `KD 黃金交叉 (K=${kVal} > D)。短線動能轉強。若交叉發生在 20 以下低檔區，準確度高；若在 80 以上，可能為誘多或鈍化軋空。`;
        else kdText = `KD 死亡交叉 (K=${kVal} < D)。短線轉弱修正。若交叉發生在 80 以上高檔區，應立即停利；若在 20 以下鈍化，需觀察底部背離。`;

        // 8. MACD 解析
        let macdText = "";
        const osc = fmtM(d.macdH);
        if(d.macdH > 0) macdText = `MACD 柱狀體正值(${osc})，多頭控盤。若紅柱持續放大，代表處於主升段攻擊；若紅柱縮短，顯示漲勢趨緩，可能轉為橫盤震盪。`;
        else macdText = `MACD 柱狀體負值(${osc})，空頭控盤。若綠柱持續放大，代表急殺段，不可接刀；若綠柱收斂，顯示空方力道衰竭，醞釀止跌。`;

        // 9. 年歷史波動度解析 (10%)
        let hvText = "";
        const hvVal = (d.hv || 0).toFixed(2);
        const z = (d.hv - d.hvMean) / d.hvSD;
        if (z > 1.5) hvText = `當前年化波動度為 ${hvVal}%，遠高於平均值。市場目前處於「極端不穩定」狀態，價格波動劇烈且風險急遽放大，雖然可能伴隨高報酬，但保守投資者應避開此類不確定性。`;
        else if (z < -1.5) hvText = `當前年化波動度為 ${hvVal}%，處於極低位階。市場表現「異常穩定」，籌碼極度集中或處於冷門盤整，通常是蓄勢待發或極度安全的信號。`;
        else hvText = `當前波動度 ${hvVal}% 接近歷史平均 (${d.hvMean.toFixed(2)}%)。市場情緒穩定，屬於健康的價格波動範圍，適合依照既有趨勢策略執行。`;




        // 輔助函數
        const createMetric = (key, title, score, status, logic) => `
            <div class="metric-card">
                <div class="metric-top">
                    <span class="metric-title">${title}</span>
                    <div class="metric-score-box" onclick="showFormula('${key}')">${score} 分</div>
                </div>
                <div class="bar-bg"><div class="bar-fill" style="width:${score}%; background:${score>=70?'#10b981':(score<=30?'#ef4444':'#f59e0b')}"></div></div>
                <div class="metric-status" style="color:${score>=70?'#10b981':(score<=30?'#ef4444':'#f59e0b')}">➤ 狀態：${status}</div>
                <div class="metric-logic" style="margin-top:5px; padding-top:5px; border-top:1px dashed #334155; font-size:0.85rem; color:#cbd5e1; line-height:1.6;">${logic}</div>
            </div>`;
        
        const html = 
            createMetric("TrendLong", "長線趨勢 (15%)", s.trendLong, s.trendLong>=65?"長線強勢":s.trendLong<=35?"長線疲弱":"長線整理", trendLongText) +
            createMetric("TrendMid", "中長線趨勢 (10%)", s.trendMid, s.trendMid>=65?"中期強勢":s.trendMid<=35?"中期疲弱":"中期整理", trendMidText) +
            createMetric("TrendShort", "短線趨勢 (5%)", s.trendShort, s.trendShort>=65?"短線噴發":s.trendShort<=35?"短線修正":"短線震盪", trendShortText) +
            createMetric("Pos", "價格位階 (Position)", s.pos, s.pos>=80?"相對便宜":s.pos<=20?"相對昂貴":"合理區間", posText) +
            createMetric("Vol", "量價分析 (Volume)", s.vol, d.volR > 1 ? "量能放大" : "量能萎縮", volText) +
            createMetric("RSI", "RSI 動能強弱", s.rsi, d.rsiV > 70 ? "過熱區" : d.rsiV < 30 ? "超賣區" : "中性區", rsiText) +
            createMetric("KD", "KD 隨機指標", s.kd, d.kdV.k > d.kdV.d ? "黃金交叉" : "死亡交叉", kdText) +
            createMetric("MACD", "MACD 趨勢指標", s.macd, d.macdH > 0 ? "多方控盤" : "空方控盤", macdText) +
            createMetric("HV", "歷史波動度 (10%)", s.hv, z > 1 ? "波動放大" : z < -1 ? "波動收斂" : "穩定區間", hvText);

        document.getElementById('metricsContainer').innerHTML = html;
    }





     function analyzeMacroConditions(spyData, vixData) {
        let details = []; let totalImpact = 0;

        // --- 統計學核心運算 ---
        // 計算歷史波動率 (Historical Volatility)
        const calcHV = (prices, window=20) => {
            let logReturns = [];
            for(let i=1; i<prices.length; i++) logReturns.push(Math.log(prices[i]/prices[i-1]));
            let hvs = [];
            for(let i=window; i<logReturns.length; i++) {
                let slice = logReturns.slice(i-window, i);
                let mean = slice.reduce((a,b)=>a+b,0)/window;
                let sqDiff = slice.map(x => Math.pow(x-mean, 2)).reduce((a,b)=>a+b,0);
                hvs.push(Math.sqrt(sqDiff/window) * Math.sqrt(252) * 100);
            }
            return hvs;
        };
        // 計算標準分數 (Z-Score)
        const calcZScore = (cur, hist) => {
            const mean = hist.reduce((a,b)=>a+b,0)/hist.length;
            const sqDiff = hist.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b,0);
            const std = Math.sqrt(sqDiff/hist.length);
            return (cur - mean) / std;
        };

        const getRaw = (d) => [...d.values].reverse().map(x=>parseFloat(x.close));
        const getBB = (d, n=20) => { const sma=calcAvg(d,n), idx=d.length-1; let ss=0; for(let i=0;i<n;i++)ss+=Math.pow(d[idx-i]-sma[idx],2); const std=Math.sqrt(ss/n); return {mid:sma[idx], upper:sma[idx]+2*std}; };

        // 1. SPY 大盤深度分析
        if(spyData.values) {
            const raw = getRaw(spyData);
            const idx = raw.length-1, p = raw[idx];
            const ma20 = calcAvg(raw,20)[idx], ma60 = calcAvg(raw,60)[idx], ma200 = calcAvg(raw,200)[idx];
            
            // 波動率計算
            const hvSeries = calcHV(raw, 20);
            const curHV = hvSeries[hvSeries.length-1];
            const hvZ = calcZScore(curHV, hvSeries.slice(-200));

            // A1. 長期趨勢 (年線乖離)
            const bias200 = ((p - ma200)/ma200)*100;
            let r1 = {name:`長期趨勢 (年線乖離 ${bias200.toFixed(1)}%)`, val:p.toFixed(2)};
            if(bias200 > 5) { r1.status="強勢多頭"; r1.score=5; r1.class="tag-pos"; }
            else if(bias200 > 0) { r1.status="多頭支撐"; r1.score=2; r1.class="tag-pos"; }
            else if(bias200 > -5) { r1.status="轉弱修正"; r1.score=-5; r1.class="tag-neg"; }
            else { r1.status="深不見底"; r1.score=-15; r1.class="tag-neg"; }
            details.push(r1); totalImpact += r1.score;

            // A2. 短線乖離 (月線 20MA) - 新增
            const bias20 = ((p - ma20)/ma20)*100;
            let r2 = {name:`短線熱度 (月線乖離 ${bias20.toFixed(1)}%)`, val:bias20 > 0 ? "月線之上" : "月線之下"};
            if(bias20 > 3) { r2.status="短線過熱"; r2.score=0; r2.class="tag-neu"; } // 過熱不加分
            else if(bias20 > 0) { r2.status="短多強勢"; r2.score=3; r2.class="tag-pos"; }
            else { r2.status="短線整理"; r2.score=-2; r2.class="tag-neu"; }
            details.push(r2); totalImpact += r2.score;

            // A3. 中期架構 (季線 vs 年線) - 新增
            let r3 = {name:"中期架構 (60MA vs 200MA)", val: ma60>ma200 ? "多頭排列" : "空頭排列"};
            if(ma60 > ma200) { r3.status="助漲格局"; r3.score=3; r3.class="tag-pos"; }
            else { r3.status="助跌格局"; r3.score=-5; r3.class="tag-neg"; }
            details.push(r3); totalImpact += r3.score;

            // A4. 市場波動異常 (Z-Score)
            let r4 = {name:`市場波動 (Z-Score ${hvZ.toFixed(1)})`, val:`HV:${curHV.toFixed(1)}%`};
            if(hvZ > 2.5) { r4.status="極端恐慌"; r4.score=-8; r4.class="tag-neg"; }
            else if(hvZ > 1.5) { r4.status="波動異常"; r4.score=-4; r4.class="tag-neg"; }
            else { r4.status="波動正常"; r4.score=2; r4.class="tag-pos"; }
            details.push(r4); totalImpact += r4.score;
        }

        // 2. VIX 恐慌指數深度分析
        if(vixData.values) {
            const raw = getRaw(vixData);
            const idx = raw.length-1, v = raw[idx];
            const ma5 = calcAvg(raw, 5)[idx], ma20 = calcAvg(raw, 20)[idx];
            const bb = getBB(raw, 20);

            // B1. 絕對水位 (級距評分)
            let r5 = {name:"恐慌水位 (VIX Level)", val:v.toFixed(2)};
            if(v > 35) { r5.status="崩盤恐慌 (>35)"; r5.score=-12; r5.class="tag-neg"; }
            else if(v > 25) { r5.status="高度恐慌 (>25)"; r5.score=-8; r5.class="tag-neg"; }
            else if(v > 20) { r5.status="避險升溫 (>20)"; r5.score=-4; r5.class="tag-neg"; }
            else if(v < 15) { r5.status="樂觀平穩 (<15)"; r5.score=2; r5.class="tag-pos"; }
            else { r5.status="正常波動"; r5.score=0; r5.class="tag-neu"; }
            details.push(r5); totalImpact += r5.score;

            // B2. 恐慌動能 (具體化：5MA vs 20MA)
            // 說明：5日線代表短期情緒，20日線代表中期平均。5日線衝過20日線代表恐慌正在「加速」
            let r6 = {name:"恐慌動能 (VIX 5MA vs 20MA)", val: ma5.toFixed(2) + (ma5>ma20?" > ":" < ") + ma20.toFixed(2)};
            if(ma5 > ma20) {
                // 黃金交叉：恐慌加速中
                r6.status="⚠️ 加速升溫"; r6.score=-5; r6.class="tag-neg";
            } else {
                // 死亡交叉：恐慌降溫中
                r6.status="✅ 情緒降溫"; r6.score=3; r6.class="tag-pos";
            }
            details.push(r6); totalImpact += r6.score;

            // B3. 系統性風險 (布林突破)
            let r7 = {name:"崩盤預警 (VIX BB Break)", val: v>bb.upper ? "突破上軌" : "區間內"};
            if(v > bb.upper) { r7.status="系統性崩盤"; r7.score=-15; r7.class="tag-neg"; } // 重罰
            else { r7.status="未突破"; r7.score=0; r7.class="tag-neu"; }
            details.push(r7); totalImpact += r7.score;
        }

        return { details, totalImpact };
    }


    function updateMacroUI(res) {
        const tbody = document.getElementById('macroTableBody'); 
        tbody.innerHTML = '';
        res.details.forEach(i => {
            let color = i.score > 0 ? '#10b981' : (i.score < 0 ? '#ef4444' : '#cbd5e1');
            let sign = i.score > 0 ? '+' : '';
            tbody.innerHTML += `
                <tr>
                    <td style="padding:10px;">${i.name}</td>
                    <td style="font-family:monospace; color:#e2e8f0;">${i.val}</td>
                    <td><span class="score-tag ${i.class}" style="font-size:0.8rem;">${i.status}</span></td>
                    <td style="font-weight:bold; color:${color}; text-align:right; padding-right:15px;">${sign}${i.score}</td>
                </tr>`;});
        
        const total = res.totalImpact;
        const impBox = document.getElementById('impactVal');
        impBox.innerText = (total > 0 ? "+" : "") + total;
        impBox.style.color = total > 0 ? "#10b981" : (total < 0 ? "#ef4444" : "#cbd5e1");}


 function drawCharts(L, P, V, MA5, MA20, MA60, MA200, BB, RSI, MACD, KD, FIB, HV, hvMean, hvSD) {
    Object.values(charts).forEach(c => c?.destroy());
   
    const syncScale = (chart) => {
        const min = chart.scales.x.min;
        const max = chart.scales.x.max;
       
        [charts.main, charts.kd, charts.rsi, charts.macd, charts.hv].forEach(c => {
            if (c && c !== chart) {
                c.options.scales.x.min = min;
                c.options.scales.x.max = max;
                c.update('none');
            }
        });
    };

    const commonOpt = {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
            x: { display: false },
            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
        },
        plugins: {
            legend: { labels: { color: '#cbd5e1' } },
            zoom: {
                pan: { enabled: true, mode: 'x', onPan: ({chart}) => syncScale(chart) },
                zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x', onZoom: ({chart}) => syncScale(chart) }
            }
        }
    };

    const maxV = Math.max(...V);
   
    // 1. 主圖表
    charts.main = new Chart(document.getElementById('cMain'), {
        type: 'line',
        data: {
            labels: L,
            datasets: [
                {label:'Price', data:P, borderColor:'#fff', borderWidth:2, pointRadius:0, yAxisID:'y', order:1},
                {label:'MA5', data:MA5, borderColor:'#e879f9', borderWidth:1, pointRadius:0, yAxisID:'y', order:2},
                {label:'MA20', data:MA20, borderColor:'#22d3ee', borderWidth:1, pointRadius:0, yAxisID:'y', order:2},
                {label:'MA60', data:MA60, borderColor:'#3b82f6', borderWidth:1, pointRadius:0, yAxisID:'y', order:2},
                {label:'MA200', data:MA200, borderColor:'#f59e0b', borderWidth:2, pointRadius:0, yAxisID:'y', order:3},
                {label:'BB U', data:BB.upper, borderColor:'rgba(16,185,129,0.4)', borderWidth:1, pointRadius:0, fill:false, yAxisID:'y', order:4},
                {label:'BB L', data:BB.lower, borderColor:'rgba(16,185,129,0.4)', borderWidth:1, pointRadius:0, fill:false, yAxisID:'y', order:5},
                {type:'bar', label:'Vol', data:V, backgroundColor:'rgba(255,255,255,0.1)', yAxisID:'y1', order:6}
            ]
        },
        options: {
            ...commonOpt,
            scales: {
                x: { ticks: { color: '#94a3b8', maxTicksLimit: 12 }, grid: { color: '#334155' }, display: true },
                y: { position: 'left', grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                y1: { position: 'right', min: 0, max: maxV*4, display: false }
            },
            plugins: {
                ...commonOpt.plugins,
                annotation: {
                    annotations: {
                        f6:{type:'line',yMin:FIB.f618,yMax:FIB.f618,borderColor:'rgba(16,185,129,0.6)',borderDash:[4,4],borderWidth:1,label:{display:true,content:'Fib .618',position:'end',color:'#10b981',font:{size:10}}},
                        f5:{type:'line',yMin:FIB.f500,yMax:FIB.f500,borderColor:'rgba(245,158,11,0.6)',borderDash:[4,4],borderWidth:1,label:{display:true,content:'Fib .5',position:'end',color:'#f59e0b',font:{size:10}}}
                    }
                }
            }
        }
    });
   
    charts.kd = new Chart(document.getElementById('cKD'), {
        type: 'line',
        data: { labels:L, datasets:[{label:'K',data:KD.K,borderColor:'#facc15',pointRadius:0},{label:'D',data:KD.D,borderColor:'#a855f7',pointRadius:0}] },
        options: {
            ...commonOpt,
            plugins: {
                ...commonOpt.plugins,
                annotation: {annotations:{l1:{type:'line',yMin:80,yMax:80,borderColor:'red',borderDash:[2,2]},l2:{type:'line',yMin:20,yMax:20,borderColor:'green',borderDash:[2,2]}}}
            }
        }
    });

    charts.rsi = new Chart(document.getElementById('cRSI'), {
        type: 'line',
        data: { labels:L, datasets:[{label:'RSI',data:RSI,borderColor:'#38bdf8',pointRadius:0}] },
        options: {
            ...commonOpt,
            scales:{...commonOpt.scales, y:{min:0,max:100,grid:{color:'#334155'},ticks:{color:'#94a3b8'}}},
            plugins: {
                ...commonOpt.plugins,
                annotation: {annotations:{l1:{type:'line',yMin:70,yMax:70,borderColor:'red',borderDash:[2,2]},l2:{type:'line',yMin:30,yMax:30,borderColor:'green',borderDash:[2,2]}}}
            }
        }
    });

    charts.macd = new Chart(document.getElementById('cMACD'), {
        type: 'bar',
        data: {
            labels:L,
            datasets:[
                {type:'line',label:'DIF',data:MACD.dif,borderColor:'#3b82f6',pointRadius:0},
                {type:'line',label:'Sig',data:MACD.sig,borderColor:'#f59e0b',pointRadius:0},
                {label:'Hist',data:MACD.hist,backgroundColor:c=>c.raw>=0?'#10b981':'#ef4444'}
            ]
        },
        options: commonOpt
    });

    // 5. 歷史波動度圖表 (HV) + 統計參考線
    const hvFiltered = HV.filter(v => v > 0);
    const hvMin = Math.min(...hvFiltered);
    const hvMax = Math.max(...hvFiltered);
    const yMin = Math.max(0, Math.min(hvMin, hvMean - 3 * hvSD) * 0.9);
    const yMax = Math.max(hvMax, hvMean + 3 * hvSD) * 1.1;

    charts.hv = new Chart(document.getElementById('cVolat'), {
        type: 'line',
        data: {
            labels: L,
            datasets: [{ label: '年化歷史波動度 (HV %)', data: HV, borderColor: '#a855f7', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 }]
        },
        options: {
            ...commonOpt,
            scales: {
                ...commonOpt.scales,
                y: { beginAtZero: false, min: yMin, max: yMax, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
            },
            plugins: {
                ...commonOpt.plugins,
                title: { display: true, text: '年度歷史波動度 (帶統計標準差線)', color: '#94a3b8' },
                annotation: {
                    annotations: {
                        m: { type: 'line', yMin: hvMean, yMax: hvMean, borderColor: '#cbd5e1', borderWidth: 1, label: { display: true, content: 'Mean', position: 'start', color: '#cbd5e1', font: { size: 9 } } },
                        p1: { type: 'line', yMin: hvMean + hvSD, yMax: hvMean + hvSD, borderColor: '#10b981', borderDash: [5, 5], borderWidth: 1, label: { display: true, content: '+1σ', position: 'end', color: '#10b981', font: { size: 9 } } },
                        m1: { type: 'line', yMin: hvMean - hvSD, yMax: hvMean - hvSD, borderColor: '#10b981', borderDash: [5, 5], borderWidth: 1, label: { display: true, content: '-1σ', position: 'end', color: '#10b981', font: { size: 9 } } },
                        p2: { type: 'line', yMin: hvMean + 2 * hvSD, yMax: hvMean + 2 * hvSD, borderColor: '#f59e0b', borderDash: [5, 5], borderWidth: 1, label: { display: true, content: '+2σ', position: 'end', color: '#f59e0b', font: { size: 9 } } },
                        m2: { type: 'line', yMin: hvMean - 2 * hvSD, yMax: hvMean - 2 * hvSD, borderColor: '#f59e0b', borderDash: [5, 5], borderWidth: 1, label: { display: true, content: '-2σ', position: 'end', color: '#f59e0b', font: { size: 9 } } },
                        p3: { type: 'line', yMin: hvMean + 3 * hvSD, yMax: hvMean + 3 * hvSD, borderColor: '#ef4444', borderDash: [5, 5], borderWidth: 1, label: { display: true, content: '+3σ', position: 'end', color: '#ef4444', font: { size: 9 } } },
                        m3: { type: 'line', yMin: hvMean - 3 * hvSD, yMax: hvMean - 3 * hvSD, borderColor: '#ef4444', borderDash: [5, 5], borderWidth: 1, label: { display: true, content: '-3σ', position: 'end', color: '#ef4444', font: { size: 9 } } }
                    }
                }
            }
        }
    });
}




    function clamp(n) { return Math.min(100, Math.max(0, Math.round(n))); }
    function startCooldown(sec) { countdown = sec; const btn = document.getElementById('btnStart'); const timer = setInterval(() => { btn.innerText = `冷卻中 (${countdown}s)`; countdown--; if(countdown < 0) { clearInterval(timer); btn.innerText="Run Model"; btn.disabled=false; } }, 1000); } 

function calcHV(C, window = 252) {
    if (C.length < window + 1) return new Array(C.length).fill(0);
    let hv = new Array(C.length).fill(0);
    for (let i = window; i < C.length; i++) {
        let returns = [];
        for (let j = i - window + 1; j <= i; j++) {
            returns.push(Math.log(C[j] / C[j - 1]));
        }
        let mean = returns.reduce((a, b) => a + b, 0) / returns.length;
        let variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (returns.length - 1);
        hv[i] = Math.sqrt(variance * 252) * 100; // 年化百分比
    }
    return hv;
}


function showRiskFormula() {
    const modal = document.getElementById('scoreModal');
    const title = document.getElementById('mTitle');
    const weight = document.getElementById('mWeight');
    const list = document.getElementById('mFormula');
    
    title.innerText = "風險控管模型說明";
    weight.innerText = "Volatility-Adjusted Model";
    
    list.innerHTML = window.currentRiskDetail || "<li>請先執行模型分析以計算當前個股數據。</li>";
    
    modal.style.display = 'flex';
}


</script>

</body>
</html>

