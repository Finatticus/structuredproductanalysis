<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå› å­æ¨¡å‹ (åƒ…ç¾è‚¡ç”¨)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a; --bg-panel: #1e293b; --text-main: #f8fafc; --text-sub: #94a3b8;
            --accent-blue: #3b82f6; --accent-green: #10b981; --accent-red: #ef4444; --accent-yellow: #f59e0b;
            --border: #334155; --risk-bg: #450a0a;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }

        /* é ‚éƒ¨æ§åˆ¶åˆ— */
        .header {
            background: var(--bg-panel); padding: 20px; border-radius: 12px;
            display: flex; gap: 15px; align-items: flex-end; border: 1px solid var(--border);
            margin-bottom: 20px; flex-wrap: wrap;
        }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.85rem; color: var(--text-sub); }
        input { background: #0b1120; border: 1px solid #475569; color: white; padding: 10px; border-radius: 6px; }
        /* API Key å°ˆç”¨æ¨£å¼ */
        #inpApiKey { width: 280px; letter-spacing: 2px; color: #facc15; font-family: monospace; }

        button {
            background: var(--accent-blue); color: white; border: none; padding: 11px 25px;
            border-radius: 6px; cursor: pointer; font-weight: 600; height: 42px; width: 220px;
        }
        button:disabled { background: #475569; cursor: not-allowed; }

        /* â˜… V9.0 ç¸½ç¶“çŸ©é™£ (ä¿ç•™æ¨£å¼) */
        .macro-container {
            display: none; grid-template-columns: 2fr 1fr; gap: 20px;
            background: rgba(15, 23, 42, 0.8); border: 1px solid var(--accent-blue); border-radius: 12px;
            padding: 20px; margin-bottom: 20px; display: none; height: auto; overflow: visible;
        }
        .matrix-box { background: var(--bg-panel); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
        .matrix-header { background: #334155; padding: 10px 15px; font-weight: bold; color: var(--accent-yellow); display: flex; justify-content: space-between; align-items: center; }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .matrix-table th { text-align: left; padding: 8px 15px; color: var(--text-sub); border-bottom: 1px solid var(--border); }
        .matrix-table td { padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .score-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; }
        .tag-pos { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .tag-neg { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .tag-neu { background: rgba(148, 163, 184, 0.2); color: var(--text-sub); }

        .macro-summary { display: flex; flex-direction: column; justify-content: space-between; }
        .impact-box { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent-blue); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 10px; }
        .impact-score { font-size: 2.5rem; font-weight: 800; line-height: 1; margin: 5px 0; }
        .formula-text { font-size: 0.8rem; color: var(--text-sub); line-height: 1.4; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }

        /* ä¸»ä½ˆå±€ */
        .grid-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; opacity: 0; transition: opacity 0.5s; }
        .report-card {
            background: var(--bg-panel); 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            height: auto; 
        }

        .total-score-box { text-align: center; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .score-display {
            font-size: 5rem; 
            font-weight: 800; 
            line-height: 1.2; 
            margin: 10px 0;
            color: #f8fafc; /* é è¨­ç™½è‰²ï¼ŒJS æœƒæ ¹æ“šåˆ†æ•¸æ”¹è‰² */
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); /* å¢åŠ ä¸€é»ç™¼å…‰è³ªæ„Ÿ */
        }

        .verdict { font-size: 1.2rem; font-weight: bold; padding: 5px 15px; border-radius: 20px; display: inline-block; }

        /* ç­–ç•¥å¡ */
        .strategy-card { background: rgba(59, 130, 246, 0.08); border: 1px solid var(--accent-blue); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .strategy-header { font-weight: bold; color: var(--accent-blue); font-size: 1.1rem; margin-bottom: 15px; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 10px; }
        .st-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .st-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }
        .st-label { font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        .st-val { font-size: 1.1rem; font-family: monospace; font-weight: bold; color: white; }
        .st-formula { font-size: 0.75rem; color: #64748b; margin-top: 2px; }

        .metric-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 15px; }
        .metric-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .metric-title { font-size: 1rem; font-weight: bold; color: #e2e8f0; }
        
        .metric-score-box { 
            background: #0f172a; border: 1px solid #475569; padding: 2px 10px; border-radius: 6px; 
            font-family: monospace; font-weight: bold; font-size: 1.1rem; color: #facc15; 
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .metric-score-box:hover { background: #334155; border-color: var(--accent-yellow); transform: scale(1.05); }
        .metric-score-box::after { content: 'â„¹ï¸'; font-size: 0.7rem; opacity: 0.7; }

        .bar-bg { height: 6px; background: #334155; border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.8s ease-out; }
        .metric-status { font-size: 0.9rem; font-weight: bold; margin-bottom: 4px; color: #f8fafc; }
        .metric-logic { font-size: 0.8rem; color: #94a3b8; line-height: 1.4; }

        .charts-area { display: flex; flex-direction: column; gap: 15px; }
        .chart-box { background: var(--bg-panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); position: relative; }
        #chartMainBox { height: 500px; } .sub-chart { height: 300px; }
        .loading { color: var(--accent-blue); display: none; margin-left: 10px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #1e293b; border: 1px solid var(--accent-blue); width: 500px; border-radius: 12px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); position: relative;
        }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }
        .modal-title { font-size: 1.4rem; font-weight: bold; color: white; margin-bottom: 5px; }
        .modal-weight { display: inline-block; background: var(--accent-blue); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 15px; }
        .formula-list { list-style: none; padding: 0; margin: 0; font-size: 0.95rem; color: #cbd5e1; }
        .formula-list li { margin-bottom: 10px; padding-left: 15px; border-left: 3px solid #475569; }
    </style>
</head>
<body>

<div class="modal-overlay" id="scoreModal" onclick="closeModal(event)">
    <div class="modal-content">
        <span class="modal-close" onclick="document.getElementById('scoreModal').style.display='none'">&times;</span>
        <div class="modal-title" id="mTitle">æŒ‡æ¨™åç¨±</div>
        <div class="modal-weight" id="mWeight">æ¬Šé‡: 20%</div>
        <ul class="formula-list" id="mFormula">
            </ul>
    </div>
</div>

<div class="container">
    <div class="header">
        <div class="input-group">
            <label>è‚¡ç¥¨ä»£è™Ÿ</label>
            <input type="text" id="inpSymbol" value="TSLA" style="width: 100px;">
        </div>
        <div class="input-group">
            <label>å¹´é™</label>
            <input type="number" id="inpYears" value="1" min="1" max="5" style="width: 80px;">
        </div>
        <div class="input-group">
            <label>API Key</label>
            <input type="password" id="inpApiKey" value="e9e9c1790b11411abfb50f990984fbf1" oncopy="return false" oncut="return false">
        </div>
        <button onclick="startSystem()" id="btnStart">RUN MODEL</button>
        <div class="loading" id="loadingMsg">è·‘ä¸€ä¸‹.. å¾ˆå¿«</div>
    </div>

    <div class="grid-container" id="mainLayout" style="margin-bottom: 40px;">
        <div class="report-card">
            <div class="total-score-box">
                <div style="color:var(--text-sub); font-size:0.9rem; letter-spacing:1px; text-transform:uppercase;">Alpha Strategy Score</div>
                <div class="score-display" id="finalScore">--</div>
                <div class="verdict" id="finalVerdict">--</div>
            </div>

            <div class="strategy-card">
                <div class="strategy-header"><span>é¢¨éšªæ§ç®¡ (ATR Volatility Model)</span></div>
                <div class="st-grid">
                    <div class="st-box"><span class="st-label">ç•¶å‰è‚¡åƒ¹ (Price)</span><span class="st-val" id="stPrice">--</span></div>
                    <div class="st-box"><span class="st-label">çœŸå¯¦æ³¢å‹• (ATR)</span><span class="st-val" id="stATR">--</span><div class="st-formula">Period: 14 Days</div></div>
                </div>
                <div class="st-grid">
                    <div class="st-box" style="border: 1px solid rgba(239, 68, 68, 0.3);">
                        <span class="st-label" style="color:#fca5a5">å»ºè­°æ­¢æ (Stop Loss)</span><span class="st-val" style="color:#ef4444" id="stSL">--</span>
                        <div class="st-formula">å…¬å¼: Price - (3 Ã— ATR)</div>
                        <div class="st-formula" style="color:#ef4444">å®¹å¿ 3Ïƒ æ³¢å‹• (é•·ç·šæŠ—éœ‡)</div>
                    </div>
                    <div class="st-box" style="border: 1px solid rgba(16, 185, 129, 0.3);">
                        <span class="st-label" style="color:#86efac">ç›®æ¨™æ­¢ç›ˆ (Take Profit)</span><span class="st-val" style="color:#10b981" id="stTP">--</span>
                        <div class="st-formula">å…¬å¼: Price + (6 Ã— ATR)</div>
                        <div class="st-formula" style="color:#10b981">è¨­å®š 1:2 æç›Šæ¯” (æ³¢æ®µ)</div>
                    </div>
                </div>
            </div>

            <div id="metricsContainer"></div>
        </div>

        <div class="charts-area">
            <div class="chart-box" id="chartMainBox"><canvas id="cMain"></canvas></div>
            <div class="chart-box sub-chart"><canvas id="cKD"></canvas></div>
            <div class="chart-box sub-chart"><canvas id="cRSI"></canvas></div>
            <div class="chart-box sub-chart"><canvas id="cMACD"></canvas></div>
        </div>
    </div>

    <div class="macro-container" id="macroPanel" style="display:none; grid-template-columns: 1fr; gap: 30px; margin-top:50px; border-top:1px solid #334155; padding-top:30px;">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
            <div class="matrix-box">
                <div class="matrix-header">
                    <span>å®è§€å¤šç©ºçŸ©é™£ (Macro Matrix)</span>
                    <span style="font-size:0.8rem; opacity:0.8">Data Source: SPY & VIX</span>
                </div>
                <table class="matrix-table">
                    <thead><tr><th width="35%">é‡åŒ–æª¢æ¸¬å› å­ (Factors)</th><th width="20%">ç›®å‰æ•¸å€¼</th><th width="30%">æ¨¡å‹åˆ¤å®š</th><th width="15%">æ¬Šé‡ä¿®æ­£</th></tr></thead>
                    <tbody id="macroTableBody"></tbody>
                </table>
            </div>

            <div class="macro-summary">
                <div class="impact-box">
                    <div style="font-size:1rem; color:var(--accent-blue); font-weight:bold;">ç¸½é«”ç¶“æ¿Ÿé¢¨éšªä¿‚æ•¸ (Macro Risk Alpha)</div>
                    <div class="impact-score" id="impactVal">0</div>
                    <div style="font-size:0.85rem; opacity:0.8">æ­¤ä¿‚æ•¸ä»£è¡¨ç³»çµ±æ€§é¢¨éšªå°å€‹è‚¡æœŸæœ›å€¼çš„ä¿®æ­£å¹…åº¦</div>
                </div>
                <div class="formula-box" style="flex-grow:1; display:flex; flex-direction:column;">
                    <div style="font-weight:bold; margin-bottom:10px; color:#cbd5e1; border-bottom:1px solid #475569; padding-bottom:5px;">ğŸ“ é‡åŒ–æ¨¡å‹è©•åˆ†æ©Ÿåˆ¶è©³è§£ (Quantitative Scoring Methodology)ï¼š</div>
                    <div class="formula-text" style="font-size:0.85rem; line-height:1.7; color:#94a3b8; overflow-y:auto; max-height:300px;">
                        <p style="margin:0 0 8px 0;">æœ¬ç³»çµ±æ¡ç”¨<b>å¤šå› å­é‡åŒ–æ¨¡å‹ (Multi-Factor Model)</b>ï¼Œé‡å°å¸‚å ´è¶¨å‹¢ã€æ³¢å‹•ç‡èˆ‡å‹•èƒ½é€²è¡ŒåŠ æ¬Šè©•ä¼°ã€‚åŸºæº–åˆ†ç‚º 0 åˆ†ï¼Œæ­£å€¼ä»£è¡¨é †é¢¨ï¼ˆTailwindï¼‰ï¼Œè² å€¼ä»£è¡¨é€†é¢¨ï¼ˆHeadwindï¼‰ã€‚</p>
                        
                        <strong style="color:#e2e8f0;">1. é•·æœŸè¶¨å‹¢å› å­ (Long-term Trend Factor)ï¼š</strong>
                        <ul style="margin:5px 0 10px 0; padding-left:20px;">
                            <li><b>å¹´ç·šä¹–é›¢ç‡ (BIAS 200MA)ï¼š</b>è¡¡é‡ SPY èˆ‡å¹´ç·šçš„è·é›¢ã€‚è‹¥è·Œç ´å¹´ç·šè¦–ç‚ºç†Šå¸‚è¨Šè™Ÿï¼Œçµ¦äºˆ <b>-20åˆ†</b> çš„æ¥µç«¯æ‡²ç½°ï¼Œä»¥è¦é¿é•·æœŸä¸‹è¡Œé¢¨éšªã€‚</li>
                            <li><b>å‡ç·šæ¶æ§‹ (MA Structure)ï¼š</b>æª¢æ¸¬ 60MA èˆ‡ 200MA çš„ç›¸å°ä½ç½®ï¼Œç¢ºèªé»ƒé‡‘äº¤å‰ï¼ˆ+3åˆ†ï¼‰æˆ–æ­»äº¡äº¤å‰ï¼ˆ-5åˆ†ï¼‰çš„ä¸­æœŸè¶¨å‹¢ã€‚</li>
                        </ul>

                        <strong style="color:#e2e8f0;">2. æ³¢å‹•ç‡é¢¨éšªå› å­ (Volatility Risk Factor)ï¼š</strong>
                        <ul style="margin:5px 0 10px 0; padding-left:20px;">
                            <li><b>VIX çµ•å°æ°´ä½ (Absolute Level)ï¼š</b>æ¡ç”¨ç´šè·å¼æ‰£åˆ†æ¨¡å‹ã€‚VIX>20 é–‹å§‹æ‰£åˆ†ï¼Œ>30 è¦–ç‚ºé«˜åº¦ææ…Œ (-8åˆ†)ï¼Œ>35 è¦–ç‚ºå´©ç›¤å‰å…† (-12åˆ†)ã€‚</li>
                            <li><b>å¸ƒæ—é€šé“å£“åŠ›æ¸¬è©¦ (Bollinger Stress Test)ï¼š</b>ç•¶ VIX çªç ´å¸ƒæ—ä¸Šè»Œ (Upper Band)ï¼Œä»£è¡¨ç™¼ç”Ÿ 2å€‹æ¨™æº–å·® (2Ïƒ) ä»¥ä¸Šçš„æ¥µç«¯ææ…Œäº‹ä»¶ï¼Œè§¸ç™¼ <b>-15åˆ†</b> çš„ç†”æ–·æ©Ÿåˆ¶ã€‚</li>
                            <li><b>æ­·å²æ³¢å‹•ç‡ç•°å¸¸ (HV Z-Score)ï¼š</b>è¨ˆç®—éå» 200æ—¥æ³¢å‹•ç‡çš„æ¨™æº–åˆ†æ•¸ã€‚è‹¥ Z-Score > 2.5ï¼Œä»£è¡¨å¸‚å ´è™•æ–¼çµ±è¨ˆå­¸ä¸Šçš„æ¥µç«¯ä¸ç©©å®šç‹€æ…‹ã€‚</li>
                        </ul>

                        <strong style="color:#e2e8f0;">3. å‹•èƒ½å› å­ (Momentum Factor)ï¼š</strong>
                        <ul style="margin:5px 0 0 0; padding-left:20px;">
                            <li><b>ææ…Œå‹•èƒ½ (VIX Momentum)ï¼š</b>é€é VIX 5æ—¥ç·šèˆ‡ 20æ—¥ç·šçš„äº¤å‰é—œä¿‚ï¼Œåˆ¤æ–·ææ…Œæƒ…ç·’æ˜¯åœ¨ã€ŒåŠ é€Ÿå‡æº«ã€é‚„æ˜¯ã€Œé™æº«å†·å»ã€ã€‚</li>
                            <li><b>çŸ­ç·šä¹–é›¢ (Short-term BIAS)ï¼š</b>æª¢æ¸¬ SPY èˆ‡æœˆç·šçš„ä¹–é›¢ï¼Œéå¤§å‰‡è¦–ç‚ºéç†± (0åˆ†)ï¼Œé©ä¸­å‰‡è¦–ç‚ºå¼·å‹¢ (+3åˆ†)ã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
            <div class="chart-box" style="min-height:400px !important; padding:0; overflow:hidden; border-radius:12px; border:1px solid #334155;">
                <div id="tv_chart_spy" style="height:100%; width:100%;"></div>
            </div>
            <div class="chart-box" style="min-height:400px !important; padding:0; overflow:hidden; border-radius:12px; border:1px solid #334155;">
                <div id="tv_chart_vix" style="height:100%; width:100%;"></div>
            </div>
        </div>
    </div>
</div>


<script>
    // æ•¸å­¸é‹ç®—
    const calcAvg = (d, n) => { let r=[]; for(let i=0;i<d.length;i++){ if(i<n-1){r.push(null);continue;} let s=0; for(let j=0;j<n;j++)s+=d[i-j]; r.push(s/n); } return r; };
    const calcEMA = (d, n) => { let k=2/(n+1), r=new Array(d.length).fill(null), s=0; for(let i=0;i<n;i++)s+=d[i]; r[n-1]=s/n; for(let i=n;i<d.length;i++)r[i]=d[i]*k+r[i-1]*(1-k); return r; };
    const calcBollinger = (d, n=20) => { const sma=calcAvg(d, n), u=[], l=[]; for(let i=0;i<d.length;i++){ if(!sma[i]){u.push(null);l.push(null);continue;} let ss=0; for(let j=0;j<n;j++)ss+=Math.pow(d[i-j]-sma[i],2); let std=Math.sqrt(ss/n); u.push(sma[i]+std*2); l.push(sma[i]-std*2); } return {upper:u, lower:l}; };
    const calcRSI = (d, n=14) => { let r=new Array(d.length).fill(null), g=[], l=[]; for(let i=1;i<d.length;i++){ let df=d[i]-d[i-1]; g.push(df>0?df:0); l.push(df<0?Math.abs(df):0); } for(let i=n;i<d.length;i++){ let ag=g.slice(i-n,i).reduce((a,b)=>a+b)/n, al=l.slice(i-n,i).reduce((a,b)=>a+b)/n; r[i]=al===0?100:100-(100/(1+ag/al)); } return r; };
    const calcMACD = (d) => { const e12=calcEMA(d,12), e26=calcEMA(d,26), dif=d.map((v,i)=>(e12[i]&&e26[i])?e12[i]-e26[i]:null); let vd=dif.filter(x=>x!==null), vs=calcEMA(vd,9), sig=new Array(dif.length-vs.length).fill(null).concat(vs), h=dif.map((v,i)=>(v!==null&&sig[i]!==null)?v-sig[i]:null); return {dif,sig,hist:h}; };
    const calcKD = (c, h, l, n=9) => { let K=[], D=[], k=50, d=50; for(let i=0;i<c.length;i++){ if(i<n-1){K.push(null);D.push(null);continue;} let mx=-Infinity, mn=Infinity; for(let j=0;j<n;j++){ mx=Math.max(mx,h[i-j]); mn=Math.min(mn,l[i-j]); } let rsv=mx===mn?50:((c[i]-mn)/(mx-mn))*100; k=(2/3)*k+(1/3)*rsv; d=(2/3)*d+(1/3)*k; K.push(k); D.push(d); } return {K,D}; };
    const calcATR = (h, l, c, n=14) => { let tr=[h[0]-l[0]]; for(let i=1;i<h.length;i++) tr.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1]))); let atr=new Array(h.length).fill(null), s=0; for(let i=0;i<n;i++)s+=tr[i]; atr[n-1]=s/n; for(let i=n;i<h.length;i++)atr[i]=(atr[i-1]*(n-1)+tr[i])/n; return atr; };
    const calcFib = (h, l) => { const mx=Math.max(...h), mn=Math.min(...l), d=mx-mn; return {f618:mx-d*0.618, f500:mx-d*0.5, f382:mx-d*0.382}; };

    let charts = {};
    let countdown = 0;

     async function getYahooVIX() {
        // Yahoo API ç›®æ¨™ç¶²å€
        const targetUrl = "https://query1.finance.yahoo.com/v8/finance/chart/%5EVIX?interval=1d&range=1y";
        
        // å®šç¾©å…©å€‹ä¸åŒçš„ CORS Proxy æœå‹™ä½œç‚ºå‚™æ´
        const proxies = [
            // ä»£ç† 1: corsproxy.io (é€Ÿåº¦å¿«ï¼Œä½†å¶çˆ¾æœƒæ“‹)
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            // ä»£ç† 2: allorigins.win (é€Ÿåº¦ç¨æ…¢ï¼Œä½†ç©©å®šæ€§é«˜)
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
        ];

        // å…§éƒ¨è§£æå‡½æ•¸ (çµ±ä¸€è™•ç† Yahoo çš„ JSON æ ¼å¼)
        const parseYahooData = (data) => {
            if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                throw new Error("Yahoo API å›å‚³æ ¼å¼éŒ¯èª¤");
            }
            const result = data.chart.result[0];
            const timestamps = result.timestamp;
            const quotes = result.indicators.quote[0].close;
            
            if (!timestamps || !quotes) throw new Error("ç„¡ VIX æ•¸æ“š");

            let formattedData = [];
            for (let i = 0; i < timestamps.length; i++) {
                if (quotes[i] != null) {
                    let date = new Date(timestamps[i] * 1000);
                    // ä¿®æ­£æ™‚å€å•é¡Œï¼Œç¢ºä¿æ—¥æœŸæº–ç¢º
                    let dateStr = date.toISOString().split('T')[0];
                    formattedData.push({
                        datetime: dateStr,
                        close: quotes[i]
                    });
                }
            }
            return { values: formattedData.reverse() }; // è½‰ç‚ºç”±æ–°åˆ°èˆŠ
        };

        // â˜… è‡ªå‹•åˆ‡æ›ä»£ç†æ©Ÿåˆ¶
        for (let i = 0; i < proxies.length; i++) {
            try {
                const proxyUrl = proxies[i](targetUrl);
                console.log(`å˜—è©¦æŠ“å– VIX (ä»£ç† ${i+1})...`);
                
                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                
                const data = await res.json();
                const parsed = parseYahooData(data);
                
                console.log("VIX æŠ“å–æˆåŠŸï¼");
                return parsed; // æˆåŠŸå°±å›å‚³ï¼Œè·³å‡ºè¿´åœˆ

            } catch (e) {
                console.warn(`ä»£ç† ${i+1} å¤±æ•—:`, e.message);
                // å¦‚æœæ˜¯æœ€å¾Œä¸€å€‹ä»£ç†ä¹Ÿå¤±æ•—ï¼Œæ‰æ‹‹å‡ºéŒ¯èª¤
                if (i === proxies.length - 1) {
                    throw new Error("æ‰€æœ‰ VIX ä¾†æºçš†ç„¡æ³•é€£ç·šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
                // å¦å‰‡ç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹ä»£ç†
            }
        }
    }

    async function startSystem() {
        const apiKey = document.getElementById('inpApiKey').value.trim();
        const symbol = document.getElementById('inpSymbol').value.toUpperCase();
        let years = parseFloat(document.getElementById('inpYears').value) || 1;
        if(years > 5) years = 5;
        const fetchYears = years + 1;
        const size = Math.ceil(fetchYears * 260);

        const btn = document.getElementById('btnStart');
        const loader = document.getElementById('loadingMsg');
        
        btn.disabled = true; 
        loader.style.display = 'inline';
        document.getElementById('mainLayout').style.opacity = '0.3';
        document.getElementById('macroPanel').style.display = 'none'; // å…ˆéš±è—

        try {
            // 1. æ•¸æ“šæŠ“å– (ç”¨æ–¼è¨ˆç®—çŸ©é™£åˆ†æ•¸)
            const pStock = fetch(`https://api.twelvedata.com/time_series?symbol=${symbol}&interval=1day&outputsize=${size}&apikey=${apiKey}`).then(r=>r.json());
            const pSpy = fetch(`https://api.twelvedata.com/time_series?symbol=SPY&interval=1day&outputsize=400&apikey=${apiKey}`).then(r=>r.json());
            const pVix = getYahooVIX(); 

            const [stockData, spyData, vixData] = await Promise.all([pStock, pSpy, pVix]);

            if(stockData.status === 'error') throw new Error("API éŒ¯èª¤: " + stockData.message);

            // è³‡æ–™è½‰æ›
            const raw = stockData.values.reverse();
            const C = raw.map(x=>parseFloat(x.close)), H = raw.map(x=>parseFloat(x.high)), L = raw.map(x=>parseFloat(x.low)), V = raw.map(x=>parseFloat(x.volume)), T = raw.map(x=>x.datetime);
            
            // è¨ˆç®—å€‹è‚¡æŒ‡æ¨™
            const sma5=calcAvg(C,5), sma20=calcAvg(C,20), sma60=calcAvg(C,60), sma200=calcAvg(C,200);
            const bb=calcBollinger(C,20), rsi=calcRSI(C,14), macd=calcMACD(C), kd=calcKD(C,H,L,9), atr=calcATR(H,L,C,14), fib=calcFib(H,L);

            // 2. ç¸½ç¶“çŸ©é™£è¨ˆç®— (åˆ†æ•¸ä»ç”± API æ•¸æ“šç²¾ç®—)
            const macroAnalysis = analyzeMacroConditions(spyData, vixData);
            updateMacroUI(macroAnalysis);

            // â˜… é—œéµæ­¥é©Ÿï¼šé¡¯ç¤ºé¢æ¿ä¸¦è¼‰å…¥ TradingView Widget
            document.getElementById('macroPanel').style.display = 'grid';
            loadTradingViewWidgets(); 

            // è¨ˆç®—å€‹è‚¡åˆ†æ•¸
            const idx = C.length - 1, p = C[idx];
            let scores = {};
            
            // è©•åˆ†é‚è¼¯
            let tS=50; if(sma200[idx]) { tS+=Math.min(20,Math.max(-20,((p-sma200[idx])/sma200[idx])*100)); if(p>sma60[idx])tS+=10; if(sma60[idx]>sma200[idx])tS+=10; } scores.trend=clamp(tS);
            let pb=(p-bb.lower[idx])/(bb.upper[idx]-bb.lower[idx]); scores.pos=clamp(pb<0?100:(pb>1?0:100-(pb*100)));
            let vS=50, vR=V[idx]/calcAvg(V,20)[idx]; if(C[idx]>C[idx-1])vS+=(vR>1?(vR-1)*20:-(1-vR)*20); else vS+=(vR>1?-(vR-1)*20:(1-vR)*10); scores.vol=clamp(vS);
            let rV=rsi[idx], rS=rV<30?80+(30-rV):(rV>70?20-(rV-70):50+(50-rV)); scores.rsi=clamp(rS);
            let kV=kd.K[idx], dV=kd.D[idx], kS=kV<20?80+(20-kV):(kV>80?20-(kV-80):50+(50-kV)); if(kV>dV && kd.K[idx-1]<=kd.D[idx-1])kS+=15; if(kV<dV && kd.K[idx-1]>=kd.D[idx-1])kS-=15; scores.kd=clamp(kS);
            let mH=macd.hist[idx], pH=macd.hist[idx-1], mS=mH>0?(mH>pH?70:55):(mH>pH?50:30); scores.macd=clamp(mS);

            // ç¸½åˆ†èˆ‡ UI æ›´æ–°
            let rawTotal = (scores.trend*0.2)+(scores.pos*0.2)+(scores.vol*0.15)+(scores.rsi*0.15)+(scores.kd*0.15)+(scores.macd*0.15);
            let finalScore = Math.round(rawTotal + macroAnalysis.totalImpact);
            if(finalScore < 0) finalScore = 0; if(finalScore > 100) finalScore = 100;

            const elScore = document.getElementById('finalScore');
            elScore.innerText = finalScore;
            if(finalScore >= 80) elScore.style.color = "#10b981";
            else if(finalScore >= 60) elScore.style.color = "#3b82f6";
            else if(finalScore >= 40) elScore.style.color = "#f59e0b";
            else elScore.style.color = "#ef4444";
            if(macroAnalysis.totalImpact < -8) elScore.style.color = "#ef4444"; 

            const elVerdict = document.getElementById('finalVerdict');
            if(finalScore>=80) { elVerdict.innerText="ğŸ”¥ å¼·åŠ›è²·é€²"; elVerdict.style.color="#10b981"; }
            else if(finalScore>=60) { elVerdict.innerText="âœ… åå¤šæ“ä½œ"; elVerdict.style.color="#3b82f6"; }
            else if(finalScore>=40) { elVerdict.innerText="ğŸ‘€ è§€æœ›ç›¤æ•´"; elVerdict.style.color="#f59e0b"; }
            else { elVerdict.innerText="â›” é¢¨éšªæ¥µé«˜"; elVerdict.style.color="#ef4444"; }

            const cATR = atr[idx];
            document.getElementById('stPrice').innerText = p.toFixed(2);
            document.getElementById('stATR').innerText = cATR.toFixed(2);
            document.getElementById('stSL').innerText = (p - 3*cATR).toFixed(2);
            document.getElementById('stTP').innerText = (p + 6*cATR).toFixed(2);

            updateMetricsUI(scores, {trend:p>sma200[idx], vol:vR, rsi:rV, kd:{k:kV,d:dV}, macd:mH, price:p, prevPrice:C[idx-1], ma60:sma60[idx], ma200:sma200[idx]});
            
            // ç¹ªè£½å€‹è‚¡ä¸»åœ–è¡¨
            const showCount = Math.ceil(years * 260);
            const sliceStart = C.length - showCount;
            drawCharts(T.slice(sliceStart), C.slice(sliceStart), V.slice(sliceStart), sma5.slice(sliceStart), sma20.slice(sliceStart), sma60.slice(sliceStart), sma200.slice(sliceStart), {upper:bb.upper.slice(sliceStart), lower:bb.lower.slice(sliceStart)}, rsi.slice(sliceStart), {dif:macd.dif.slice(sliceStart), sig:macd.sig.slice(sliceStart), hist:macd.hist.slice(sliceStart)}, {K:kd.K.slice(sliceStart), D:kd.D.slice(sliceStart)}, fib);
            
            document.getElementById('mainLayout').style.opacity = '1';
            startCooldown(15);

        } catch (e) { 
            alert("éŒ¯èª¤: " + e.message); console.error(e); btn.disabled = false; 
        } finally { 
            loader.style.display = 'none'; 
        }
    }



    function loadTradingViewWidgets() {
        // 1. SPY Widget (å¤§ç›¤èµ°å‹¢)
        new TradingView.widget({
            "width": "100%", "height": "100%",
            "symbol": "AMEX:SPY", // æ˜ç¢ºæŒ‡å®šäº¤æ˜“æ‰€
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1", // è Ÿç‡­åœ–
            "locale": "zh_TW",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_top_toolbar": false, // é¡¯ç¤ºå·¥å…·åˆ—è®“ä½¿ç”¨è€…å¯ä»¥ç¸®æ”¾
            "allow_symbol_change": false,
            "container_id": "tv_chart_spy",
            "studies": [
                "MASimple@tv-basicstudies", 
                "MASimple@tv-basicstudies"  
            ] 
        });

        new TradingView.widget({
            "width": "100%", "height": "100%",
            "symbol": "VIXY", 
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "2", // ç·šåœ–
            "locale": "zh_TW",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_top_toolbar": false,
            "allow_symbol_change": false,
            "container_id": "tv_chart_vix",
            "studies": ["BollingerBands@tv-basicstudies"] // é¡¯ç¤ºå¸ƒæ—é€šé“
        });
    }





     function drawMacroCharts(spyData, vixData) {
        // è³‡æ–™è™•ç†æ ¸å¿ƒï¼šçµ±ä¸€è½‰ç‚º {L: æ—¥æœŸ, C: æ”¶ç›¤åƒ¹} æ ¼å¼
        const process = (d, name) => {
            if(!d || !d.values || d.values.length === 0) {
                console.warn(`${name} ç„¡æ•¸æ“šå¯ç¹ªåœ–`);
                return null;
            }
            // ç¢ºä¿æ•¸æ“šé †åºæ­£ç¢ºï¼šChart.js éœ€è¦ [èˆŠ -> æ–°]
            // TwelveData API é è¨­å›å‚³ [æ–° -> èˆŠ]ï¼ŒYahoo Proxy ç¶“éæˆ‘å€‘è™•ç†ä¹Ÿæ˜¯ [æ–° -> èˆŠ]
            // å› æ­¤é€™è£¡å¿…é ˆ reverse()
            const raw = [...d.values].reverse();
            
            // å–æœ€è¿‘ 120 å¤©ï¼Œé¿å…åœ–è¡¨å¤ªæ“ 
            const slice = raw.slice(-120);
            
            return {
                L: slice.map(x => x.datetime.substring(5)), // åªé¡¯ç¤º MM-DD
                C: slice.map(x => parseFloat(x.close)),
                Raw: slice.map(x => parseFloat(x.close)) // ç”¨æ–¼è¨ˆç®— MA
            };
        };

        const spy = process(spyData, "SPY");
        const vix = process(vixData, "VIX");

        if(!spy || !vix) return; // è‹¥ç„¡è³‡æ–™å‰‡ä¸­æ­¢

        // è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
        const spyMA50 = calcAvg(spy.Raw, 50);
        const spyMA200 = calcAvg(spy.Raw, 200);
        const vixMA5 = calcAvg(vix.Raw, 5);  // ç”¨æ–¼é¡¯ç¤ºå‹•èƒ½
        const vixMA20 = calcAvg(vix.Raw, 20);

        const opts = (title) => ({
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                title: { display: true, text: title, color: '#94a3b8', font:{size:12} },
                legend: { labels: { color: '#cbd5e1', boxWidth:10, font:{size:10} } } 
            },
            scales: { x: { display: false }, y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', font:{size:10} } } },
            elements: { point: { radius: 0, hoverRadius: 4 } }
        });

        // ç¹ªè£½ SPY
        if(charts.spy) charts.spy.destroy();
        charts.spy = new Chart(document.getElementById('cSPY'), {
            type: 'line',
            data: {
                labels: spy.L,
                datasets: [
                    { label: 'SPY', data: spy.C, borderColor: '#fff', borderWidth: 2 },
                    { label: 'MA50', data: spyMA50, borderColor: '#3b82f6', borderWidth: 1 },
                    { label: 'MA200', data: spyMA200, borderColor: '#f59e0b', borderWidth: 1 }
                ]
            }, options: opts('SPY Trend (200MA / 50MA)')
        });

        // ç¹ªè£½ VIX (é¡¯ç¤º 5MA vs 20MA å‹•èƒ½)
        if(charts.vix) charts.vix.destroy();
        charts.vix = new Chart(document.getElementById('cVIX'), {
            type: 'line',
            data: {
                labels: vix.L,
                datasets: [
                    { label: 'VIX', data: vix.C, borderColor: '#ef4444', borderWidth: 2 },
                    { label: '5MA(å‹•èƒ½)', data: vixMA5, borderColor: '#22d3ee', borderWidth: 1, borderDash:[2,2] },
                    { label: '20MA(è¶¨å‹¢)', data: vixMA20, borderColor: '#facc15', borderWidth: 1 }
                ]
            }, options: opts('VIX Momentum (5MA / 20MA)')
        });
    }





    function showFormula(type) {
        const modal = document.getElementById('scoreModal');
        const title = document.getElementById('mTitle');
        const weight = document.getElementById('mWeight');
        const list = document.getElementById('mFormula');
        
        list.innerHTML = '';
        modal.style.display = 'flex';

        if(type === 'Trend') {
            title.innerText = "é•·æœŸè¶¨å‹¢ (Trend)";
            weight.innerText = "æ¬Šé‡: 20%";
            list.innerHTML = `
                <li><b>åŸºç¤åˆ† (50åˆ†)</b></li>
                <li><b>ä¹–é›¢ç‡ä¿®æ­£ï¼š</b>ä¾æ“š (è‚¡åƒ¹ - 200MA) å·®è·ï¼Œæ¯ 1% å¢æ¸› 1 åˆ† (ä¸Šé™ Â±20åˆ†)</li>
                <li><b>å¤šé ­æ’åˆ—ï¼š</b>è‹¥ è‚¡åƒ¹ > 60MA (+10åˆ†)</li>
                <li><b>é»ƒé‡‘äº¤å‰ï¼š</b>è‹¥ 60MA > 200MA (+10åˆ†)</li>
            `;
        } else if(type === 'Pos') {
            title.innerText = "åƒ¹æ ¼ä½éš (Position)";
            weight.innerText = "æ¬Šé‡: 20%";
            list.innerHTML = `
                <li><b>å…¬å¼ï¼š</b>ä½¿ç”¨å¸ƒæ—é€šé“ %B æŒ‡æ¨™</li>
                <li><b>ä¾¿å®œï¼š</b>æ¥è¿‘é€šé“ä¸‹ç·£åˆ†æ•¸é«˜ (ç ´åº•çµ¦ 100åˆ†)</li>
                <li><b>æ˜‚è²´ï¼š</b>æ¥è¿‘é€šé“ä¸Šç·£åˆ†æ•¸ä½ (çªç ´çµ¦ 0åˆ†)</li>
                <li><b>ç·šæ€§è¨ˆç®—ï¼š</b>Score = 100 - (%B Ã— 100)</li>
            `;
        } else if(type === 'Vol') {
            title.innerText = "é‡åƒ¹åˆ†æ (Volume)";
            weight.innerText = "æ¬Šé‡: 15%";
            list.innerHTML = `
                <li><b>åŸºç¤åˆ† (50åˆ†)</b></li>
                <li><b>åƒ¹æ¼²é‡å¢ï¼š</b>æˆäº¤é‡ > å‡é‡ï¼Œå¤§å¹…åŠ åˆ† (+20åˆ†)</li>
                <li><b>åƒ¹æ¼²é‡ç¸®ï¼š</b>é‡åƒ¹èƒŒé›¢ï¼Œæ‰£åˆ† (-20åˆ†)</li>
                <li><b>åƒ¹è·Œé‡ç¸®ï¼š</b>æƒœå”®æ•´ç†ï¼Œå°åŠ åˆ† (+10åˆ†)</li>
                <li><b>åƒ¹è·Œé‡å¢ï¼š</b>ææ…Œæ‹‹å”®ï¼Œé‡æ‰£åˆ† (-20åˆ†)</li>
            `;
        } else if(type === 'RSI') {
            title.innerText = "RSI å‹•èƒ½";
            weight.innerText = "æ¬Šé‡: 15%";
            list.innerHTML = `
                <li><b>è¶…è³£å€ (<30)ï¼š</b>è¦–ç‚ºåå½ˆæ©Ÿæœƒï¼Œåˆ†æ•¸æé«˜ (æœ€é«˜ 80+30=110)</li>
                <li><b>è¶…è²·å€ (>70)ï¼š</b>è¦–ç‚ºéç†±é¢¨éšªï¼Œåˆ†æ•¸é™ä½ (æœ€ä½ 20-30=-10)</li>
                <li><b>ä¸­æ€§å€ (30-70)ï¼š</b>ç·šæ€§éæ¸›ï¼Œè¶Šä½åˆ†è¶Šé«˜</li>
            `;
        } else if(type === 'KD') {
            title.innerText = "KD æŒ‡æ¨™";
            weight.innerText = "æ¬Šé‡: 15%";
            list.innerHTML = `
                <li><b>åŸºç¤åˆ†ï¼š</b>é¡ä¼¼ RSIï¼Œä½æª”éˆåŒ–çµ¦é«˜åˆ†ï¼Œé«˜æª”éˆåŒ–çµ¦ä½åˆ†</li>
                <li><b>é»ƒé‡‘äº¤å‰ï¼š</b>K > D ä¸”æ˜¨æ—¥ K < D (+15åˆ†)</li>
                <li><b>æ­»äº¡äº¤å‰ï¼š</b>K < D ä¸”æ˜¨æ—¥ K > D (-15åˆ†)</li>
            `;
        } else if(type === 'MACD') {
            title.innerText = "MACD è¶¨å‹¢";
            weight.innerText = "æ¬Šé‡: 15%";
            list.innerHTML = `
                <li><b>å¤šé ­å¢å¼·ï¼š</b>ç´…æŸ±ä¸”è®Šé•· (70åˆ†)</li>
                <li><b>å¤šé ­æ¸›å¼±ï¼š</b>ç´…æŸ±ä½†è®ŠçŸ­ (55åˆ†)</li>
                <li><b>ç©ºé ­æ”¶æ–‚ï¼š</b>ç¶ æŸ±ä½†è®ŠçŸ­ (50åˆ†)</li>
                <li><b>ç©ºé ­å¢å¼·ï¼š</b>ç¶ æŸ±ä¸”è®Šé•· (30åˆ†)</li>
            `;
        }
    }

    function closeModal(e) { if(e.target.id === 'scoreModal') e.target.style.display = 'none'; }

     function updateMetricsUI(s, d) {
        
        // 1. é•·æœŸè¶¨å‹¢æ·±åº¦è§£æ
        const trendDist = ((d.price - d.ma200) / d.ma200 * 100).toFixed(2);
        let trendText = "";
        if(d.trend) {
            // å¤šé ­æƒ…å¢ƒ
            if(d.ma60 > d.ma200) trendText = `è‚¡åƒ¹ä½æ–¼å¹´ç·š(200MA)ä¹‹ä¸Š ${trendDist}%ï¼Œä¸”å­£ç·š(60MA)å·²é»ƒé‡‘äº¤å‰å¹´ç·šï¼Œå‘ˆç¾æ¨™æº–ã€Œå¤šé ­æ’åˆ—ã€ã€‚é•·æœŸå‡ç·šå‘ä¸ŠåŠ©æ¼²ï¼Œç±Œç¢¼ç©©å®šï¼Œé•·ç·šä¿è­·çŸ­ç·šæ•ˆæœé¡¯è‘—ã€‚`;
            else trendText = `è‚¡åƒ¹é›–ç«™ä¸Šå¹´ç·šï¼Œä½†å­£ç·šå°šæœªè·Ÿä¸Šï¼Œè™•æ–¼ã€Œåˆå‡æ®µã€æˆ–ã€Œéœ‡ç›ªç¯‰åº•ã€æœŸã€‚éœ€è§€å¯Ÿå­£ç·šæ˜¯å¦èƒ½é †åˆ©ç¿»æšæä¾›æ”¯æ’ï¼Œç›®å‰å¤šæ–¹åŠ›é“å°šæœªå®Œå…¨ç©©å›ºã€‚`;
        } else {
            // ç©ºé ­æƒ…å¢ƒ
            if(d.ma60 < d.ma200) trendText = `è‚¡åƒ¹ä½æ–¼å¹´ç·šä¹‹ä¸‹ ${Math.abs(trendDist)}%ï¼Œä¸”å‡ç·šå‘ˆç¾ã€Œç©ºé ­æ’åˆ—ã€ã€‚ä¸Šæ–¹å±¤å±¤å¥—ç‰¢è³£å£“æ²ˆé‡ï¼Œä»»ä½•åå½ˆè‡³å‡ç·šé™„è¿‘çš†æ˜“é­è§£å¥—è³£å£“æ‰“æ“Šï¼Œå»ºè­°ä¿å®ˆã€‚`;
            else trendText = `è‚¡åƒ¹è·Œç ´å¹´ç·šï¼Œä½†å­£ç·šä»åœ¨å¹´ç·šä¹‹ä¸Šï¼Œå‘ˆç¾ã€Œè¶¨å‹¢ç ´å£ã€ä¿®æ­£ã€‚è‹¥ç„¡æ³•åœ¨ 3 æ—¥å…§å¿«é€Ÿç«™å›ï¼Œæå½¢æˆé•·ç©ºä¸­ç¹¼ï¼Œé¢¨éšªæ¥µé«˜ã€‚`;
        }

        // 2. åƒ¹æ ¼ä½éšæ·±åº¦è§£æ
        const pb = (100 - s.pos) / 100; // é‚„åŸ %B
        let posText = "";
        if(pb > 1.0) posText = `å¸ƒæ—é€šé“ %B å€¼é” ${(pb*100).toFixed(0)}%ï¼Œè‚¡åƒ¹çªç ´ä¸Šè»Œã€‚æ­¤ç‚ºæ¥µå¼·å‹¢çš„ã€Œè»‹ç©ºè¡Œæƒ…ã€ï¼Œä½†ä¹Ÿä¼´éš¨ä¹–é›¢éå¤§é¢¨éšªã€‚è‹¥ç„¡é‡èƒ½é…åˆï¼Œéœ€æé˜²å‡çªç ´çœŸæ‹‰å›ã€‚`;
        else if(pb > 0.8) posText = `è‚¡åƒ¹é‹è¡Œæ–¼ä¸­è»Œèˆ‡ä¸Šè»Œé–“çš„ã€Œå¼·å‹¢æ•´ç†å€ã€ã€‚æ“ä½œå®œæ²¿ 20MA é †å‹¢æ“ä½œï¼Œåªè¦ä¸ç ´ä¸­è»Œï¼Œå¤šé ­å‹•èƒ½å»¶çºŒï¼Œæ˜¯å‹ç‡è¼ƒé«˜çš„ä½éšã€‚`;
        else if(pb < 0) posText = `å¸ƒæ—é€šé“ %B ç‚ºè² ï¼Œè‚¡åƒ¹è·Œç ´ä¸‹è»Œã€‚å¸‚å ´å‡ºç¾éç†æ€§ã€Œææ…Œæ‹‹å”®ã€ï¼Œéš¨æ™‚å¯èƒ½å‡ºç¾ã€Œå ±å¾©æ€§åå½ˆã€ï¼Œä½†éœ€æ³¨æ„æ˜¯å¦ç‚ºé‡å¤§åˆ©ç©ºå°è‡´çš„å´©ç›¤ã€‚`;
        else if(pb < 0.2) posText = `è‚¡åƒ¹ä½æ–¼ä¸‹è»Œé™„è¿‘ï¼Œä½éšä¾¿å®œä½†èµ°å‹¢ç–²å¼±ã€‚æ­¤å€å±¬ã€Œå·¦å´äº¤æ˜“ã€è§€å¯Ÿå€ï¼Œéœ€ç­‰å¾…é•·ç´… K æ£’è¡¨æ…‹æ­¢è·Œï¼Œå¦å‰‡å¯èƒ½æ²¿ä¸‹è»ŒæŒçºŒç›¤è·Œã€‚`;
        else posText = `è‚¡åƒ¹ä½æ–¼å¸ƒæ—é€šé“ä¸­æ€§å€é–“ï¼Œæ–¹å‘æœªæ˜ã€‚å»ºè­°æ¸›å°‘é€²å‡ºï¼Œç­‰å¾…çªç ´ä¸Šè»Œæˆ–å›æ¸¬ä¸‹è»Œæœ‰æ’å¾Œå†è¡Œä½ˆå±€ã€‚`;

        // 3. é‡åƒ¹åˆ†ææ·±åº¦è§£æ
        let volText = "";
        const vRatio = d.vol.toFixed(2);
        if(d.price > d.prevPrice) { 
            if(d.vol > 1.2) volText = `å‘ˆç¾ã€Œåƒ¹æ¼²é‡å¢ã€å¥åº·æ ¼å±€ï¼Œæˆäº¤é‡ç‚ºå‡é‡ ${vRatio} å€ã€‚ä¸»åŠ›è³‡é‡‘ç©æ¥µæ›æ‰‹ï¼Œæ”»æ“Šæ„é¡˜å¼·ï¼Œæœ‰åˆ©å¾ŒçºŒæŒ‘æˆ°æ–°é«˜ã€‚`;
            else if(d.vol < 0.8) volText = `å‘ˆç¾ã€Œåƒ¹æ¼²é‡ç¸®ã€èƒŒé›¢ã€‚è¿½åƒ¹æ„é¡˜ä¸è¶³æˆ–ä¸»åŠ›é–ç¢¼ï¼Œè‹¥å¾ŒçºŒç„¡æ³•è£œé‡ï¼Œéœ€æé˜²å¤šé ­åŠ›ç«­çš„æ‹‰å›é¢¨éšªã€‚`;
            else volText = `åƒ¹æ¼²ä¸”é‡èƒ½æº«å’Œï¼Œå±¬æ–¼ã€Œé©šé©šæ¼²ã€çš„ç©©å¥æ¨å‡æ ¼å±€ï¼Œç±Œç¢¼æœªå¤±æ§ï¼Œæœ‰åˆ©è¶¨å‹¢å»¶çºŒã€‚`;
        } else {
            if(d.vol > 1.2) volText = `å‘ˆç¾ã€Œåƒ¹è·Œé‡å¢ã€ï¼Œæˆäº¤é‡æ”¾å¤§è‡³ ${vRatio} å€ã€‚é¡¯ç¤ºå‡ºç¾ææ…Œæ€§åœææˆ–ç²åˆ©äº†çµè³£å£“ï¼Œç©ºæ–¹åŠ›é“å¼·ï¼Œåº•éƒ¨æé›£æµ®ç¾ã€‚`;
            else volText = `å‘ˆç¾ã€Œåƒ¹è·Œé‡ç¸®ã€ï¼Œè³£å£“é€æ¼¸è¡°ç«­ï¼Œå¸‚å ´å‡ºç¾æƒœå”®å¿ƒç†ã€‚è‹¥å¾ŒçºŒèƒ½å‡ºç¾é‡å¢ç´…Kï¼Œæœ‰æ©Ÿæœƒå½¢æˆçŸ­æœŸåº•éƒ¨ã€‚`;
        }

        // 4. RSI è§£æ
        let rsiText = "";
        const rsiVal = d.rsi.toFixed(1);
        if(d.rsi >= 75) rsiText = `RSI(${rsiVal}) é€²å…¥ã€Œéç†±å€ã€ã€‚é›–å¤šé ­æ°£å‹¢å¼·ï¼Œä½†çŸ­ç·šä¹–é›¢éå¤§ã€‚è‹¥è‚¡åƒ¹å‰µé«˜ä½† RSI æœªå‰µé«˜(èƒŒé›¢)ï¼Œç‚ºå¼·çƒˆå›æª”è¨Šè™Ÿã€‚`;
        else if(d.rsi <= 25) rsiText = `RSI(${rsiVal}) é€²å…¥ã€Œè¶…è³£å€ã€ã€‚å¸‚å ´æƒ…ç·’æ¥µåº¦æ‚²è§€ï¼Œä¾é˜æ“ºæ•ˆæ‡‰ï¼Œéš¨æ™‚å¯èƒ½å‡ºç¾æŠ€è¡“æ€§åå½ˆï¼Œä¸å®œè¿½ç©ºã€‚`;
        else if(d.rsi >= 50) rsiText = `RSI(${rsiVal}) ä½æ–¼å¤šæ–¹æ”»æ“Šå€ (50-75)ã€‚å‹•èƒ½å……æ²›ä¸”æœªéç†±ï¼Œæ˜¯è¶¨å‹¢äº¤æ˜“è€…æœ€èˆ’é©çš„æŒè‚¡å€é–“ã€‚`;
        else rsiText = `RSI(${rsiVal}) ä½æ–¼ç©ºæ–¹æŠµæŠ—å€ (<50)ã€‚åå½ˆåŠ›é“ç–²å¼±ï¼Œä»»ä½•åå½ˆè‡³ 50 é™„è¿‘è‹¥ç„¡æ³•çªç ´ï¼Œçš†æ˜¯æ¸›ç¢¼æ™‚æ©Ÿã€‚`;

        // 5. KD è§£æ
        let kdText = "";
        const kVal = d.kd.k.toFixed(1);
        if(d.kd.k > d.kd.d) kdText = `KD é»ƒé‡‘äº¤å‰ (K=${kVal} > D)ã€‚çŸ­ç·šå‹•èƒ½è½‰å¼·ã€‚è‹¥äº¤å‰ç™¼ç”Ÿåœ¨ 20 ä»¥ä¸‹ä½æª”å€ï¼Œæº–ç¢ºåº¦é«˜ï¼›è‹¥åœ¨ 80 ä»¥ä¸Šï¼Œå¯èƒ½ç‚ºèª˜å¤šæˆ–éˆåŒ–è»‹ç©ºã€‚`;
        else kdText = `KD æ­»äº¡äº¤å‰ (K=${kVal} < D)ã€‚çŸ­ç·šè½‰å¼±ä¿®æ­£ã€‚è‹¥äº¤å‰ç™¼ç”Ÿåœ¨ 80 ä»¥ä¸Šé«˜æª”å€ï¼Œæ‡‰ç«‹å³åœåˆ©ï¼›è‹¥åœ¨ 20 ä»¥ä¸‹éˆåŒ–ï¼Œéœ€è§€å¯Ÿåº•éƒ¨èƒŒé›¢ã€‚`;

        // 6. MACD è§£æ
        let macdText = "";
        const osc = d.macd.toFixed(3);
        if(d.macd > 0) macdText = `MACD æŸ±ç‹€é«”æ­£å€¼(${osc})ï¼Œå¤šé ­æ§ç›¤ã€‚è‹¥ç´…æŸ±æŒçºŒæ”¾å¤§ï¼Œä»£è¡¨è™•æ–¼ä¸»å‡æ®µæ”»æ“Šï¼›è‹¥ç´…æŸ±ç¸®çŸ­ï¼Œé¡¯ç¤ºæ¼²å‹¢è¶¨ç·©ï¼Œå¯èƒ½è½‰ç‚ºæ©«ç›¤éœ‡ç›ªã€‚`;
        else macdText = `MACD æŸ±ç‹€é«”è² å€¼(${osc})ï¼Œç©ºé ­æ§ç›¤ã€‚è‹¥ç¶ æŸ±æŒçºŒæ”¾å¤§ï¼Œä»£è¡¨æ€¥æ®ºæ®µï¼Œä¸å¯æ¥åˆ€ï¼›è‹¥ç¶ æŸ±æ”¶æ–‚ï¼Œé¡¯ç¤ºç©ºæ–¹åŠ›é“è¡°ç«­ï¼Œé†é‡€æ­¢è·Œã€‚`;

        // è¼”åŠ©å‡½æ•¸
        const createMetric = (key, title, score, status, logic) => `
            <div class="metric-card">
                <div class="metric-top">
                    <span class="metric-title">${title}</span>
                    <div class="metric-score-box" onclick="showFormula('${key}')">${score} åˆ†</div>
                </div>
                <div class="bar-bg"><div class="bar-fill" style="width:${score}%; background:${score>=70?'#10b981':(score<=30?'#ef4444':'#f59e0b')}"></div></div>
                <div class="metric-status" style="color:${score>=70?'#10b981':(score<=30?'#ef4444':'#f59e0b')}">â¤ ç‹€æ…‹ï¼š${status}</div>
                <div class="metric-logic" style="margin-top:5px; padding-top:5px; border-top:1px dashed #334155; font-size:0.85rem; color:#cbd5e1; line-height:1.6;">${logic}</div>
            </div>`;
        
        const html = 
            createMetric("Trend", "é•·æœŸè¶¨å‹¢ (Trend)", s.trend, d.trend?"å¤šé ­æ¶æ§‹":"ç©ºé ­æ¶æ§‹", trendText) +
            createMetric("Pos", "åƒ¹æ ¼ä½éš (Position)", s.pos, s.pos>=80?"ç›¸å°ä¾¿å®œ":s.pos<=20?"ç›¸å°æ˜‚è²´":"åˆç†å€é–“", posText) +
            createMetric("Vol", "é‡åƒ¹åˆ†æ (Volume)", s.vol, d.vol>1?"é‡èƒ½æ”¾å¤§":"é‡èƒ½èç¸®", volText) +
            createMetric("RSI", "RSI å‹•èƒ½å¼·å¼±", s.rsi, d.rsi>70?"éç†±å€":d.rsi<30?"è¶…è³£å€":"ä¸­æ€§å€", rsiText) +
            createMetric("KD", "KD éš¨æ©ŸæŒ‡æ¨™", s.kd, d.kd.k>d.kd.d?"é»ƒé‡‘äº¤å‰":"æ­»äº¡äº¤å‰", kdText) +
            createMetric("MACD", "MACD è¶¨å‹¢æŒ‡æ¨™", s.macd, d.macd>0?"å¤šæ–¹æ§ç›¤":"ç©ºæ–¹æ§ç›¤", macdText);
            
        document.getElementById('metricsContainer').innerHTML = html;
    }



     function analyzeMacroConditions(spyData, vixData) {
        let details = []; let totalImpact = 0;

        // --- çµ±è¨ˆå­¸æ ¸å¿ƒé‹ç®— ---
        // è¨ˆç®—æ­·å²æ³¢å‹•ç‡ (Historical Volatility)
        const calcHV = (prices, window=20) => {
            let logReturns = [];
            for(let i=1; i<prices.length; i++) logReturns.push(Math.log(prices[i]/prices[i-1]));
            let hvs = [];
            for(let i=window; i<logReturns.length; i++) {
                let slice = logReturns.slice(i-window, i);
                let mean = slice.reduce((a,b)=>a+b,0)/window;
                let sqDiff = slice.map(x => Math.pow(x-mean, 2)).reduce((a,b)=>a+b,0);
                hvs.push(Math.sqrt(sqDiff/window) * Math.sqrt(252) * 100);
            }
            return hvs;
        };
        // è¨ˆç®—æ¨™æº–åˆ†æ•¸ (Z-Score)
        const calcZScore = (cur, hist) => {
            const mean = hist.reduce((a,b)=>a+b,0)/hist.length;
            const sqDiff = hist.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b,0);
            const std = Math.sqrt(sqDiff/hist.length);
            return (cur - mean) / std;
        };

        const getRaw = (d) => [...d.values].reverse().map(x=>parseFloat(x.close));
        const getBB = (d, n=20) => { const sma=calcAvg(d,n), idx=d.length-1; let ss=0; for(let i=0;i<n;i++)ss+=Math.pow(d[idx-i]-sma[idx],2); const std=Math.sqrt(ss/n); return {mid:sma[idx], upper:sma[idx]+2*std}; };

        // 1. SPY å¤§ç›¤æ·±åº¦åˆ†æ
        if(spyData.values) {
            const raw = getRaw(spyData);
            const idx = raw.length-1, p = raw[idx];
            const ma20 = calcAvg(raw,20)[idx], ma60 = calcAvg(raw,60)[idx], ma200 = calcAvg(raw,200)[idx];
            
            // æ³¢å‹•ç‡è¨ˆç®—
            const hvSeries = calcHV(raw, 20);
            const curHV = hvSeries[hvSeries.length-1];
            const hvZ = calcZScore(curHV, hvSeries.slice(-200));

            // A1. é•·æœŸè¶¨å‹¢ (å¹´ç·šä¹–é›¢)
            const bias200 = ((p - ma200)/ma200)*100;
            let r1 = {name:`é•·æœŸè¶¨å‹¢ (å¹´ç·šä¹–é›¢ ${bias200.toFixed(1)}%)`, val:p.toFixed(2)};
            if(bias200 > 5) { r1.status="å¼·å‹¢å¤šé ­"; r1.score=5; r1.class="tag-pos"; }
            else if(bias200 > 0) { r1.status="å¤šé ­æ”¯æ’"; r1.score=2; r1.class="tag-pos"; }
            else if(bias200 > -5) { r1.status="è½‰å¼±ä¿®æ­£"; r1.score=-5; r1.class="tag-neg"; }
            else { r1.status="æ·±ä¸è¦‹åº•"; r1.score=-15; r1.class="tag-neg"; }
            details.push(r1); totalImpact += r1.score;

            // A2. çŸ­ç·šä¹–é›¢ (æœˆç·š 20MA) - æ–°å¢
            const bias20 = ((p - ma20)/ma20)*100;
            let r2 = {name:`çŸ­ç·šç†±åº¦ (æœˆç·šä¹–é›¢ ${bias20.toFixed(1)}%)`, val:bias20 > 0 ? "æœˆç·šä¹‹ä¸Š" : "æœˆç·šä¹‹ä¸‹"};
            if(bias20 > 3) { r2.status="çŸ­ç·šéç†±"; r2.score=0; r2.class="tag-neu"; } // éç†±ä¸åŠ åˆ†
            else if(bias20 > 0) { r2.status="çŸ­å¤šå¼·å‹¢"; r2.score=3; r2.class="tag-pos"; }
            else { r2.status="çŸ­ç·šæ•´ç†"; r2.score=-2; r2.class="tag-neu"; }
            details.push(r2); totalImpact += r2.score;

            // A3. ä¸­æœŸæ¶æ§‹ (å­£ç·š vs å¹´ç·š) - æ–°å¢
            let r3 = {name:"ä¸­æœŸæ¶æ§‹ (60MA vs 200MA)", val: ma60>ma200 ? "å¤šé ­æ’åˆ—" : "ç©ºé ­æ’åˆ—"};
            if(ma60 > ma200) { r3.status="åŠ©æ¼²æ ¼å±€"; r3.score=3; r3.class="tag-pos"; }
            else { r3.status="åŠ©è·Œæ ¼å±€"; r3.score=-5; r3.class="tag-neg"; }
            details.push(r3); totalImpact += r3.score;

            // A4. å¸‚å ´æ³¢å‹•ç•°å¸¸ (Z-Score)
            let r4 = {name:`å¸‚å ´æ³¢å‹• (Z-Score ${hvZ.toFixed(1)})`, val:`HV:${curHV.toFixed(1)}%`};
            if(hvZ > 2.5) { r4.status="æ¥µç«¯ææ…Œ"; r4.score=-8; r4.class="tag-neg"; }
            else if(hvZ > 1.5) { r4.status="æ³¢å‹•ç•°å¸¸"; r4.score=-4; r4.class="tag-neg"; }
            else { r4.status="æ³¢å‹•æ­£å¸¸"; r4.score=2; r4.class="tag-pos"; }
            details.push(r4); totalImpact += r4.score;
        }

        // 2. VIX ææ…ŒæŒ‡æ•¸æ·±åº¦åˆ†æ
        if(vixData.values) {
            const raw = getRaw(vixData);
            const idx = raw.length-1, v = raw[idx];
            const ma5 = calcAvg(raw, 5)[idx], ma20 = calcAvg(raw, 20)[idx];
            const bb = getBB(raw, 20);

            // B1. çµ•å°æ°´ä½ (ç´šè·è©•åˆ†)
            let r5 = {name:"ææ…Œæ°´ä½ (VIX Level)", val:v.toFixed(2)};
            if(v > 35) { r5.status="å´©ç›¤ææ…Œ (>35)"; r5.score=-12; r5.class="tag-neg"; }
            else if(v > 25) { r5.status="é«˜åº¦ææ…Œ (>25)"; r5.score=-8; r5.class="tag-neg"; }
            else if(v > 20) { r5.status="é¿éšªå‡æº« (>20)"; r5.score=-4; r5.class="tag-neg"; }
            else if(v < 15) { r5.status="æ¨‚è§€å¹³ç©© (<15)"; r5.score=2; r5.class="tag-pos"; }
            else { r5.status="æ­£å¸¸æ³¢å‹•"; r5.score=0; r5.class="tag-neu"; }
            details.push(r5); totalImpact += r5.score;

            // B2. ææ…Œå‹•èƒ½ (å…·é«”åŒ–ï¼š5MA vs 20MA)
            // èªªæ˜ï¼š5æ—¥ç·šä»£è¡¨çŸ­æœŸæƒ…ç·’ï¼Œ20æ—¥ç·šä»£è¡¨ä¸­æœŸå¹³å‡ã€‚5æ—¥ç·šè¡é20æ—¥ç·šä»£è¡¨ææ…Œæ­£åœ¨ã€ŒåŠ é€Ÿã€
            let r6 = {name:"ææ…Œå‹•èƒ½ (VIX 5MA vs 20MA)", val: ma5.toFixed(2) + (ma5>ma20?" > ":" < ") + ma20.toFixed(2)};
            if(ma5 > ma20) {
                // é»ƒé‡‘äº¤å‰ï¼šææ…ŒåŠ é€Ÿä¸­
                r6.status="âš ï¸ åŠ é€Ÿå‡æº«"; r6.score=-5; r6.class="tag-neg";
            } else {
                // æ­»äº¡äº¤å‰ï¼šææ…Œé™æº«ä¸­
                r6.status="âœ… æƒ…ç·’é™æº«"; r6.score=3; r6.class="tag-pos";
            }
            details.push(r6); totalImpact += r6.score;

            // B3. ç³»çµ±æ€§é¢¨éšª (å¸ƒæ—çªç ´)
            let r7 = {name:"å´©ç›¤é è­¦ (VIX BB Break)", val: v>bb.upper ? "çªç ´ä¸Šè»Œ" : "å€é–“å…§"};
            if(v > bb.upper) { r7.status="ç³»çµ±æ€§å´©ç›¤"; r7.score=-15; r7.class="tag-neg"; } // é‡ç½°
            else { r7.status="æœªçªç ´"; r7.score=0; r7.class="tag-neu"; }
            details.push(r7); totalImpact += r7.score;
        }

        return { details, totalImpact };
    }






    function updateMacroUI(res) {
        const tbody = document.getElementById('macroTableBody'); 
        tbody.innerHTML = '';
        res.details.forEach(i => {
            let color = i.score > 0 ? '#10b981' : (i.score < 0 ? '#ef4444' : '#cbd5e1');
            let sign = i.score > 0 ? '+' : '';
            tbody.innerHTML += `
                <tr>
                    <td style="padding:10px;">${i.name}</td>
                    <td style="font-family:monospace; color:#e2e8f0;">${i.val}</td>
                    <td><span class="score-tag ${i.class}" style="font-size:0.8rem;">${i.status}</span></td>
                    <td style="font-weight:bold; color:${color}; text-align:right; padding-right:15px;">${sign}${i.score}</td>
                </tr>`;
        });
        
        const total = res.totalImpact;
        const impBox = document.getElementById('impactVal');
        impBox.innerText = (total > 0 ? "+" : "") + total;
        impBox.style.color = total > 0 ? "#10b981" : (total < 0 ? "#ef4444" : "#cbd5e1");
    }


    function drawCharts(L, P, V, MA5, MA20, MA60, MA200, BB, RSI, MACD, KD, FIB) {
        // å…ˆéŠ·æ¯€èˆŠåœ–è¡¨
        Object.values(charts).forEach(c => c?.destroy());

        // å®šç¾©åŒæ­¥ç¸®æ”¾å‡½å¼
        const syncScale = (chart) => {
            const min = chart.scales.x.min;
            const max = chart.scales.x.max;
            
            // éæ­·æ‰€æœ‰åœ–è¡¨é€²è¡ŒåŒæ­¥
            [charts.main, charts.kd, charts.rsi, charts.macd].forEach(c => {
                if (c && c !== chart) {
                    c.options.scales.x.min = min;
                    c.options.scales.x.max = max;
                    c.update('none'); // ä½¿ç”¨ 'none' æ¨¡å¼é¿å…å‹•ç•«å»¶é²ï¼Œè®“é€£å‹•æ›´é †æš¢
                }
            });
        };

        // é€šç”¨è¨­å®š (åŠ å…¥ Zoom é…ç½®)
        const commonOpt = {
            responsive: true, 
            maintainAspectRatio: false, 
            interaction: { mode: 'index', intersect: false },
            scales: { 
                x: { display: false }, // Xè»¸æ–‡å­—éš±è—ï¼Œä½†åˆ»åº¦å­˜åœ¨
                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } } 
            },
            plugins: { 
                legend: { labels: { color: '#cbd5e1' } },
                // â˜… Zoom æ’ä»¶è¨­å®š
                zoom: {
                    pan: {
                        enabled: true,
                        mode: 'x', // åªèƒ½å·¦å³æ‹–æ›³
                        onPan: ({chart}) => syncScale(chart) // æ‹–æ›³æ™‚åŒæ­¥
                    },
                    zoom: {
                        wheel: { enabled: true }, // å•Ÿç”¨æ»‘é¼ æ»¾è¼ª
                        pinch: { enabled: true }, // å•Ÿç”¨è§¸æ§ç¸®æ”¾
                        mode: 'x', // åªèƒ½ç¸®æ”¾ X è»¸ (æ™‚é–“è»¸)
                        onZoom: ({chart}) => syncScale(chart) // ç¸®æ”¾æ™‚åŒæ­¥
                    }
                }
            }
        };

        const maxV = Math.max(...V);
        
        // 1. ä¸»åœ–è¡¨
        charts.main = new Chart(document.getElementById('cMain'), { 
            type: 'line', 
            data: {
                labels: L,
                datasets: [
                    {label:'Price', data:P, borderColor:'#fff', borderWidth:2, pointRadius:0, yAxisID:'y', order:1},
                    {label:'MA5', data:MA5, borderColor:'#e879f9', borderWidth:1, pointRadius:0, yAxisID:'y', order:2},
                    {label:'MA20', data:MA20, borderColor:'#22d3ee', borderWidth:1, pointRadius:0, yAxisID:'y', order:2},
                    {label:'MA60', data:MA60, borderColor:'#3b82f6', borderWidth:1, pointRadius:0, yAxisID:'y', order:2},
                    {label:'MA200', data:MA200, borderColor:'#f59e0b', borderWidth:2, pointRadius:0, yAxisID:'y', order:3},
                    {label:'BB U', data:BB.upper, borderColor:'rgba(16,185,129,0.4)', borderWidth:1, pointRadius:0, fill:false, yAxisID:'y', order:4},
                    {label:'BB L', data:BB.lower, borderColor:'rgba(16,185,129,0.4)', borderWidth:1, pointRadius:0, fill:false, yAxisID:'y', order:5},
                    {type:'bar', label:'Vol', data:V, backgroundColor:'rgba(255,255,255,0.1)', yAxisID:'y1', order:6}
                ]
            }, 
            options: {
                ...commonOpt, 
                scales: {
                    // ä¸»åœ–é¡¯ç¤º X è»¸åˆ»åº¦
                    x: { ticks: { color: '#94a3b8', maxTicksLimit: 12 }, grid: { color: '#334155' } },
                    y: { position: 'left', grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    y1: { position: 'right', min: 0, max: maxV*4, display: false }
                }, 
                plugins: {
                    ...commonOpt.plugins,
                    annotation: {
                        annotations: {
                            f6:{type:'line',yMin:FIB.f618,yMax:FIB.f618,borderColor:'rgba(16,185,129,0.6)',borderDash:[4,4],borderWidth:1,label:{display:true,content:'Fib .618',position:'end',color:'#10b981',font:{size:10}}},
                            f5:{type:'line',yMin:FIB.f500,yMax:FIB.f500,borderColor:'rgba(245,158,11,0.6)',borderDash:[4,4],borderWidth:1,label:{display:true,content:'Fib .5',position:'end',color:'#f59e0b',font:{size:10}}}
                        }
                    }
                }
            } 
        });
        
        // 2. KD åœ–è¡¨
        charts.kd = new Chart(document.getElementById('cKD'), { 
            type: 'line', 
            data: { labels:L, datasets:[{label:'K',data:KD.K,borderColor:'#facc15',pointRadius:0},{label:'D',data:KD.D,borderColor:'#a855f7',pointRadius:0}] }, 
            options: {
                ...commonOpt, 
                plugins: {
                    ...commonOpt.plugins,
                    annotation: {annotations:{l1:{type:'line',yMin:80,yMax:80,borderColor:'red',borderDash:[2,2]},l2:{type:'line',yMin:20,yMax:20,borderColor:'green',borderDash:[2,2]}}}
                }
            }
        });

        // 3. RSI åœ–è¡¨
        charts.rsi = new Chart(document.getElementById('cRSI'), { 
            type: 'line', 
            data: { labels:L, datasets:[{label:'RSI',data:RSI,borderColor:'#38bdf8',pointRadius:0}] }, 
            options: {
                ...commonOpt, 
                scales:{...commonOpt.scales, y:{min:0,max:100}}, 
                plugins: {
                    ...commonOpt.plugins,
                    annotation: {annotations:{l1:{type:'line',yMin:70,yMax:70,borderColor:'red',borderDash:[2,2]},l2:{type:'line',yMin:30,yMax:30,borderColor:'green',borderDash:[2,2]}}}
                }
            }
        });

        // 4. MACD åœ–è¡¨
        charts.macd = new Chart(document.getElementById('cMACD'), { 
            type: 'bar', 
            data: {
                labels:L, 
                datasets:[
                    {type:'line',label:'DIF',data:MACD.dif,borderColor:'#3b82f6',pointRadius:0},
                    {type:'line',label:'Sig',data:MACD.sig,borderColor:'#f59e0b',pointRadius:0},
                    {label:'Hist',data:MACD.hist,backgroundColor:c=>c.raw>=0?'#10b981':'#ef4444'}
                ]
            }, 
            options: commonOpt 
        });
    }


    function clamp(n) { return Math.min(100, Math.max(0, Math.round(n))); }
    function startCooldown(sec) { countdown = sec; const btn = document.getElementById('btnStart'); const timer = setInterval(() => { btn.innerText = `å†·å»ä¸­ (${countdown}s)`; countdown--; if(countdown < 0) { clearInterval(timer); btn.innerText="Run Model"; btn.disabled=false; } }, 1000); } </script>

</body>
</html>

