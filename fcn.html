<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCN Analysis Terminal - Backtest Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
 
    <style>
        :root {
            --bg-color: #f4f7fa;
            --card-bg: #ffffff;
            --primary: #1a73e8;
            --text-main: #202124;
            --text-sub: #5f6368;
            --border: #dadce0;
            --accent: #e8f0fe;
            --danger: #d93025;
            --success: #188038;
            --warning: #f29900;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-main); padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: var(--primary); text-align: left; font-size: 1.8rem; margin-bottom: 25px; font-weight: 500; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        h3 { color: var(--text-main); font-weight: 500; margin-top: 0;}
        .config-panel { background: var(--card-bg); padding: 25px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(60,64,67,.3); border: 1px solid var(--border); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; }
        input, select { background: #fff; border: 1px solid var(--border); color: var(--text-main); padding: 10px; border-radius: 4px; font-size: 0.9rem; transition: border 0.2s; }
        button { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 1rem; font-weight: 600; margin-top: 20px; transition: background 0.2s; }
        button:hover { background: #1557b0; }
        #loading { display: none; text-align: center; margin: 20px 0; color: var(--primary); font-weight: bold; }
        .result-section { display: none; margin-top: 20px; }
     
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.04);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
    text-align: center; 
    display: flex;
    flex-direction: column;
    align-items: center;
        }
        .metric-card:hover { transform: translateY(-2px); }
        .metric-card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary);
        }
        .metric-card.orange::before { background: var(--warning); }
        .metric-card.green::before { background: var(--success); }
        .metric-header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; width: 100%;}
        .metric-title { font-size: 1rem; color: var(--text-sub); font-weight: 700; letter-spacing: 0.5px; }
        .metric-icon { font-size: 1.2rem; opacity: 0.7; }
        .metric-value { display: block; font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 5px 0; }
        .metric-subtext { font-size: 0.75rem; color: var(--text-sub); margin-top: 5px; font-weight: 400; }
.metric-card:has(#avgReturn) {display: none;}

        .vol-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border); width: 100%; }
        .vol-item { text-align: center; }
        .vol-symbol { font-size: 0.7rem; font-weight: 700; color: var(--text-sub); display: block; }
        .vol-num { font-size: 0.9rem; font-weight: 700; color: var(--primary); }
        .mc-main-charts { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .double-column-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
     
        .card-wrapper { background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(60,64,67,.1); position: relative;}
        .chart-h350 { height: 350px; }
        .chart-auto { min-height: 250px; }
        #techOptions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; margin-bottom: 25px; padding: 10px; background: #eee; border-radius: 8px; }
        .tech-option { background: #fff; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; color: var(--text-sub); border: 1px solid var(--border); font-weight: 500; transition: all 0.2s; }
        .tech-option.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .tech-option.level-toggle { border-color: var(--warning); color: var(--warning); }
        .tech-option.level-toggle.active { background: var(--warning); color: #fff; border-color: var(--warning); }
        .tech-option input { display: none; }
        .stock-charts-area { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .stock-card { background: var(--card-bg); padding: 25px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(60,64,67,.1); }
        .canvas-container { height: 420px; width: 100%; margin-top: 15px; cursor: crosshair; }
        .stats-panel { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-box { background: var(--accent); padding: 12px; border-radius: 6px; text-align: center; border: 1px solid rgba(26,115,232,0.1); }
        .stat-label { font-size: 0.7rem; color: var(--text-sub); display: block; margin-bottom: 5px; font-weight: 600; }
        .stat-num { font-size: 1.1rem; font-weight: bold; color: var(--text-main); }
     
        .heatmap-container { display: flex; justify-content: center; padding: 10px 0; width: 100%; }
        .heatmap-grid { display: grid; gap: 8px; }
        .heatmap-cell { width: 65px; height: 65px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; color: white; border-radius: 6px; }
        .heatmap-label { font-size: 0.8rem; font-weight: 600; color: var(--text-sub); text-align: center; padding: 5px; }
        .backtest-list { list-style: none; padding: 0; margin: 15px 0; }
        .backtest-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .backtest-item:last-child { border-bottom: none; }
        .bt-label { color: var(--text-sub); font-weight: 500; }
        .bt-value { font-weight: bold; }
 
        .analysis-grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .long-term-panel { background: #fff; border: 1px solid var(--primary); border-radius: 8px; padding: 15px; margin-top: 20px; }
        .safety-analysis-panel { background: #fff; border: 1px solid var(--danger); border-radius: 8px; padding: 15px; }
        .recovery-analysis-panel { background: #fff; border: 1px solid #673ab7; border-radius: 8px; padding: 15px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Fixed Coupon Note (FCN) Analysis Terminal</h1>
    <div class="config-panel">
        <div class="grid">
            <div class="input-group"><label>API Key</label><input type="text" id="apiKey" value="d7de0902b30e47dead805e170f78bac6"></div>
            <div class="input-group"><label>股票代號 (1-3檔,用逗號分隔)</label><input type="text" id="symbols" value="TSLA,TSM,NVDA"></div>
            <div class="input-group"><label>天期 (1-12月)</label><input type="number" id="months" value="6"></div>
            <div class="input-group"><label>履約價 Strike (%)</label><input type="number" id="strikePct" value="75"></div>
            <div class="input-group"><label>年化配息率 Coupon (%)</label><input type="number" id="coupon" value="15" step="0.01"></div>
            <div class="input-group"><label>提前出場價 KO (%)</label><input type="number" id="koPct" value="100"></div>
            <div class="input-group"><label>保證領息期間 (月)</label><input type="number"id="guaranteedMonths" value="1" min="1"></div>
            <div class="input-group"><label>下限價 KI (%)</label><input type="number" id="kiPct" value="60"></div>
            <div class="input-group"><label>下限價觀察頻率 KI Freq</label><select id="kiType"><option value="AKI">AKI(每日觀察)</option><option value="EKI">EKI(到期觀察)</option></select></div>
            <div class="input-group"><label>模擬次數 Simulations</label><input type="number" id="simN" value="10000"></div>
            <div class="input-group">
                <label>技術分析期間 (年)</label>
                <select id="chartYears">
                    <option value="1">1 Year</option>
                    <option value="2">2 Years</option>
                    <option value="3">3 Years</option>
                    <option value="5" selected>5 Years</option>
                    <option value="10">10 Years</option>
                </select>
            </div>
       </div>
        <button id="runBtn">Generate Quantitative Analysis</button>
        <div id="loading">Calculating volatility, correlation and history...</div>
    </div>
    <div id="result-section" class="result-section">
        <div class="metrics">
<div class="metric-card" style="display: none;">
    <div class="metric-header">
        <span class="metric-title">EXPECTED PAYOFF</span>
        <span class="metric-icon">💰</span>
    </div>
    <span id="avgReturn" class="metric-value">-</span>
    <div class="metric-subtext">預期總價值 (含息/折現)</div>
</div>
            <div class="metric-card orange">
                <div class="metric-header">
                    <span class="metric-title">平均存續期間 AVG DURATION</span>
                    <span class="metric-icon">⏳</span>
                </div>
                <span id="avgPeriod" class="metric-value">-</span>
                <div class="metric-subtext">預期存續天數 (含提前出場機率)</div>
            </div>
            <div class="metric-card green">
                <div class="metric-header">
                    <span class="metric-title">歷史波動度 HISTORICAL VOLATILITY</span>
                    <span id="volPeriodLabel" style="font-size:0.7rem; color:var(--text-sub);">(-)</span>
                </div>
                <div id="volList" class="vol-grid">
                    <div class="vol-item"><span class="vol-symbol">N/A</span><span class="vol-num">-</span></div>
                </div>
               <div class="metric-subtext">各標的年化歷史波動率 (對應產品天期)</div>
            </div>
        </div>
        <div class="mc-main-charts">
            <div class="card-wrapper chart-h350"><canvas id="scenarioChart"></canvas></div>
            <div class="card-wrapper chart-h350"><canvas id="worstChart"></canvas></div>
        </div>
        <div class="double-column-area">
            <div class="card-wrapper chart-auto">
                <h3 style="font-size: 1rem; text-align: left; border-left: 4px solid var(--primary); padding-left: 10px;">相關係數矩陣 Correlation (<span id="corPeriodLabel"></span>)</h3>
                <div id="heatmapArea" class="heatmap-container"></div>
                <p style="font-size: 1rem; color: var(--text-sub); text-align: center; margin-top: 5px;">💡 紅色是正相關，藍色是負相關，計算期間與產品 Duration 同步</p>
            </div>
            <div class="card-wrapper chart-auto">
                <h3 style="font-size: 1rem; text-align: left; border-left: 4px solid var(--warning); padding-left: 10px;">歷史回測 (Historical Backtest)</h3>
                <div id="backtestInfo">
                    <div class="backtest-list">
                        <div class="backtest-item"><span class="bt-label">起始日 Start Date</span><span id="btStart" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">到期/出場日 End Date</span><span id="btEnd" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">落點分布 Event</span><span id="btStatus" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">存續期間 Days to Event</span><span id="btDays" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">總損益 Total Return</span><span id="btReturn" class="bt-value">-</span></div>
                    </div>
                </div>
                <p style="font-size: 1rem; color: var(--text-sub); text-align: center;">💡 一個週期(比照天期)前，進入市場的實際表現</p>
            </div>
        </div>
        <h3 style="margin-top:40px; margin-bottom:15px; border-left: 4px solid var(--primary); padding-left: 10px;">Technical Analysis & Long-term Strategy Backtest</h3>
        <div id="techOptions">
            <label class="tech-option active"><input type="radio" name="tech" value="none" checked><span>給我乾淨的線圖就好</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="ma"><span>移動平均線MA (20/60/200)</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="bias"><span>乖離率 BIAS 20</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="rsi"><span>相對強弱指標 RSI 14</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="macd"><span>平滑異同移動平均線指標 MACD</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="hv"><span>歷史波動度 Hist Vol</span></label>
            <label class="tech-option level-toggle" id="lvlBtn"><input type="checkbox" id="showPriceLevels"><span>顯示KO, Strike, KI線</span></label>
        </div>
        <div id="stockChartsArea" class="stock-charts-area"></div>
    </div>

<div style="margin-top: 50px; padding: 20px 0; border-top: 1px solid #dadce0; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; color: #5f6368; line-height: 1.7;">
    <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <span style="color: #b71c1c; font-weight: bold; font-size: 0.9rem; letter-spacing: 1px;">RISK DISCLOSURE & DISCLAIMER</span>
        <div style="flex-grow: 1; height: 1px; background-color: #eee; margin-left: 15px;"></div>
    </div>
    <h4 style="margin: 0 0 12px 0; color: #3c4043; font-size: 1rem; font-weight: 600;">⚠️ 重要風險聲明與投資警語</h4>
    <p style="font-size: 0.85rem; margin-bottom: 15px;">
        本模型提供之分析數據（包含但不限於預期報酬、勝率及安全性分析）係基於 <span style="color: #b71c1c;"><b>蒙地卡羅模擬模型 (Monte Carlo Simulation)</b></span> 及歷史股價數據計算而成。相關模擬結果乃建立在「假設市場未來波動規律與歷史數據一致」之前提下，僅供學術研究與投資參考，<span style="text-decoration: underline;">並不代表、亦不保證未來之市場表現或實際投資收益</span>。</p>
    <ul style="padding-left: 18px; font-size: 0.8rem; color: #70757a; list-style-type: square;">
        <li style="margin-bottom: 6px;"><b style="color: #5f6368;">模型限制：</b> 統計機率模型無法預測極端黑天鵝事件、政治動盪或公司結構性突發改變。</li>
        <li style="margin-bottom: 6px;"><b style="color: #5f6368;">歷史回測：</b> 歷史績效僅供參考，過去市場走勢不必然於未來重複發生。</li>
        <li style="margin-bottom: 6px;"><b style="color: #5f6368;">產品風險：</b> FCN 屬高風險結構型商品，涉及衍生性金融工具交易，可能導致本金重大損失或涉及實物交割。</li>
        <li style="margin-bottom: 6px;"><b style="color: #5f6368;">審慎評估：</b> 投資人應詳閱商品說明書並確認自身風險承受能力，本平台不負擔任何投資盈虧責任。</li></ul>
    <div style="margin-top: 20px; padding: 10px; border: 1px solid #f1f3f4; background-color: #fafafa; font-size: 0.85rem; color: #b71c1c; text-align: center; font-weight: 500;">投資一定有風險，投資工具交易有賺有賠，申購前應詳閱相關產品說明書及投資人須知，並自行負擔投資損益責任。</div>
</div>


</div>
<script>
let mcScenarioChart = null, mcWorstChart = null; let techChartInstances = {}; let globalStockData = {}; let currentVolDays = 126; class SeededRandom {
    constructor(seed = 12345) { this.seed = seed; }
    next() {
        this.seed = (this.seed * 1664525 + 1013904223) % 4294967296;
        return this.seed / 4294967296;
    }
}
function seededRandn(rng) {
    let u=0, v=0;
    while(u===0) u = rng.next();
    while(v===0) v = rng.next();
    return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v); } function getCorrelation(x, y) {
    const muX = math.mean(x), muY = math.mean(y);
    const stdX = math.std(x), stdY = math.std(y);
    let sum = 0;
    for (let i = 0; i < x.length; i++) sum += (x[i] - muX) * (y[i] - muY);
    return sum / ((x.length - 1) * stdX * stdY); } const Calc = {
    MA: (p, n) => p.map((_, i) => i < n - 1 ? null : parseFloat((p.slice(i - n + 1, i + 1).reduce((a, b) => a + b) / n).toFixed(2))),
    BIAS: (p, n = 20) => { const ma = Calc.MA(p, n); return p.map((v, i) => ma[i] ? parseFloat(((v - ma[i]) / ma[i] * 100).toFixed(2)) : null); },
    RSI: (p, n = 14) => {
        let r = [null], g = [], l = [];
        for (let i = 1; i < p.length; i++) {
            let d = p[i] - p[i - 1]; g.push(Math.max(d, 0)); l.push(Math.max(-d, 0));
            if (i < n) r.push(null);
            else {
                let ag = g.slice(i - n, i).reduce((a, b) => a + b) / n;
                let al = l.slice(i - n, i).reduce((a, b) => a + b) / n;
                r.push(parseFloat((100 - (100 / (1 + ag / (al || 1)))).toFixed(2)));
            }
        } return r;
    },
    MACD: (p) => {
        const ema = (data, n) => { let k = 2 / (n + 1), r = [data[0]]; for (let i = 1; i < data.length; i++) r.push(data[i] * k + r[i - 1] * (1 - k)); return r; };
        let s = ema(p, 12), l = ema(p, 26), m = s.map((v, i) => v - l[i]), sig = ema(m, 9);
        return { macd: m, signal: sig };
    },
    HV: (p, n) => p.map((_, i) => {
        if (i < n) return null;
        let slice = p.slice(i - n, i), rets = [];
        for (let j = 1; j < slice.length; j++) rets.push(Math.log(slice[j] / (slice[j - 1] || 1)));
        return parseFloat((Math.sqrt(math.variance(rets)) * Math.sqrt(252) * 100).toFixed(2));
    })
};
document.getElementById('runBtn').addEventListener('click', async () => {
    const btn = document.getElementById('runBtn'), loader = document.getElementById('loading'), resSec = document.getElementById('result-section');
    btn.disabled = true; loader.style.display = 'block'; resSec.style.display = 'none';
    try {
        const symbols = document.getElementById('symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
        const apiKey = document.getElementById('apiKey').value;
        const months = parseInt(document.getElementById('months').value);
        const gMonths = parseInt(document.getElementById('guaranteedMonths').value) || 1;
        const years = parseInt(document.getElementById('chartYears').value);
        const outputSize = Math.max(1000, years * 265 + (months * 21)); // 增加長度以確保恢復力分析有足夠資料
        currentVolDays = months * 21;
        await Promise.all(symbols.map(async (s) => {
            const res = await fetch(`https://api.twelvedata.com/time_series?symbol=${s}&interval=1day&outputsize=${outputSize}&apikey=${apiKey}`).then(r => r.json());
            if(!res.values) throw new Error(`API 錯誤 (${s}): ${res.message || '請檢查 Key'}`);
            const vals = res.values.reverse();
            globalStockData[s] = { labels: vals.map(v => v.datetime), prices: vals.map(v => parseFloat(v.close)), volumes: vals.map(v => parseFloat(v.volume)), name: s };
        }));
        const dim = symbols.length;
        const vols = symbols.map(s => {
            const p = globalStockData[s].prices.slice(-(currentVolDays + 1));
            let rets = [];
            for(let i=1; i<p.length; i++) rets.push(Math.log(p[i]/p[i-1]));
            return math.std(rets) * Math.sqrt(252);
        });
        const retsMatrix = [];
        const histLen = globalStockData[symbols[0]].prices.length;
        const corWindow = currentVolDays;
        document.getElementById('corPeriodLabel').innerText = `${months}M / ${corWindow}D`;
        for(let i=histLen-corWindow; i<histLen; i++) {
            retsMatrix.push(symbols.map(s => Math.log(globalStockData[s].prices[i] / (globalStockData[s].prices[i-1] || globalStockData[s].prices[i]))));
        }
        const corMat = Array.from({length: dim}, (_, i) => Array.from({length: dim}, (_, j) => i === j ? 1 : getCorrelation(retsMatrix.map(r => r[i]), retsMatrix.map(r => r[j]))));
        const inputCoupon = parseFloat(document.getElementById('coupon').value) / 100;
        const params = { symbols, S0: symbols.map(s => globalStockData[s].prices.slice(-1)[0]), KO: symbols.map((s,i) => globalStockData[s].prices.slice(-1)[0] * (document.getElementById('koPct').value/100)), AKI: symbols.map((s,i) => globalStockData[s].prices.slice(-1)[0] * (document.getElementById('kiPct').value/100)), K: symbols.map((s,i) => globalStockData[s].prices.slice(-1)[0] * (document.getElementById('strikePct').value/100)), V: vols, COR: corMat, N: parseInt(document.getElementById('simN').value), D: months * 21, R: inputCoupon, r: 0.03, CDS: 0.005, totalMonths: months, kiType: document.getElementById('kiType').value,gMonths: gMonths };
        const mcResult = runSimulation(params);
        renderMCResults(mcResult, params);
        renderCorrelationHeatmap(params.symbols, params.COR);
        runBacktest(params);
        initTechCharts(symbols);
        resSec.style.display = 'block';
    } catch (e) { alert("錯誤: " + e.message); }
    finally { btn.disabled = false; loader.style.display = 'none'; } }); function runSimulation(p) {const {S0, KO, AKI, K, V, COR, N, D, R, r, CDS, totalMonths, symbols, kiType, gMonths} = p;const dim = symbols.length, dt = 1/252, L = dynamicCholesky(COR);const rng = new SeededRandom(42);
    let payoffs = [],periods = [],scCounts = new Array(totalMonths + 2).fill(0),worstCounts = new Array(dim).fill(0);
    const minKoDays = gMonths * 21;
    for (let n = 0; n < N; n++) {
        let St = [...S0], kiTouched = false, ended = false;
        for (let d = 1; d <= D; d++) {
            let dz = math.multiply(L, Array.from({length: dim}, () => seededRandn(rng)));
            for (let i = 0; i < dim; i++) {
                St[i] *= Math.exp((r - 0.5 * V[i]**2) * dt + V[i] * Math.sqrt(dt) * dz[i]);
                if (kiType === "AKI" && St[i] < AKI[i]) kiTouched = true;
            }
            if (d >= minKoDays) {
                if (St.every((s, i) => s >= KO[i])) {
                    payoffs.push(100 * (1 + (d/252)*R) * Math.exp(-(r+CDS)*(d/252)));
                    periods.push(d);
                    let monthIdx = Math.floor((d - 1) / 21);
                    monthIdx = Math.max(0, Math.min(monthIdx, totalMonths - 1));
                    scCounts[monthIdx]++;
                    ended = true;
                    break;}}
            if (d === D && !ended) {
                if (kiType === "EKI" && St.some((s, i) => s < AKI[i])) kiTouched = true;
                let disc = Math.exp(-(r+CDS)*(D/252));
                if (!kiTouched || St.every((s, i) => s >= K[i])) {
                    payoffs.push(100 * (1 + (D/252)*R) * disc);
                    scCounts[totalMonths]++;
                } else {
                    let perf = St.map((s, i) => s / K[i]);
                    let mP = Math.min(...perf);
                    worstCounts[perf.indexOf(mP)]++;
                    payoffs.push((100*(D/252*R) + 100*mP) * disc);
                    scCounts[totalMonths+1]++;
                }
                periods.push(D);
            }
        }
    }
    return { avgReturn: math.mean(payoffs), avgDay: math.mean(periods), scenarioProbs: scCounts.map(c => (c / N) * 100), worstAssetProbs: worstCounts.map(c => (c / N) * 100) }; }
 
function runBacktest(p) {
    const {symbols, D, R, totalMonths, kiType} = p;
    const histLen = globalStockData[symbols[0]].prices.length;
    const startIndex = histLen - D - 1;
    if (startIndex < 0) return;
    const startPrices = symbols.map(s => globalStockData[s].prices[startIndex]);
    const KO = startPrices.map(s => s * (document.getElementById('koPct').value / 100));
    const AKI = startPrices.map(s => s * (document.getElementById('kiPct').value / 100));
    const K = startPrices.map(s => s * (document.getElementById('strikePct').value / 100));
    let kiTouched = false, event = "Maturity (到期)", daysToEvent = D, finalPayoff = 0;
    let koTrackers = new Array(symbols.length).fill(false);
    for (let d = 1; d <= D; d++) {
        const currentIndex = startIndex + d;
        const currentPrices = symbols.map(s => globalStockData[s].prices[currentIndex]);
        for (let i = 0; i < symbols.length; i++) {
            if (kiType === "AKI" && currentPrices[i] < AKI[i]) kiTouched = true;
            if (currentPrices[i] >= KO[i]) koTrackers[i] = true;
        }
        const minKoDays = (p.gMonths * 21);
        if (d >= minKoDays && d % 21 === 0 && koTrackers.every(status => status === true)) {
            event = `Knock-Out (第 ${d} 天提前出場)`; daysToEvent = d;
            finalPayoff = 100 * (1 + (d / 252) * R); break;
        }
        if (d === D) {
            if (kiType === "EKI" && currentPrices.some((s, i) => s < AKI[i])) kiTouched = true;
            if (!kiTouched || currentPrices.every((s, i) => s >= K[i])) {
                event = "Full Repayment (滿期贖回)"; finalPayoff = 100 * (1 + (D / 252) * R);
            } else {
                event = "KI Delivery (實物交割)";
                const perf = currentPrices.map((s, i) => s / K[i]);
                const worstPerf = Math.min(...perf); finalPayoff = 100 * (D / 252 * R) + (100 * worstPerf);
            }
        }
    }
    document.getElementById('btStart').innerText = globalStockData[symbols[0]].labels[startIndex];
    document.getElementById('btEnd').innerText = globalStockData[symbols[0]].labels[startIndex + daysToEvent];
    document.getElementById('btStatus').innerText = event;
    document.getElementById('btDays').innerText = `${daysToEvent} Days`;
    document.getElementById('btReturn').innerText = (finalPayoff - 100).toFixed(2) + "%";
    document.getElementById('btReturn').style.color = (finalPayoff >= 100) ? "var(--success)" : "var(--danger)"; }
 
function dynamicCholesky(A) {
    const n = A.length; let L = Array.from({length: n}, () => new Array(n).fill(0));
    for (let i = 0; i < n; i++) { for (let j = 0; j <= i; j++) {
        let s = 0; for (let k = 0; k < j; k++) s += L[i][k] * L[j][k];
        L[i][j] = (i === j) ? Math.sqrt(Math.max(A[i][i] - s, 0)) : (1.0 / L[j][j] * (A[i][j] - s));
    } } return L;
}
function renderMCResults(res, params) {
    document.getElementById('avgReturn').innerText = res.avgReturn.toFixed(4);
    document.getElementById('avgPeriod').innerText = res.avgDay.toFixed(1) + " Days";
    document.getElementById('volPeriodLabel').innerText = `(${currentVolDays}D)`;
    const volList = document.getElementById('volList');
    volList.innerHTML = params.symbols.map((s, i) => `<div class="vol-item"><span class="vol-symbol">${s}</span><span class="vol-num">${(params.V[i]*100).toFixed(2)}%</span></div>`).join('');
    if(mcScenarioChart) mcScenarioChart.destroy();mcScenarioChart = new Chart(document.getElementById('scenarioChart'), { type: 'bar',data: { labels: [...Array(params.totalMonths).keys()].map(i => `KO M${i+1}`).concat(["到期-現金", "實物履約"]), 
datasets: [{ label: 'Probability (%)', data: res.scenarioProbs, backgroundColor: '#1a73e8' }] }, 
options: { responsive:true, maintainAspectRatio:false, plugins:{ title:{display:true, text:'蒙地卡羅模擬機率分布',font: { size: 18, weight: 'bold' }},legend: { labels: { font: { size: 12 } } }  },scales: { x: { ticks: { font: { size: 12 } } },
 y: { ticks: { font: { size: 12 } } }} }  });

    if(mcWorstChart) mcWorstChart.destroy();
    mcWorstChart = new Chart(document.getElementById('worstChart'), { type: 'pie', data: { labels: params.symbols, datasets: [{ data: res.worstAssetProbs, backgroundColor: ['#ea4335', '#f9ab00', '#34a853'] }] 
}, options: {responsive:true, maintainAspectRatio:false, plugins:{title:{display:true, text:'UL實物履約機率',font: { size: 18, weight: 'bold' } },legend: { position: 'bottom',labels: { font: { size: 14 } } } } } }); }

 
function renderCorrelationHeatmap(symbols, corMat) {
    const container = document.getElementById('heatmapArea'); container.innerHTML = '';
    const size = symbols.length; const grid = document.createElement('div');
    grid.className = 'heatmap-grid'; grid.style.gridTemplateColumns = `repeat(${size + 1}, auto)`;
    grid.appendChild(document.createElement('div'));
    symbols.forEach(s => { const label = document.createElement('div'); label.className = 'heatmap-label'; label.innerText = s; grid.appendChild(label); });
    for (let i = 0; i < size; i++) {
        const label = document.createElement('div'); label.className = 'heatmap-label'; label.style.display = 'flex'; label.style.alignItems = 'center'; label.innerText = symbols[i]; grid.appendChild(label);
        for (let j = 0; j < size; j++) {
            const val = corMat[i][j]; const cell = document.createElement('div'); cell.className = 'heatmap-cell'; cell.innerText = val.toFixed(2);
            let r, g, b; if (val >= 0) { r = 234; g = Math.round(67 + (185 * (1 - val))); b = Math.round(53 + (200 * (1 - val))); } else { r = Math.round(26 + (200 * (1 + val))); g = Math.round(115 + (100 * (1 + val))); b = 232; }
            cell.style.backgroundColor = `rgb(${r},${g},${b})`; grid.appendChild(cell);
        }
    }
    container.appendChild(grid);
}
 
function initTechCharts(symbols) {
    const area = document.getElementById('stockChartsArea');
    area.innerHTML = '';
    symbols.forEach(s => {
        const card = document.createElement('div');
        card.className = 'stock-card';
        card.innerHTML = `<h3 style="color:var(--primary); margin-top:0;">${s} 歷史數據與回測分析</h3>
            <div class="canvas-container"><canvas id="chart_${s}"></canvas></div>
            <div id="stats_${s}" class="stats-panel"></div>
            <div id="backtest_long_${s}" class="long-term-panel"></div>
            <div class="analysis-grid-row">
                <div id="safety_analysis_${s}" class="safety-analysis-panel"></div>
                <div id="recovery_analysis_${s}" class="recovery-analysis-panel"></div>
            </div>`;
        area.appendChild(card);
        updateSingleStockChart(s);
    });
}
function updateSingleStockChart(symbol) {
    const data = globalStockData[symbol];
    const years = parseInt(document.getElementById('chartYears').value);
    const months = parseInt(document.getElementById('months').value);
    const holdDays = months * 21;
    const displayCount = years * 252;
    const allPrices = data.prices;
    const labels = data.labels;
   
    const displayPrices = allPrices.slice(-displayCount);
    const displayVolumes = data.volumes.slice(-displayCount);
    const displayLabels = labels.slice(-displayCount);
 
    const selectedTech = document.querySelector('input[name="tech"]:checked').value;
    const showLevels = document.getElementById('showPriceLevels').checked;
    const S0 = displayPrices[displayPrices.length - 1];
    const koPrice = S0 * (document.getElementById('koPct').value / 100);
    const strikePrice = S0 * (document.getElementById('strikePct').value / 100);
    const kiPrice = S0 * (document.getElementById('kiPct').value / 100);
 
    const datasets = [{ label: "Close Price", data: displayPrices, borderColor: "#1a73e8", borderWidth: 2, pointRadius: 0, fill: false, yAxisID: 'y' }];
    const scales = { y: { position: 'left', ticks:{color: '#202124'}, grid:{color:'#edf2f7'}, grace: '5%' }, yVol: { position: 'right', display: false }, x: { ticks:{color: '#5f6368'}, grid:{display:false} } };
    datasets.push({ type: 'bar', label: "Volume", data: displayVolumes, backgroundColor: 'rgba(26,115,232,0.08)', yAxisID: 'yVol' });
   
    if(showLevels) {
        const line = (val, label, color) => ({ label, data: new Array(displayPrices.length).fill(val), borderColor: color, borderDash: [4, 4], borderWidth: 1.5, pointRadius: 0, fill: false });
        datasets.push(line(koPrice, `KO (${koPrice.toFixed(1)})`, '#f29900'));
        datasets.push(line(strikePrice, `Strike (${strikePrice.toFixed(1)})`, '#188038'));
        datasets.push(line(kiPrice, `KI (${kiPrice.toFixed(1)})`, '#d93025'));
       
        const dStrike = displayPrices.filter(p => p < strikePrice).length;
        const dKI = displayPrices.filter(p => p < kiPrice).length;
        document.getElementById(`stats_${symbol}`).innerHTML = `
            <div class="stat-box"><span class="stat-label">分析期間交易日 (${years}Y)</span><span class="stat-num">${displayPrices.length}</span></div>
            <div class="stat-box"><span class="stat-label">收盤 < Strike 天數</span><span class="stat-num" style="color:var(--success)">${dStrike} (${(dStrike/displayPrices.length*100).toFixed(1)}%)</span></div>
            <div class="stat-box"><span class="stat-label">收盤 < KI 天數</span><span class="stat-num" style="color:var(--danger)">${dKI} (${(dKI/displayPrices.length*100).toFixed(1)}%)</span></div>`;
    }
 
    if(selectedTech !== 'none') {
        scales.yInd = { position: 'right', ticks:{color:'#5f6368'}, grid:{drawOnChartArea:false} };
        if(selectedTech === 'ma') {
            datasets.push({ label: "MA20", data: Calc.MA(allPrices, 20).slice(-displayCount), borderColor: "#f9ab00", borderWidth: 1, pointRadius: 0, yAxisID: 'yInd' });
            datasets.push({ label: "MA60", data: Calc.MA(allPrices, 60).slice(-displayCount), borderColor: "#34a853", borderWidth: 1, pointRadius: 0, yAxisID: 'yInd' });
            datasets.push({ label: "MA200", data: Calc.MA(allPrices, 200).slice(-displayCount), borderColor: "#a142f4", borderWidth: 1, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'bias') {
            datasets.push({ label: "BIAS(20)", data: Calc.BIAS(allPrices, 20).slice(-displayCount), borderColor: "#1a73e8", borderWidth: 2, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'rsi') {
            datasets.push({ label: "RSI(14)", data: Calc.RSI(allPrices).slice(-displayCount), borderColor: "#e67c73", borderWidth: 1.5, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'macd') {
            const m = Calc.MACD(allPrices);
            datasets.push({ label: "MACD", data: m.macd.slice(-displayCount), borderColor: "#a142f4", borderWidth: 1.5, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'hv') {
            datasets.push({ label: `HV`, data: Calc.HV(allPrices, currentVolDays).slice(-displayCount), borderColor: "#5f6368", borderWidth: 2, pointRadius: 0, yAxisID: 'yInd' });
        }
    }
 
    // --- 【核心邏輯修改】長期回測統計 & 安全性分析 ---
    const kiThreshold = parseFloat(document.getElementById('kiPct').value) / 100;
    const strikeThreshold = parseFloat(document.getElementById('strikePct').value) / 100;
   
    // 嚴格將分析樣本限制在 displayPrices (例如 5 年) 範圍內
    const analysisPrices = displayPrices;
    const totalAvailableDays = analysisPrices.length;
   
    let upCount = 0, totalScenarios = 0, returns = [];
    let touchKICount = 0, endBelowStrikeCount = 0;
    let expiredBelowStrikeCases = 0;
    let postExpiryRecoveryDaysList = [];
    let currentlyStillUnrecoveredCount = 0;
 
    // 迴圈終點：totalAvailableDays - holdDays
    // 這樣最後一個進場點 i 的到期日剛好是 analysisPrices 的最後一天 (今天)
    for (let i = 0; i <= totalAvailableDays - holdDays; i++) {
        const entry = analysisPrices[i];
        const strikeVal = entry * strikeThreshold;
        const windowPrices = analysisPrices.slice(i + 1, i + holdDays + 1);
        const expiryPrice = windowPrices[windowPrices.length - 1]; 
       
        const change = (expiryPrice - entry) / entry;
        returns.push(change);
        if (change > 0) upCount++;
 
        if (windowPrices.some(p => p < entry * kiThreshold)) touchKICount++;
        
        if (expiryPrice < strikeVal) {
            endBelowStrikeCount++;
            expiredBelowStrikeCases++;
           
            // 計算該到期日在 allPrices 中的全局索引，以便利用剩餘的所有歷史數據觀察恢復狀況
            const expiryGlobalIdx = (allPrices.length - totalAvailableDays) + i + holdDays;
            const futurePrices = allPrices.slice(expiryGlobalIdx);
            const recoverIdx = futurePrices.findIndex(p => p >= strikeVal);
           
            if (recoverIdx !== -1) {
                postExpiryRecoveryDaysList.push(recoverIdx);
            } else {
                currentlyStillUnrecoveredCount++;
            }
        }
        totalScenarios++;
    }
 
    const winRate = totalScenarios > 0 ? (upCount / totalScenarios * 100).toFixed(1) : 0;
    const avgRet = returns.length > 0 ? (returns.reduce((a, b) => a + b) / returns.length * 100).toFixed(2) : 0;
    const maxRet = returns.length > 0 ? (Math.max(...returns) * 100).toFixed(2) : 0;
    const minRet = returns.length > 0 ? (Math.min(...returns) * 100).toFixed(2) : 0;
    const kiProb = totalScenarios > 0 ? (touchKICount / totalScenarios * 100).toFixed(1) : 0;
    const strikeProb = totalScenarios > 0 ? (endBelowStrikeCount / totalScenarios * 100).toFixed(1) : 0;
    const avgRecoveryDays = postExpiryRecoveryDaysList.length > 0 ? (postExpiryRecoveryDaysList.reduce((a,b)=>a+b)/postExpiryRecoveryDaysList.length).toFixed(1) : "N/A";
    const stillUnrecoveredPct = expiredBelowStrikeCases > 0 ? (currentlyStillUnrecoveredCount / expiredBelowStrikeCases * 100).toFixed(1) : 0;
 
    // 取得起始與結束進場日期
    const firstEntryDate = displayLabels[0];
    const lastEntryDate = displayLabels[totalAvailableDays - holdDays];

    document.getElementById(`backtest_long_${symbol}`).innerHTML = `
        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--primary);">📊 持有 ${months} 個月之長期回測統計 (過去 ${years} 年數據)</h4>
        <p style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 10px;">進場樣本區間：${firstEntryDate} 至 ${lastEntryDate} (共 ${totalScenarios} 個樣本)</p>
        <div class="stats-panel" style="grid-template-columns: repeat(4, 1fr);">
            <div class="stat-box" style="background: ${winRate >= 50 ? '#e6f4ea' : '#fce8e6'}">
                <span class="stat-label">勝率 (Win Rate)</span>
                <span class="stat-num" style="color: ${winRate >= 50 ? 'var(--success)' : 'var(--danger)'}">${winRate}%</span>
            </div>
            <div class="stat-box"><span class="stat-label">平均報酬</span><span class="stat-num">${avgRet}%</span></div>
            <div class="stat-box"><span class="stat-label">最佳報酬</span><span class="stat-num" style="color:var(--success)">${maxRet}%</span></div>
            <div class="stat-box"><span class="stat-label">最差報酬</span><span class="stat-num" style="color:var(--danger)">${minRet}%</span></div>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-sub); margin-top: 10px; line-height: 1.4;">
            💡 <b>計算邏輯：</b> 模型分析了 5 年內每一個具備完整持有期間的交易日，並固定持有 ${holdDays} 個交易日。在總計 ${totalScenarios} 個測試樣本中，有 ${upCount} 次在持有結束後股價高於買入價。
        </p>`;
 
    document.getElementById(`safety_analysis_${symbol}`).innerHTML = `
        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--danger);">🛡️ 安全性分析 (持有期內風險)</h4>
        <div class="stats-panel" style="grid-template-columns: repeat(2, 1fr);">
            <div class="stat-box" style="background: #fff5f5;">
                <span class="stat-label">曾觸及 KI 之機率</span>
                <span class="stat-num" style="color: var(--danger)">${kiProb}%</span>
            </div>
            <div class="stat-box" style="background: #fff9f0;">
                <span class="stat-label">到期低於 Strike 機率</span>
                <span class="stat-num" style="color: var(--warning)">${strikeProb}%</span>
            </div>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-sub); margin-top: 10px; line-height: 1.4;">
            💡 <b>風險評估：</b> 基於 ${totalScenarios} 個歷史進場點。曾觸及 KI 表示該期間內股價曾跌至進場價的 ${document.getElementById('kiPct').value}% 以下；而到期低於 Strike 表示回測資料內股價在到期日跌破 ${document.getElementById('strikePct').value}% 以下的概率。
        </p>`;
 
    document.getElementById(`recovery_analysis_${symbol}`).innerHTML = `
        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: #673ab7;">💊恢復力分析 (若到期低於 Strike 需多久解套)</h4>
        <div class="stats-panel" style="grid-template-columns: repeat(2, 1fr);">
            <div class="stat-box" style="background: #f3e5f5;">
                <span class="stat-label">平均解套天數 (到期後)</span>
                <span class="stat-num" style="color: #673ab7">${avgRecoveryDays} 天</span>
            </div>
            <div class="stat-box" style="background: #fafafa;">
                <span class="stat-label">至今仍未漲回比例</span>
                <span class="stat-num" style="color: #444">${stillUnrecoveredPct}%</span>
            </div>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-sub); margin-top:8px;">💡 基於 ${totalScenarios} 次回測資料內，分析當到期股價低於履約價時，要重新站回該履約價所需的天數。</p>`;
 
    const ctx = document.getElementById(`chart_${symbol}`).getContext('2d');
    if(techChartInstances[symbol]) techChartInstances[symbol].destroy();
    techChartInstances[symbol] = new Chart(ctx, { type: 'line', data: { labels: displayLabels, datasets }, options: { responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false}, scales, plugins:{ legend:{labels:{boxWidth: 10, font:{size:11}}}, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x', overScaleMode: 'y' } } } } }); } document.getElementById('techOptions').addEventListener('change', (e) => {
    if(e.target.name === 'tech') {
        document.querySelectorAll('.tech-option:not(.level-toggle)').forEach(el => el.classList.remove('active'));
        e.target.closest('.tech-option').classList.add('active');
    }
    if(e.target.id === 'showPriceLevels') document.getElementById('lvlBtn').classList.toggle('active', e.target.checked);
    Object.keys(techChartInstances).forEach(s => updateSingleStockChart(s)); }); document.getElementById('chartYears').addEventListener('change', () => {
    if (Object.keys(globalStockData).length > 0) Object.keys(techChartInstances).forEach(s => updateSingleStockChart(s)); }); </script> </body> </html>

