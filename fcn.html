<!DOCTYPE html>
<!-- saved from url=(0063)https://finatticus.github.io/structuredproductanalysis/fcn.html -->
<html lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SN Quant Analytics</title>
<meta name="theme-color" content="#1a4da1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://finatticus.github.io/structuredproductanalysis/app-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://finatticus.github.io/structuredproductanalysis/app-icon.png">
<link rel="icon" type="image/png" href="https://finatticus.github.io/structuredproductanalysis/app-icon.png"><link rel="manifest" href="https://finatticus.github.io/structuredproductanalysis/manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>

    <script src="./SN Quant Analytics_files/chart.js.ä¸‹è¼‰"></script>
    <script src="./SN Quant Analytics_files/chartjs-plugin-zoom.min.js.ä¸‹è¼‰"></script>
<script src="./SN Quant Analytics_files/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
:root{--bg-color:#f4f7fa;--card-bg:#ffffff;--primary:#1a4da1;--text-main:#2c3e50;--text-sub:#5f6368;--border:#dadce0;--accent:#e8f0fe;--danger:#d93025;--success:#188038;--warning:#f29900;--shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06)}body{font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background-color:var(--bg-color);color:var(--text-main);padding:20px;margin:0}.container{max-width:1650px;margin:0 auto}h1{color:var(--primary);text-align:left;font-size:1.8rem;margin-bottom:25px;font-weight:500;border-bottom:2px solid var(--primary);padding-bottom:10px}h3{color:var(--text-main);font-weight:500;margin-top:0}.config-panel{background:var(--card-bg);padding:25px;border-radius:8px;margin-bottom:25px;box-shadow:0 1px 3px rgba(60,64,67,.3);border:1px solid var(--border)}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:10px}.input-group{display:flex;flex-direction:column}label{display:flex;align-items:center;height:32px;margin-bottom:4px;font-size:0.9rem;font-weight:700}input,select{background:#fff;border:1px solid var(--border);color:var(--text-main);padding:10px;border-radius:4px;font-size:0.9rem;transition:border 0.2s}button{background:var(--primary);color:white;padding:12px;border:none;border-radius:4px;cursor:pointer;width:100%;font-size:1rem;font-weight:600;margin-top:20px;transition:background 0.2s}button:hover{background:#1557b0}#loading{display:none;text-align:center;margin:20px 0;color:var(--primary);font-weight:bold}.result-section{display:none;margin-top:20px}.metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:30px}.metric-card{background:var(--card-bg);padding:20px;border-radius:12px;border:1px solid var(--border);box-shadow:0 4px 6px rgba(0,0,0,0.04);transition:transform 0.2s;position:relative;overflow:hidden;text-align:center;display:flex;flex-direction:column;align-items:center}.metric-card:hover{transform:translateY(-2px)}.metric-card::before{content:"";position:absolute;top:0;left:0;width:4px;height:100%;background:var(--primary)}.metric-card.orange::before{background:var(--warning)}.metric-card.green::before{background:var(--success)}.metric-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px;width:100%}.metric-title{font-size:1rem;color:var(--text-sub);font-weight:700;letter-spacing:0.5px}.metric-icon{font-size:1.2rem;opacity:0.7}.metric-value{display:block;font-size:2rem;font-weight:800;color:var(--text-main);margin:5px 0}.metric-subtext{font-size:0.75rem;color:var(--text-sub);margin-top:5px;font-weight:400}.metric-card:has(#avgReturn){display:none}.metric-card[style*="grid-column: 1 / -1"]{text-align:left !important;align-items:flex-start !important}.metric-card[style*="grid-column: 1 / -1"] .metric-header{justify-content:flex-start !important}.metric-card[style*="grid-column: 1 / -1"] table th,.metric-card[style*="grid-column: 1 / -1"] table td{text-align:left;padding-left:0}.vol-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;padding-top:15px;border-top:1px dashed var(--border);width:100%}.vol-item{text-align:center}.vol-symbol{font-size:0.7rem;font-weight:700;color:var(--text-sub);display:block}.vol-num{font-size:0.9rem;font-weight:700;color:var(--primary)}.mc-main-charts{display:grid;grid-template-columns:1.5fr 1fr;gap:20px;margin-bottom:20px}.double-column-area{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:40px}.card-wrapper{background:var(--card-bg);padding:20px;border-radius:8px;border:1px solid var(--border);box-shadow:0 1px 2px rgba(60,64,67,.1);position:relative}.chart-h350{height:350px}.chart-auto{min-height:250px}#techOptions{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start;margin-bottom:25px;padding:10px;background:#eee;border-radius:8px}.tech-option{background:#fff;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:13px;color:var(--text-sub);border:1px solid var(--border);font-weight:500;transition:all 0.2s}.tech-option.active{background:var(--primary);color:#fff;border-color:var(--primary)}.tech-option.level-toggle{border-color:var(--warning);color:var(--warning)}.tech-option.level-toggle.active{background:var(--warning);color:#fff;border-color:var(--warning)}.tech-option input{display:none}.stock-charts-area{display:grid;grid-template-columns:1fr;gap:30px}.stock-card{background:var(--card-bg);padding:25px;border-radius:8px;border:1px solid var(--border);box-shadow:0 1px 3px rgba(60,64,67,.1)}.canvas-container{height:420px;width:100%;margin-top:15px;cursor:crosshair}.stats-panel{margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px}.stat-box{background:var(--accent);padding:12px;border-radius:6px;text-align:center;border:1px solid rgba(26,115,232,0.1)}.stat-label{font-size:0.7rem;color:var(--text-sub);display:block;margin-bottom:5px;font-weight:600}.stat-num{font-size:1.1rem;font-weight:bold;color:var(--text-main)}.heatmap-container{display:flex;justify-content:center;padding:10px 0;width:100%}.heatmap-grid{display:grid;gap:8px}.heatmap-cell{width:65px;height:65px;display:flex;align-items:center;justify-content:center;font-size:0.9rem;font-weight:bold;color:white;border-radius:6px}.heatmap-label{font-size:0.8rem;font-weight:600;color:var(--text-sub);text-align:center;padding:5px}.backtest-list{list-style:none;padding:0;margin:15px 0}.backtest-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);font-size:0.9rem}.backtest-item:last-child{border-bottom:none}.bt-label{color:var(--text-sub);font-weight:500}.bt-value{font-weight:bold}.analysis-grid-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px}.long-term-panel{background:#fff;border:1px solid var(--primary);border-radius:8px;padding:15px;margin-top:20px}.safety-analysis-panel{background:#fff;border:1px solid var(--danger);border-radius:8px;padding:15px}.recovery-analysis-panel{background:#fff;border:1px solid #673ab7;border-radius:8px;padding:15px}@media print{#hiddenReturn{color:white !important;-webkit-print-color-adjust:exact;print-color-adjust:exact;opacity:0}body,.container,.card,h1,h1 span{visibility:visible !important;display:block !important}h3[style*="margin-top:40px"]{break-before:page;page-break-before:always}.stock-card{break-after:page;page-break-after:always}}.label-action-group{display:flex;justify-content:space-between;align-items:center;height:32px;margin-bottom:4px}.label-action-group label{margin-bottom:0;white-space:nowrap}.mini-btn-group{display:flex;gap:2px;background:#eee;padding:3px;border-radius:4px;align-self:center}.mini-btn{padding:4px 5px;font-size:11px;cursor:pointer;border-radius:3px;background:transparent;color:var(--text-sub);border:none;font-weight:bold;transition:all 0.2s;width:auto;margin-top:0}.mini-btn.active{background:var(--primary);color:white}.mini-btn.active.warning{background:var(--warning)}.hidden-select{display:none}.input-group>label{margin-bottom:4px}@media (max-width:768px){body{padding:10px}.grid{grid-template-columns:1fr}.metrics{grid-template-columns:1fr}.mc-main-charts,.double-column-area{grid-template-columns:1fr}h1{font-size:1.4rem}.canvas-container{height:300px}.label-action-group{flex-direction:column;align-items:flex-start;height:auto;gap:5px}}@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}.result-section.active{display:block !important;animation:fadeInUp 0.6s cubic-bezier(0.22,1,0.36,1) forwards}#loading{display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:15px}.loader-spinner{width:40px;height:40px;border:4px solid var(--accent);border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}#runBtn:active{transform:scale(0.98)}
</style></head><body>
 
 
<div class="container">
    <h1 style="display: flex; justify-content: space-between; align-items: center;">
    <span>SN QUANT ANALYTICS</span>
    <span id="hiddenReturn" style="color: var(--bg-color); font-size: 1rem; user-select: all;">-</span>
</h1>
    <div class="config-panel">
<div class="grid">
<div class="input-group" title="FCN: æ¯æœˆå›ºå®šé…æ¯
DRA: æ¯æœˆæµ®å‹•è¨ˆæ¯ (ä¿è­‰é ˜æ¯æœŸé–“å¾Œï¼Œç•¶æ—¥æ‰€æœ‰é€£çµè‚¡ç¥¨æ”¶ç›¤åƒ¹éƒ½åœ¨å±¥ç´„åƒ¹Strikeä¹‹ä¸Šæ‰è¨ˆæ¯)">
    <label>ç”¢å“æ¶æ§‹</label>
    <select id="couponType" class="form-control">
        <option value="Fixed">FCN (å›ºå®šé…æ¯)</option>
        <option value="Floating">DRA (æµ®å‹•é…æ¯)</option>
    </select>
</div>
    <div class="input-group" title="ä¸€å€‹é€£çµæ¨™çš„æœƒæŠ“ä¸€æ¬¡API
... ä»¥æ­¤é¡æ¨"><label>è‚¡ç¥¨ä»£è™Ÿ (ç”¨é€—è™Ÿåˆ†éš”)</label><input type="text" id="symbols" value="TSLA,TSM,NVDA"></div>
    <div class="input-group" title="ä¸ä¿æœ¬å•†å“è¶…é12å€‹æœˆè¦é«˜è³‡ç”¢å®¢æˆ¶æ‰èƒ½ä¸‹å–®å”·"><label>å¤©æœŸ (æœˆ)</label><input type="number" id="months" value="6"></div>
<div class="input-group" title="é»˜èªç‚ºæ¯æœˆé…æ¯
é…æ¯é »ç‡æš«æ™‚ä¸é–‹æ”¾èª¿æ•´"><label>å¹´åŒ–é…æ¯ç‡ Coupon (%)</label><input type="number" id="coupon" value="15" step="0.01"></div>
    <div class="input-group" title="å½±éŸ¿å•†å“æ¢ä»¶æœ€å¤§çš„å› ç´ "><label>å±¥ç´„åƒ¹ Strike (%)</label><input type="number" id="strikePct" value="75"></div>
 
<div class="input-group" title="è§€å¯ŸæœŸé–“å…§æ²’æœ‰è§¸åŠä¸‹é™åƒ¹
å•†å“å°±æ²’æœ‰å¯¦ç‰©äº¤å‰²é¢¨éšª">
    <div class="label-action-group">
        <label>ä¸‹é™åƒ¹ KI (%)</label>
        <div class="mini-btn-group" data-target="kiType" title="AKIæ˜¯æ¯å¤©è§€å¯Ÿ
EKIæ˜¯æœŸæœ«è§€å¯Ÿ
NAæ˜¯ä¸è¨­å®šä¸‹é™åƒ¹">
            <div class="mini-btn active" data-value="AKI">AKI</div>
            <div class="mini-btn" data-value="EKI">EKI</div>
            <div class="mini-btn" data-value="NA">NA</div>
        </div>
        <select id="kiType" class="hidden-select">
            <option value="AKI">AKI</option>
            <option value="EKI">EKI</option>
            <option value="NA">NA</option>
        </select>
    </div>
    <input type="number" id="kiPct" value="60" style="background-color: rgb(255, 255, 255); cursor: text; opacity: 1;">
</div>
 
    <div class="input-group" title="è§€å¯ŸæœŸé–“å…§é”åˆ°æå‰å‡ºå ´æ¢ä»¶
å•†å“å°±æå‰çµæŸ">
        <div class="label-action-group">
            <label>æå‰å‡ºå ´ KO (%)</label>
            <div style="display:flex; gap:5px;">
                <div class="mini-btn-group" data-target="koFreq" title="Daily:æ¯æ—¥è§€å¯Ÿ
Monthly:æ¯æœˆè§€å¯Ÿ">
                    <div class="mini-btn active" data-value="Daily">Daily</div>
                    <div class="mini-btn" data-value="PeriodEnd">Monthly</div>
                </div>
                <div class="mini-btn-group" data-target="koMode" title="è¨˜æ†¶
æ‰€æœ‰æ¨™çš„éƒ½ã€Œæ›¾ç¶“ã€è§€å¯ŸæœŸé–“å…§ä»»ä¸€å¤©é”åˆ°æå‰å‡ºå ´
ä¸è¨˜æ†¶: è¦åŒæ™‚é”åˆ°">
                    <div class="mini-btn active warning" data-value="Memory">è¨˜æ†¶</div>
                    <div class="mini-btn" data-value="Simultaneous">ä¸è¨˜æ†¶</div>
                </div>
            </div>
            <select id="koFreq" class="hidden-select"><option value="Daily">Daily</option><option value="PeriodEnd">PeriodEnd</option></select>
            <select id="koMode" class="hidden-select"><option value="Memory">Memory</option><option value="Simultaneous">Simultaneous</option></select>
        </div>
        <input type="number" id="koPct" value="100">
    </div>
    <div class="input-group" title="ç¯„ä¾‹:
å¡«å¯«-5å°±æ˜¯æ¯æœˆéæ¸›5%
å¡«å¯«+5å°±æ˜¯æ¯æœˆéå¢5%
...ä»¥æ­¤é¡æ¨"><label>KO Step æ¯æœˆéå¢(æ¸›) (%)</label><input type="number" id="koStep" value="0" step="0.1"></div>
    <div class="input-group" title="è¨­å®šä¸Šä¸èƒ½è¶…éå¤©æœŸ"><label>ä¿è­‰é ˜æ¯æœŸé–“ (æœˆ)</label><input type="number" id="guaranteedMonths" value="1" min="1"></div>
<div style="grid-column: 1 / -1; height: 10px; border-top: 1px dashed var(--border); margin-top: 10px; padding-top: 10px;"></div>
 
<div class="input-group" title="å…è²»API:
æ¯åˆ†é˜8æ¬¡APIè«‹æ±‚
å–®æ—¥800æ¬¡">
    <label title="å…è²»API:
æ¯åˆ†é˜è·‘ä¸€æ¬¡æ¨¡å‹
å–®æ—¥ç´„å¯ä»¥è·‘130æ¬¡">
        API Key <span style="cursor:help; color:var(--primary);"></span>
    </label>
    <input type="password" id="apiKey" value="d7de0902b30e47dead805e170f78bac6" oncopy="return false" oncut="return false" placeholder="è²¼ä¸Š API Key">
</div>
<div class="input-group" title="ä½œç‚ºæ¨¡å‹çš„æŠ˜ç¾ç‡ä¾†è¨ˆç®—">
    <label>ç„¡é¢¨éšªåˆ©ç‡ (%)</label>
    <input type="number" id="riskFreeRate" value="5" step="0.1">
</div>
<div class="input-group" title="è¶Šå¤šæ¬¡è¶Šç²¾æº–
ä½†æ²’åœ¨åšç ”ç©¶ä¹Ÿæ²’å¿…è¦å¤ªå¤šæ¬¡">
    <label>æ¨¡æ“¬æ¬¡æ•¸ Simulations</label>
    <input type="number" id="simN" value="10000">
</div>
 
<div class="input-group" title="å¦‚æœæœªä¾†é€™æ®µæœŸé–“ï¼Œå¸‚å ´æ•´é«”çš„æ³¢å‹•ç¨‹åº¦æ¯”æ­·å²å¹³å‡é«˜ï¼ˆæˆ–ä½ï¼‰x% æ™‚...">
    <label title="å¦‚æœæœªä¾†é€™æ®µæœŸé–“ï¼Œå¸‚å ´æ•´é«”çš„æ³¢å‹•ç¨‹åº¦æ¯”æ­·å²å¹³å‡é«˜ï¼ˆæˆ–ä½ï¼‰x% æ™‚...">
        æ³¢å‹•åº¦å‚¾æ–œ Vol Skew (%) <span style="cursor:help; color:var(--primary);"> </span>
    </label>
    <input type="number" id="volSkew" value="0" step="1">
</div>
 
<div class="input-group" title="é‡å°å€‹è‚¡å›æ¸¬å°ˆç”¨">
    <label>æŠ€è¡“åˆ†ææœŸé–“ (å¹´)</label>
    <select id="chartYears">
        <option value="1">1 Year</option>
        <option value="2">2 Years</option>
        <option value="3">3 Years</option>
        <option value="4">4 Years</option>
        <option value="5" selected="">5 Years</option>
        <option value="7">7 Years</option>
        <option value="10">10 Years</option>
    </select>
</div>
</div>
 
        <button id="runBtn">Generate Quantitative Analysis</button>
        <div id="loading">
    <div class="loader-spinner"></div>
    <span>Calculating volatility, correlation and history...</span>
</div>
    </div>
    <div id="result-section" class="result-section">
        <div class="metrics">
<div class="metric-card" style="display: none;">
    <div class="metric-header">
        <span class="metric-title">EXPECTED PAYOFF</span>
        <span class="metric-icon">ğŸ’°</span>
    </div>
    <span id="avgReturn" class="metric-value">-</span>
    <div class="metric-subtext">é æœŸç¸½åƒ¹å€¼ (å«æ¯/æŠ˜ç¾)</div>
</div>
            <div class="metric-card orange">
                <div class="metric-header">
                    <span class="metric-icon">â³ </span><span class="metric-title">å¹³å‡å­˜çºŒæœŸé–“ AVG DURATION</span>
                </div>
                <span id="avgPeriod" class="metric-value">-</span>
                <div class="metric-subtext">åŸºæ–¼è’™åœ°å¡ç¾…æ¨¡æ“¬çµæœï¼Œè¨ˆç®—æ‰€æœ‰å¯èƒ½æƒ…å¢ƒä¹‹å¹³å‡å­˜çºŒå¤©æ•¸<br>å³ç‚ºè©²å•†å“æ¢ä»¶ä¸‹çš„ç†è«–æœŸæœ›å­˜çºŒæœŸé–“</div>
            </div>
            <div class="metric-card green">
                <div class="metric-header">
                    <span class="metric-icon">ğŸ“œ </span><span class="metric-title">
<span class="metric-title">æ­·å²æ³¢å‹•åº¦ HISTORICAL VOLATILITY</span>
                    <span id="volPeriodLabel" style="font-size:0.9rem; color:var(--text-sub);">(-)</span>
                </span></div>
                <div id="volList" class="vol-grid">
                    <div class="vol-item"><span class="vol-symbol">N/A</span><span class="vol-num">-</span></div>
                </div>
               <div class="metric-subtext"><br>é è¨­ç‚ºå°æ‡‰ç”¢å“å¤©æœŸçš„å¹´åŒ–æ­·å²æ³¢å‹•ç‡<br>å¯ä»¥è‡ªè¡Œæ›´æ”¹æ³¢å‹•ç‡å¾Œé‡æ–°è¨ˆç®— (æœ‰æ›´æ”¹æ³¢å‹•åº¦çš„æ¨™çš„æœƒé¡¯ç¤ºç´…è‰²)</div>
            </div>
 
<div class="metric-card" style="grid-column: 1 / -1; height: auto; display: flex; flex-direction: column; align-items: center;">
   
    <div class="metric-header" style="width: 100%; display: flex; justify-content: center; align-items: center; text-align: center;">
        <span class="metric-title" style="width: 100%; font-size: 16px">é¢¨éšªåˆ†æ RISK ANALYSIS (VaR &amp; CVaR)</span>
    </div>
 
    <div style="width: 100%; overflow-x: auto; padding: 0 50px; box-sizing: border-box; margin-top: 15px;">
        <table style="width: 100%; font-size: 0.9rem; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--border); color: var(--text-sub);">
                    <th style="padding: 10px; text-align: left;">ä¿¡å¿ƒæ°´æº–</th>
                    <th style="padding: 10px; text-align: center;">99%</th>
                    <th style="padding: 10px; text-align: center;">97%</th>
                    <th style="padding: 10px; text-align: center;">95%</th>
                    <th style="padding: 10px; text-align: center;">90%</th>
                    <th style="padding: 10px; text-align: center;">85%</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 10px; font-weight: bold; color: var(--danger); text-align: left;">VaR (æœ€å¤§æå¤±)</td>
                    <td id="var99" style="text-align: center;">-</td>
                    <td id="var97" style="text-align: center;">-</td>
                    <td id="var95" style="text-align: center;">-</td>
                    <td id="var90" style="text-align: center;">-</td>
                    <td id="var85" style="text-align: center;">-</td>
                </tr>
                <tr>
                    <td style="padding: 10px; font-weight: bold; color: var(--warning); text-align: left;">CVaR (æ¥µç«¯å¹³å‡)</td>
                    <td id="cvar99" style="text-align: center;">-</td>
                    <td id="cvar97" style="text-align: center;">-</td>
                    <td id="cvar95" style="text-align: center;">-</td>
                    <td id="cvar90" style="text-align: center;">-</td>
                    <td id="cvar85" style="text-align: center;">-</td>
                </tr>
            </tbody>
        </table>
    </div>
 
    <div class="metric-subtext" style="margin-top: 15px; text-align: center; width: 100%; color: var(--text-sub);">
        VaR ä»£è¡¨åœ¨è©²æ©Ÿç‡ä¸‹çš„é æœŸæœ€å¤§æå¤±ï¼›CVaR å‰‡ä»£è¡¨è‹¥ç™¼ç”Ÿæ¥µç«¯ç‹€æ³ï¼Œå¹³å‡æœƒæå¤±å¤šå°‘æœ¬é‡‘ã€‚
    </div>
</div>
        </div>
        <div class="mc-main-charts">
            <div class="card-wrapper chart-h350"><canvas id="scenarioChart"></canvas></div>
            <div class="card-wrapper chart-h350"><canvas id="worstChart"></canvas></div>
        </div>
        <div class="double-column-area">
            <div class="card-wrapper chart-auto">
                <h3 style="font-size: 1rem; text-align: left; border-left: 4px solid var(--primary); padding-left: 10px;">ç›¸é—œä¿‚æ•¸çŸ©é™£ Correlation (<span id="corPeriodLabel"></span>)</h3>
                <div id="heatmapArea" class="heatmap-container"></div>
                <p style="font-size: 1rem; color: var(--text-sub); text-align: center; margin-top: 5px;">ğŸ’¡ ç´…è‰²æ˜¯æ­£ç›¸é—œï¼Œè—è‰²æ˜¯è² ç›¸é—œï¼Œè¨ˆç®—æœŸé–“èˆ‡ç”¢å“ Duration åŒæ­¥æˆ–æ¡å…±åŒå­˜çºŒæœŸï¼ˆå°é½Šå„æ¨™çš„äº¤æ˜“æ—¥æ•¸ï¼‰ã€‚</p>
            </div>
            <div class="card-wrapper chart-auto">
                <h3 style="font-size: 1rem; text-align: left; border-left: 4px solid var(--warning); padding-left: 10px;">æ­·å²å›æ¸¬ (Historical Backtest)</h3>
                <div id="backtestInfo">
                    <div class="backtest-list">
                        <div class="backtest-item"><span class="bt-label">èµ·å§‹æ—¥ Start Date</span><span id="btStart" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">åˆ°æœŸ/å‡ºå ´æ—¥ End Date</span><span id="btEnd" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">è½é»åˆ†å¸ƒ Event</span><span id="btStatus" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">å­˜çºŒæœŸé–“ Days to Event</span><span id="btDays" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">ç¸½æç›Š Total Return</span><span id="btReturn" class="bt-value">-</span></div>
                    </div>
                </div>
                <p style="font-size: 1rem; color: var(--text-sub); text-align: center;">ğŸ’¡ ä¸€å€‹é€±æœŸ(æ¯”ç…§å¤©æœŸ)å‰ï¼Œé€²å…¥å¸‚å ´çš„å¯¦éš›è¡¨ç¾</p>
            </div>
        </div>
        <h3 style="margin-top:40px; margin-bottom:15px; border-left: 4px solid var(--primary); padding-left: 10px;">æŠ€è¡“åˆ†æ &amp; å›æ¸¬çµæœ Technical Analysis &amp; Long-term Backtesting</h3>
        <div id="techOptions">
            <label class="tech-option active"><input type="radio" name="tech" value="none" checked=""><span>çµ¦æˆ‘ä¹¾æ·¨çš„ç·šåœ–å°±å¥½</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="ma"><span>ç§»å‹•å¹³å‡ç·šMA (20/60/200)</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="bias"><span>ä¹–é›¢ç‡ BIAS 20</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="rsi"><span>ç›¸å°å¼·å¼±æŒ‡æ¨™ RSI 14</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="macd"><span>å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ç·šæŒ‡æ¨™ MACD</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="hv"><span>æ­·å²æ³¢å‹•åº¦ Hist Vol</span></label>
            <label class="tech-option level-toggle" id="lvlBtn"><input type="checkbox" id="showPriceLevels"><span>é¡¯ç¤ºKO, Strike, KIç·š</span></label>
        </div>
        <div id="stockChartsArea" class="stock-charts-area"></div>
    </div>
 
<div style="margin-top: 50px; padding: 20px 0; border-top: 1px solid #dadce0; font-family: &#39;PingFang TC&#39;, &#39;Microsoft JhengHei&#39;, sans-serif; color: #5f6368; line-height: 1.7;">
    <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <span style="color: #b71c1c; font-weight: bold; font-size: 0.9rem; letter-spacing: 1px;">RISK DISCLOSURE &amp; DISCLAIMER</span>
        <div style="flex-grow: 1; height: 1px; background-color: #eee; margin-left: 15px;"></div>
    </div>
    <h4 style="margin: 0 0 12px 0; color: #3c4043; font-size: 1rem; font-weight: 600;">âš ï¸ é‡è¦é¢¨éšªè²æ˜èˆ‡æŠ•è³‡è­¦èª</h4>
    <p style="font-size: 0.85rem; margin-bottom: 15px;">
        æœ¬æ¨¡å‹æä¾›ä¹‹åˆ†ææ•¸æ“šï¼ˆåŒ…å«ä½†ä¸é™æ–¼é æœŸå ±é…¬ã€å‹ç‡åŠå®‰å…¨æ€§åˆ†æï¼‰ä¿‚åŸºæ–¼ <span style="color: #b71c1c;"><b>è’™åœ°å¡ç¾…æ¨¡æ“¬æ¨¡å‹ (Monte Carlo Simulation)</b></span> åŠæ­·å²è‚¡åƒ¹æ•¸æ“šè¨ˆç®—è€Œæˆï¼Œä»¥æ¯æœˆå›ºå®š21å¤©é–‹ç›¤æ—¥ç‚ºå‡è¨­é‹ç®—ã€‚ç›¸é—œæ¨¡æ“¬çµæœä¹ƒå»ºç«‹åœ¨ã€Œå‡è¨­å¸‚å ´æœªä¾†æ³¢å‹•è¦å¾‹èˆ‡æ­·å²æ•¸æ“šä¸€è‡´ã€ä¹‹å‰æä¸‹ï¼Œåƒ…ä¾›å­¸è¡“ç ”ç©¶èˆ‡æŠ•è³‡åƒè€ƒï¼Œ<span style="text-decoration: underline;">ä¸¦ä¸ä»£è¡¨ã€äº¦ä¸ä¿è­‰æœªä¾†ä¹‹å¸‚å ´è¡¨ç¾æˆ–å¯¦éš›æŠ•è³‡æ”¶ç›Š</span>ã€‚</p>
    <ul style="padding-left: 18px; font-size: 0.8rem; color: #70757a; list-style-type: square;">
        <li style="margin-bottom: 6px;"><b style="color: #5f6368;">æ¨¡å‹é™åˆ¶ï¼š</b> çµ±è¨ˆæ©Ÿç‡æ¨¡å‹ç„¡æ³•é æ¸¬æ¥µç«¯é»‘å¤©éµäº‹ä»¶ã€æ”¿æ²»å‹•ç›ªæˆ–å…¬å¸çµæ§‹æ€§çªç™¼æ”¹è®Šã€‚</li>
        <li style="margin-bottom: 6px;"><b style="color: #5f6368;">æ­·å²å›æ¸¬ï¼š</b> æ­·å²ç¸¾æ•ˆåƒ…ä¾›åƒè€ƒï¼Œéå»å¸‚å ´èµ°å‹¢ä¸å¿…ç„¶æ–¼æœªä¾†é‡è¤‡ç™¼ç”Ÿã€‚</li>
        <li style="margin-bottom: 6px;"><b style="color: #5f6368;">ç”¢å“é¢¨éšªï¼š</b> FCN å±¬é«˜é¢¨éšªçµæ§‹å‹å•†å“ï¼Œæ¶‰åŠè¡ç”Ÿæ€§é‡‘èå·¥å…·äº¤æ˜“ï¼Œå¯èƒ½å°è‡´æœ¬é‡‘é‡å¤§æå¤±æˆ–æ¶‰åŠå¯¦ç‰©äº¤å‰²ã€‚</li>
        <li style="margin-bottom: 6px;"><b style="color: #5f6368;">å¯©æ…è©•ä¼°ï¼š</b> æŠ•è³‡äººæ‡‰è©³é–±å•†å“èªªæ˜æ›¸ä¸¦ç¢ºèªè‡ªèº«é¢¨éšªæ‰¿å—èƒ½åŠ›ï¼Œæœ¬å¹³å°ä¸è² æ“”ä»»ä½•æŠ•è³‡ç›ˆè™§è²¬ä»»ã€‚</li></ul>
    <div style="margin-top: 20px; padding: 10px; border: 1px solid #f1f3f4; background-color: #fafafa; font-size: 0.85rem; color: #b71c1c; text-align: center; font-weight: 500;">æŠ•è³‡ä¸€å®šæœ‰é¢¨éšªï¼ŒæŠ•è³‡å·¥å…·äº¤æ˜“æœ‰è³ºæœ‰è³ ï¼Œç”³è³¼å‰æ‡‰è©³é–±ç›¸é—œç”¢å“èªªæ˜æ›¸åŠæŠ•è³‡äººé ˆçŸ¥ï¼Œä¸¦è‡ªè¡Œè² æ“”æŠ•è³‡æç›Šè²¬ä»»ã€‚</div>
</div>
 
 
</div>
<script>
 
let mcScenarioChart = null, mcWorstChart = null; let techChartInstances = {}; let globalStockData = {}; let currentVolDays = 126; class SeededRandom {
    constructor(seed = 12345) { this.seed = seed; }
    next() {
        this.seed = (this.seed * 1664525 + 1013904223) % 4294967296;
        return this.seed / 4294967296;
    }
}
function seededRandn(rng) {
    let u = 0, v = 0;
    while (u === 0) u = rng.next();
    while (v === 0) v = rng.next();
    return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
}
 
function getCorrelation(x, y) {
    const muX = math.mean(x), muY = math.mean(y);
    const stdX = math.std(x), stdY = math.std(y);
    let sum = 0;
    for (let i = 0; i < x.length; i++) sum += (x[i] - muX) * (y[i] - muY);
    return sum / ((x.length - 1) * stdX * stdY); } const Calc = {
    MA: (p, n) => p.map((_, i) => i < n - 1 ? null : parseFloat((p.slice(i - n + 1, i + 1).reduce((a, b) => a + b) / n).toFixed(2))),
    BIAS: (p, n = 20) => { const ma = Calc.MA(p, n); return p.map((v, i) => ma[i] ? parseFloat(((v - ma[i]) / ma[i] * 100).toFixed(2)) : null); },
    RSI: (p, n = 14) => {
        let r = [null], g = [], l = [];
        for (let i = 1; i < p.length; i++) {
            let d = p[i] - p[i - 1]; g.push(Math.max(d, 0)); l.push(Math.max(-d, 0));
            if (i < n) r.push(null);
            else {
                let ag = g.slice(i - n, i).reduce((a, b) => a + b) / n;
                let al = l.slice(i - n, i).reduce((a, b) => a + b) / n;
                r.push(parseFloat((100 - (100 / (1 + ag / (al || 1)))).toFixed(2)));
            }
        } return r;
    },
    MACD: (p) => {
        const ema = (data, n) => { let k = 2 / (n + 1), r = [data[0]]; for (let i = 1; i < data.length; i++) r.push(data[i] * k + r[i - 1] * (1 - k)); return r; };
        let s = ema(p, 12), l = ema(p, 26), m = s.map((v, i) => v - l[i]), sig = ema(m, 9);
        return { macd: m, signal: sig };
    },
    HV: (p, n) => p.map((_, i) => {
        if (i < n) return null;
        let slice = p.slice(i - n, i), rets = [];
        for (let j = 1; j < slice.length; j++) rets.push(Math.log(slice[j] / (slice[j - 1] || 1)));
        return parseFloat((Math.sqrt(math.variance(rets)) * Math.sqrt(252) * 100).toFixed(2));
    })
};
 
function runSimulation(p) {
    const {S0, KO, koStep, AKI, K, V, COR, N, D, R, r, totalMonths, symbols, kiType, gMonths, koFreq, koMode} = p;
    const dim = symbols.length;
    const dt = 1/252;
    const L = dynamicCholesky(COR);
    const rng = new SeededRandom(42);
    let payoffs = [], periods = [];
    let scCounts = new Array(totalMonths + 2).fill(0);
    let worstCounts = new Array(dim).fill(0);
    const minKoDays = gMonths * 21;
   
    // ç²å–é…æ¯æ¨¡å¼ (å¾ UI è®€å–ï¼Œè‹¥ç„¡æ­¤ UI å‰‡é è¨­ç‚º Fixed)
    const couponType = document.getElementById('couponType') ? document.getElementById('couponType').value : "Fixed";
 
    for (let n = 0; n < N; n++) {
        let St = [...S0];
        let kiTouched = (kiType === "NA");
        let ended = false;
        let koReachedEver = new Array(dim).fill(false);
       
        // ç´¯è¨ˆåˆ©æ¯è¨ˆæ•¸
        let accruedCouponDays = 0;
       
        for (let d = 1; d <= D; d++) {
            let rawZ = Array.from({length: dim}, () => seededRandn(rng));
            let dz = new Array(dim).fill(0);
            for (let i = 0; i < dim; i++) {
                for (let j = 0; j <= i; j++) { dz[i] += L[i][j] * rawZ[j]; }
            }
            for (let i = 0; i < dim; i++) {
                St[i] *= Math.exp((r - 0.5 * V[i]**2) * dt + V[i] * Math.sqrt(dt) * dz[i]);
                if (kiType === "AKI" && St[i] < AKI[i]) kiTouched = true;
            }
 
            // --- æµ®å‹•é…æ¯è¨ˆç®—é‚è¼¯ ---
            let isGuaranteed = d <= minKoDays;
            let allAboveStrike = St.every((s, i) => s >= K[i]);
           
            if (couponType === "Fixed" || isGuaranteed || allAboveStrike) {
                accruedCouponDays++;
            }
            // -----------------------
 
            // KO é‚è¼¯
            let currentStepIdx = Math.floor((d - 1) / 21);
            let currentStepShift = 1 + (currentStepIdx * koStep);
            let currentKO = KO.map(baseKO => baseKO * currentStepShift);
 
            if (d >= minKoDays) {
                for (let i = 0; i < dim; i++) {
                    if (St[i] >= currentKO[i]) koReachedEver[i] = true;
                }
 
                let isObservationDay = (koFreq === "Daily") ? true : (d % 21 === 0);
                if (isObservationDay) {
                    let isKoTriggered = (koMode === "Memory") ?
                        koReachedEver.every(v => v === true) :
                        St.every((s, i) => s >= currentKO[i]);
 
                    if (isKoTriggered) {
                        // ç¥¨æ¯è¨ˆç®—ï¼šä½¿ç”¨å¯¦éš›ç´¯è¨ˆçš„å¤©æ•¸
                        let payoff = 100 * (1 + (accruedCouponDays / 252) * R) * Math.exp(-r * (d / 252));
                        payoffs.push(payoff);
                        periods.push(d);
                        let mIdx = Math.min(Math.floor((d - 1) / 21), totalMonths - 1);
                        scCounts[mIdx]++;
                        ended = true;
                        break;
                    }
                }
            }
 
            // åˆ°æœŸè™•ç†
            if (d === D && !ended) {
                if (kiType === "EKI" && St.some((s, i) => s < AKI[i])) kiTouched = true;
                let disc = Math.exp(-r * (D / 252));
                let totalCoupon = (accruedCouponDays / 252) * R;
               
                if (!kiTouched || St.every((s, i) => s >= K[i])) {
                    payoffs.push(100 * (1 + totalCoupon) * disc);
                    scCounts[totalMonths]++;
                } else {
                    let perf = St.map((s, i) => s / S0[i]);
                    let mP = Math.min(...perf);
                    let worstAssetIdx = perf.indexOf(mP);
                    worstCounts[worstAssetIdx]++;
                    // å¯¦ç‰©äº¤å‰²ï¼šç´¯è¨ˆåˆ©æ¯ + æœ€å·®è³‡ç”¢åƒ¹å€¼
                    payoffs.push((100 * totalCoupon + 100 * (St[worstAssetIdx] / K[worstAssetIdx])) * disc);
                    scCounts[totalMonths + 1]++;
                }
                periods.push(D);
            }
        }
    }
 
    // è¨ˆç®—é¢¨éšªæŒ‡æ¨™ VaR / CVaR
    const sortedPayoffs = [...payoffs].sort((a, b) => a - b);
    const riskData = {};
    [0.01, 0.03, 0.05, 0.10, 0.15].forEach(alpha => {
        const index = Math.max(0, Math.floor(N * alpha));
        const label = Math.round((1 - alpha) * 100);
        const varVal = sortedPayoffs[index] - 100;
        riskData[`VaR${label}`] = varVal;
        const worstPaths = sortedPayoffs.slice(0, index + 1);
        const avgPayoff = worstPaths.reduce((a, b) => a + b, 0) / (worstPaths.length || 1);
        riskData[`CVaR${label}`] = avgPayoff - 100;
    });
 
    return {
        avgReturn: (math.mean(payoffs) - 100),
        avgDay: math.mean(periods),
        scenarioProbs: scCounts.map(c => (c / N) * 100),
        worstAssetProbs: worstCounts.map(c => (c / N) * 100),
        riskResults: riskData
    };
}
 
function runBacktest(p) {
    const {symbols, D, R, totalMonths, kiType, koFreq, gMonths, koMode, koStep} = p;
   
    const histLen = globalStockData[symbols[0]].prices.length;
    const startIndex = histLen - D - 1;
    if (startIndex < 0) {
        console.error("æ­·å²æ•¸æ“šé•·åº¦ä¸è¶³ä»¥é€²è¡Œå›æ¸¬");
        return;
    }
   
    const startPrices = symbols.map(s => globalStockData[s].prices[startIndex]);
    const KO_Pct = parseFloat(document.getElementById('koPct').value) / 100;
    const KI_Pct = parseFloat(document.getElementById('kiPct').value) / 100;
    const Strike_Pct = parseFloat(document.getElementById('strikePct').value) / 100;
   
    const baseKO = startPrices.map(s => s * KO_Pct);
    const AKI = startPrices.map(s => s * KI_Pct);
    const K = startPrices.map(s => s * Strike_Pct);
    const minKoDays = gMonths * 21;
    const couponType = document.getElementById('couponType') ? document.getElementById('couponType').value : "Fixed";
   
    let kiTouched = (kiType === "NA");
    let event = "Maturity (åˆ°æœŸ)";
    let daysToEvent = D;
    let finalPayoff = 0;
    let koReachedEver = new Array(symbols.length).fill(false);
   
    // ç´¯è¨ˆå›æ¸¬åˆ©æ¯
    let accruedCouponDays = 0;
 
    for (let d = 1; d <= D; d++) {
        const currentIndex = startIndex + d;
        const currentPrices = symbols.map(s => globalStockData[s].prices[currentIndex]);
 
        // --- æµ®å‹•é…æ¯è¨ˆç®—é‚è¼¯ ---
        let isGuaranteed = d <= minKoDays;
        let allAboveStrike = currentPrices.every((price, i) => price >= K[i]);
        if (couponType === "Fixed" || isGuaranteed || allAboveStrike) {
            accruedCouponDays++;
        }
        // -----------------------
 
        let currentStepIdx = Math.floor((d - 1) / 21);
        let currentKO = baseKO.map(b => b * (1 + currentStepIdx * koStep));
 
        if (kiType === "AKI" && currentPrices.some((price, i) => price < AKI[i])) {
            kiTouched = true;
        }
 
        let isObservationDay = (koFreq === "Daily") ? (d >= minKoDays) : (d >= minKoDays && d % 21 === 0);
 
        if (isObservationDay) {
            for (let i = 0; i < symbols.length; i++) {
                if (currentPrices[i] >= currentKO[i]) koReachedEver[i] = true;
            }
 
            let isKoTriggered = (koMode === "Memory")
                ? koReachedEver.every(reached => reached === true)
                : currentPrices.every((price, i) => price >= currentKO[i]);
 
            if (isKoTriggered) {
                event = `KO æå‰å‡ºå ´ (ç¬¬ ${d} å¤©æå‰å‡ºå ´)`;
                daysToEvent = d;
                finalPayoff = 100 * (1 + (accruedCouponDays / 252) * R);
                break;
            }
        }
 
        if (d === D) {
            if (kiType === "EKI" && currentPrices.some((s, i) => s < AKI[i])) {
                kiTouched = true;
            }
            let totalCoupon = (accruedCouponDays / 252) * R;
            if (!kiTouched || currentPrices.every((s, i) => s >= K[i])) {
                event = "Full Repayment (æ»¿æœŸè´–å›)";
                finalPayoff = 100 * (1 + totalCoupon);
            } else {
                event = "KI Delivery (å¯¦ç‰©äº¤å‰²)";
                const perf = currentPrices.map((s, i) => s / K[i]);
                const worstPerf = Math.min(...perf);
                finalPayoff = (100 * totalCoupon) + (100 * worstPerf);
            }
        }
    }
 
    document.getElementById('btStart').innerText = globalStockData[symbols[0]].labels[startIndex];
    document.getElementById('btEnd').innerText = globalStockData[symbols[0]].labels[startIndex + daysToEvent];
    document.getElementById('btStatus').innerText = event;
    document.getElementById('btDays').innerText = `${daysToEvent} Days`;
    document.getElementById('btReturn').innerText = (finalPayoff - 100).toFixed(2) + "%";
    document.getElementById('btReturn').style.color = (finalPayoff >= 100) ? "var(--success)" : "var(--danger)";
}
 
function dynamicCholesky(A) {
    const n = A.length; let L = Array.from({length: n}, () => new Array(n).fill(0));
    for (let i = 0; i < n; i++) { for (let j = 0; j <= i; j++) {
        let s = 0; for (let k = 0; k < j; k++) s += L[i][k] * L[j][k];
        L[i][j] = (i === j) ? Math.sqrt(Math.max(A[i][i] - s, 0)) : (1.0 / L[j][j] * (A[i][j] - s));
    } } return L;
}
 
function renderMCResults(res, params) {
    if (window.mcScenarioChart instanceof Chart) window.mcScenarioChart.destroy();
    if (window.mcWorstChart instanceof Chart) window.mcWorstChart.destroy();
  
    if (typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
   }
    const avgRet = res.avgReturn || 0;
    const avgReturnElem = document.getElementById('avgReturn');
    const hiddenReturnElem = document.getElementById('hiddenReturn');
    if (avgReturnElem) {
        avgReturnElem.innerText = (avgRet >= 0 ? '+' : '') + avgRet.toFixed(2) + "%";
        avgReturnElem.style.color = avgRet >= 0 ? "var(--success)" : "var(--danger)";
    }
    if (hiddenReturnElem) {
        const expectedTotalValue = 100 + avgRet;
        hiddenReturnElem.innerText = `Âµ: ${expectedTotalValue.toFixed(2)}`;
        hiddenReturnElem.style.display = 'inline-block';
        hiddenReturnElem.style.visibility = 'visible';
    }
    const avgDayElem = document.getElementById('avgPeriod');
    if (avgDayElem) {
        avgDayElem.innerText = (res.avgDay || 0).toFixed(1) + " Days";
       
        if (avgDayElem.parentElement) {
            avgDayElem.parentElement.style.height = '';
            avgDayElem.parentElement.style.display = 'flex';
            avgDayElem.parentElement.style.flexDirection = 'column';
        }
 
        Object.assign(avgDayElem.style, {
            borderTop: "1px dashed #ccc",
            marginTop: "15px",
            paddingTop: "25px",
            paddingBottom: "10px",
            width: "100%",
            textAlign: "center",  
            fontSize: "1.8em",
            fontWeight: "bold",
            color: "var(--primary)",
            display: "block"  
        });
    }
    // 2. é¢¨éšªæŒ‡æ¨™ VaR / CVaR
    const riskLevels = [99, 97, 95, 90, 85];
    riskLevels.forEach(lvl => {
        const varVal = (res.riskResults && res.riskResults[`VaR${lvl}`] !== undefined) ? res.riskResults[`VaR${lvl}`] : 0;
        const cvarVal = (res.riskResults && res.riskResults[`CVaR${lvl}`] !== undefined) ? res.riskResults[`CVaR${lvl}`] : 0;
      
        const varElem = document.getElementById(`var${lvl}`);
        const cvarElem = document.getElementById(`cvar${lvl}`);
        if (varElem) {
            varElem.innerText = varVal.toFixed(2) + "%";
            varElem.style.color = varVal < 0 ? "var(--danger)" : "var(--success)";
        }
        if (cvarElem) {
            cvarElem.innerText = cvarVal.toFixed(2) + "%";
            cvarElem.style.color = cvarVal < 0 ? "var(--danger)" : "var(--success)";
        }
    });
    // 3. æ›´æ–°æ³¢å‹•ç‡åˆ—è¡¨ (ç¶­æŒç´…è‰²æ¨™è¨˜èˆ‡å°é½ŠåŠŸèƒ½)
    const volList = document.getElementById('volList');
    if (volList && params.symbols && params.V) {
        volList.style.display = 'flex';
        volList.style.flexWrap = 'wrap';
        volList.style.justifyContent = 'center';
        volList.style.gap = '20px';
       
        volList.innerHTML = params.symbols.map((s, i) => {
            const isModified = params.modifiedFlags ? params.modifiedFlags[i] : false;
            return `<div class="vol-item" style="display: flex; flex-direction: column; align-items: center; min-width: 80px;">
                <span class="vol-symbol" style="font-weight: bold; font-size: 1.1em; margin-bottom: 8px; color: ${isModified ? '#dc3545' : 'inherit'}; transition: color 0.3s;">${s}</span>
                <div style="display:flex; align-items:center; justify-content: center;">
                    <input type="number" class="vol-input" data-symbol="${s}"
                           value="${(params.V[i]*100).toFixed(2)}" step="0.1"
                           style="width: 70px; text-align: right; border: 1px solid #ccc; border-radius: 4px; padding: 4px 2px 4px 4px; font-weight: bold; color: var(--primary);">
                    <span style="margin-left: 4px; font-size: 0.9em;">%</span>
                </div>
             </div>`;
        }).join('');
    }
    // 4. ç¹ªè£½åœ–è¡¨ (ç¶­æŒæ›è¡Œè¨­è¨ˆ)
    const ctxScenario = document.getElementById('scenarioChart');
    if (ctxScenario) {
        const scenarioLabels = [...Array(params.totalMonths).keys()]
            .map(i => [`KO`, `M${i+1}`])
            .concat([
                ["åˆ°æœŸ", "ç¾é‡‘"],
                ["å¯¦ç‰©", "å±¥ç´„"]
            ]);
 
        window.mcScenarioChart = new Chart(ctxScenario, {
            type: 'bar',
            data: {
                labels: scenarioLabels,
                datasets: [{
                    label: 'æ©Ÿç‡ (%)',
                    data: (res.scenarioProbs || []).map(v => v.toFixed(2)),
                    backgroundColor: '#1a73e8'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    datalabels: {
                        display: true, anchor: 'end', align: 'top', offset: 2, color: '#000000',
                        formatter: v => v > 0 ? v + '%' : '',
                        font: { weight: 'bold', size: 14 }
                    },
                    legend: { display: false },
                    title: { display: true, text: 'è’™åœ°å¡ç¾…æ¨¡æ“¬æ©Ÿç‡åˆ†å¸ƒ', font: { size: 16 } }
                },
                scales: {
                    x: { ticks: { maxRotation: 0, minRotation: 0, autoSkip: false, font: { size: 12 } } },
                    y: { beginAtZero: true, suggestedMax: Math.max(...(res.scenarioProbs || [100])) * 1.2 }
                }
            }
        });
    }
    // 5. ç¹ªè£½åœ“é¤…åœ–
    const ctxWorst = document.getElementById('worstChart');
    if (ctxWorst) {
        window.mcWorstChart = new Chart(ctxWorst, {
            type: 'pie',
            data: {
                labels: params.symbols,
                datasets: [{
                    data: (res.worstAssetProbs || []).map(v => v.toFixed(2)),
                    backgroundColor: ['#ea4335', '#f9ab00', '#34a853', '#4285f4', '#9334e6']
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    datalabels: {
                        display: true, color: '#fff',
                        formatter: v => v > 0 ? v + '%' : '',
                        font: { weight: 'bold' , size: 13 }
                    },
                    title: { display: true, text: 'ULå¯¦ç‰©å±¥ç´„æ©Ÿç‡åˆ†ä½ˆ', font: { size: 16 } }
                }
            }
        });
    }
}
 
 
 
function renderCorrelationHeatmap(symbols, corMat) {
    const container = document.getElementById('heatmapArea'); container.innerHTML = '';
    const size = symbols.length; const grid = document.createElement('div');
    grid.className = 'heatmap-grid'; grid.style.gridTemplateColumns = `repeat(${size + 1}, auto)`;
    grid.appendChild(document.createElement('div'));
    symbols.forEach(s => { const label = document.createElement('div'); label.className = 'heatmap-label'; label.innerText = s; grid.appendChild(label); });
    for (let i = 0; i < size; i++) {
        const label = document.createElement('div'); label.className = 'heatmap-label'; label.style.display = 'flex'; label.style.alignItems = 'center'; label.innerText = symbols[i]; grid.appendChild(label);
        for (let j = 0; j < size; j++) {
            const val = corMat[i][j]; const cell = document.createElement('div'); cell.className = 'heatmap-cell'; cell.innerText = val.toFixed(2);
            let r, g, b; if (val >= 0) { r = 234; g = Math.round(67 + (185 * (1 - val))); b = Math.round(53 + (200 * (1 - val))); } else { r = Math.round(26 + (200 * (1 + val))); g = Math.round(115 + (100 * (1 + val))); b = 232; }
            cell.style.backgroundColor = `rgb(${r},${g},${b})`; grid.appendChild(cell);
        }
    }
    container.appendChild(grid);
}
function initTechCharts(symbols) {
const container = document.getElementById('stockChartsArea');
    // --- é—œéµï¼šæ¸…ç©º HTML å…§å®¹ï¼Œé˜²æ­¢æ¨™ç±¤é‡è¤‡ç–ŠåŠ  ---
    container.innerHTML = '';
    const area = document.getElementById('stockChartsArea');
    area.innerHTML = '';
    symbols.forEach(s => {
        const card = document.createElement('div');
        card.className = 'stock-card';
        card.innerHTML = `<h3 style="color:var(--primary); margin-top:0;">${s} æ­·å²æ•¸æ“šèˆ‡å›æ¸¬åˆ†æ</h3>
            <div class="canvas-container"><canvas id="chart_${s}"></canvas></div>
            <div id="stats_${s}" class="stats-panel"></div>
            <div id="backtest_long_${s}" class="long-term-panel"></div>
            <div class="analysis-grid-row">
                <div id="safety_analysis_${s}" class="safety-analysis-panel"></div>
                <div id="recovery_analysis_${s}" class="recovery-analysis-panel"></div>
            </div>`;
        area.appendChild(card);
        updateSingleStockChart(s);
    });
}
function updateSingleStockChart(symbol) {
    const data = globalStockData[symbol];
    const years = parseInt(document.getElementById('chartYears').value);
    const months = parseInt(document.getElementById('months').value);
    const holdDays = months * 21;
    const displayCount = years * 252;
    const allPrices = data.prices;
    const labels = data.labels;
  
    const displayPrices = allPrices.slice(-displayCount);
    const displayVolumes = data.volumes.slice(-displayCount);
    const displayLabels = labels.slice(-displayCount);
    const selectedTech = document.querySelector('input[name="tech"]:checked').value;
    const showLevels = document.getElementById('showPriceLevels').checked;
    const S0 = displayPrices[displayPrices.length - 1];
    const koPrice = S0 * (document.getElementById('koPct').value / 100);
    const strikePrice = S0 * (document.getElementById('strikePct').value / 100);
    const kiPrice = S0 * (document.getElementById('kiPct').value / 100);
    const datasets = [{ label: "Close Price", data: displayPrices, borderColor: "#1a73e8", borderWidth: 2, pointRadius: 0, fill: false, yAxisID: 'y' }];
    const scales = { y: { position: 'left', ticks:{color: '#202124'}, grid:{color:'#edf2f7'}, grace: '5%' }, yVol: { position: 'right', display: false }, x: { ticks:{color: '#5f6368'}, grid:{display:false} } };
    datasets.push({ type: 'bar', label: "Volume", data: displayVolumes, backgroundColor: 'rgba(26,115,232,0.08)', yAxisID: 'yVol' });
  
    if(showLevels) {
        const line = (val, label, color) => ({ label, data: new Array(displayPrices.length).fill(val), borderColor: color, borderDash: [4, 4], borderWidth: 1.5, pointRadius: 0, fill: false });
        datasets.push(line(koPrice, `KO (${koPrice.toFixed(1)})`, '#f29900'));
        datasets.push(line(strikePrice, `Strike (${strikePrice.toFixed(1)})`, '#188038'));
        datasets.push(line(kiPrice, `KI (${kiPrice.toFixed(1)})`, '#d93025'));
      
        const dStrike = displayPrices.filter(p => p < strikePrice).length;
        const dKI = displayPrices.filter(p => p < kiPrice).length;
        document.getElementById(`stats_${symbol}`).innerHTML = `
            <div class="stat-box"><span class="stat-label">åˆ†ææœŸé–“äº¤æ˜“æ—¥ (${years}Y)</span><span class="stat-num">${displayPrices.length}</span></div>
            <div class="stat-box"><span class="stat-label">æ”¶ç›¤ < Strike å¤©æ•¸</span><span class="stat-num" style="color:var(--success)">${dStrike} (${(dStrike/displayPrices.length*100).toFixed(1)}%)</span></div>
            <div class="stat-box"><span class="stat-label">æ”¶ç›¤ < KI å¤©æ•¸</span><span class="stat-num" style="color:var(--danger)">${dKI} (${(dKI/displayPrices.length*100).toFixed(1)}%)</span></div>`;
    }
    if(selectedTech !== 'none') {
        scales.yInd = { position: 'right', ticks:{color:'#5f6368'}, grid:{drawOnChartArea:false} };
        if(selectedTech === 'ma') {
            datasets.push({ label: "MA20", data: Calc.MA(allPrices, 20).slice(-displayCount), borderColor: "#f9ab00", borderWidth: 1, pointRadius: 0, yAxisID: 'yInd' });
            datasets.push({ label: "MA60", data: Calc.MA(allPrices, 60).slice(-displayCount), borderColor: "#34a853", borderWidth: 1, pointRadius: 0, yAxisID: 'yInd' });
            datasets.push({ label: "MA200", data: Calc.MA(allPrices, 200).slice(-displayCount), borderColor: "#a142f4", borderWidth: 1, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'bias') {
            datasets.push({ label: "BIAS(20)", data: Calc.BIAS(allPrices, 20).slice(-displayCount), borderColor: "#33bf00", borderWidth: 2, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'rsi') {
            datasets.push({ label: "RSI(14)", data: Calc.RSI(allPrices).slice(-displayCount), borderColor: "#e67c73", borderWidth: 1.5, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'macd') {
            const m = Calc.MACD(allPrices);
            datasets.push({ label: "MACD", data: m.macd.slice(-displayCount), borderColor: "#a142f4", borderWidth: 1.5, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'hv') {
            datasets.push({ label: `HV`, data: Calc.HV(allPrices, currentVolDays).slice(-displayCount), borderColor: "#5f6368", borderWidth: 2, pointRadius: 0, yAxisID: 'yInd' });
        }
    }
    // --- ã€æ ¸å¿ƒé‚è¼¯ä¿®æ”¹ã€‘é•·æœŸå›æ¸¬çµ±è¨ˆ & å®‰å…¨æ€§åˆ†æ ---
    const kiThreshold = parseFloat(document.getElementById('kiPct').value) / 100;
    const strikeThreshold = parseFloat(document.getElementById('strikePct').value) / 100;
  
    // åš´æ ¼å°‡åˆ†ææ¨£æœ¬é™åˆ¶åœ¨ displayPrices (ä¾‹å¦‚ 5 å¹´) ç¯„åœå…§
    const analysisPrices = displayPrices;
    const totalAvailableDays = analysisPrices.length;
  
    let upCount = 0, totalScenarios = 0, returns = [];
    let touchKICount = 0, endBelowStrikeCount = 0;
    let expiredBelowStrikeCases = 0;
    let postExpiryRecoveryDaysList = [];
    let currentlyStillUnrecoveredCount = 0;
    // è¿´åœˆçµ‚é»ï¼štotalAvailableDays - holdDays
    // é€™æ¨£æœ€å¾Œä¸€å€‹é€²å ´é» i çš„åˆ°æœŸæ—¥å‰›å¥½æ˜¯ analysisPrices çš„æœ€å¾Œä¸€å¤© (ä»Šå¤©)
    for (let i = 0; i <= totalAvailableDays - holdDays; i++) {
        const entry = analysisPrices[i];
        const strikeVal = entry * strikeThreshold;
        const windowPrices = analysisPrices.slice(i + 1, i + holdDays + 1);
        const expiryPrice = windowPrices[windowPrices.length - 1];
       
        const change = (expiryPrice - entry) / entry;
        returns.push(change);
        if (change > 0) upCount++;
        if (windowPrices.some(p => p < entry * kiThreshold)) touchKICount++;
       
        if (expiryPrice < strikeVal) {
            endBelowStrikeCount++;
            expiredBelowStrikeCases++;
          
            // è¨ˆç®—è©²åˆ°æœŸæ—¥åœ¨ allPrices ä¸­çš„å…¨å±€ç´¢å¼•ï¼Œä»¥ä¾¿åˆ©ç”¨å‰©é¤˜çš„æ‰€æœ‰æ­·å²æ•¸æ“šè§€å¯Ÿæ¢å¾©ç‹€æ³
            const expiryGlobalIdx = (allPrices.length - totalAvailableDays) + i + holdDays;
            const futurePrices = allPrices.slice(expiryGlobalIdx);
            const recoverIdx = futurePrices.findIndex(p => p >= strikeVal);
          
            if (recoverIdx !== -1) {
                postExpiryRecoveryDaysList.push(recoverIdx);
            } else {
                currentlyStillUnrecoveredCount++;
            }
        }
        totalScenarios++;
    }
    const winRate = totalScenarios > 0 ? (upCount / totalScenarios * 100).toFixed(1) : 0;
    const avgRet = returns.length > 0 ? (returns.reduce((a, b) => a + b) / returns.length * 100).toFixed(2) : 0;
    const maxRet = returns.length > 0 ? (Math.max(...returns) * 100).toFixed(2) : 0;
    const minRet = returns.length > 0 ? (Math.min(...returns) * 100).toFixed(2) : 0;
    const kiProb = totalScenarios > 0 ? (touchKICount / totalScenarios * 100).toFixed(1) : 0;
    const strikeProb = totalScenarios > 0 ? (endBelowStrikeCount / totalScenarios * 100).toFixed(1) : 0;
    const avgRecoveryDays = postExpiryRecoveryDaysList.length > 0 ? (postExpiryRecoveryDaysList.reduce((a,b)=>a+b)/postExpiryRecoveryDaysList.length).toFixed(1) : "N/A";
    const stillUnrecoveredPct = expiredBelowStrikeCases > 0 ? (currentlyStillUnrecoveredCount / expiredBelowStrikeCases * 100).toFixed(1) : 0;
    // å–å¾—èµ·å§‹èˆ‡çµæŸé€²å ´æ—¥æœŸ
    const firstEntryDate = displayLabels[0];
    const lastEntryDate = displayLabels[totalAvailableDays - holdDays];
 
    document.getElementById(`backtest_long_${symbol}`).innerHTML = `
        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--primary);">ğŸ“Š æŒæœ‰ ${months} å€‹æœˆä¹‹é•·æœŸå›æ¸¬çµ±è¨ˆ (éå» ${years} å¹´æ•¸æ“š)</h4>
        <p style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 10px;">é€²å ´æ¨£æœ¬å€é–“ï¼š${firstEntryDate} è‡³ ${lastEntryDate} (å…± ${totalScenarios} å€‹æ¨£æœ¬)</p>
        <div class="stats-panel" style="grid-template-columns: repeat(4, 1fr);">
            <div class="stat-box" style="background: ${winRate >= 50 ? '#e6f4ea' : '#fce8e6'}">
                <span class="stat-label">å‹ç‡ (Win Rate)</span>
                <span class="stat-num" style="color: ${winRate >= 50 ? 'var(--success)' : 'var(--danger)'}">${winRate}%</span>
            </div>
            <div class="stat-box"><span class="stat-label">å¹³å‡å ±é…¬</span><span class="stat-num">${avgRet}%</span></div>
            <div class="stat-box"><span class="stat-label">æœ€ä½³å ±é…¬</span><span class="stat-num" style="color:var(--success)">${maxRet}%</span></div>
            <div class="stat-box"><span class="stat-label">æœ€å·®å ±é…¬</span><span class="stat-num" style="color:var(--danger)">${minRet}%</span></div>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-sub); margin-top: 10px; line-height: 1.4;">
            ğŸ’¡ <b>è¨ˆç®—é‚è¼¯ï¼š</b> æ¨¡å‹åˆ†æäº† ${years} å¹´å…§æ¯ä¸€å€‹å…·å‚™å®Œæ•´æŒæœ‰æœŸé–“çš„äº¤æ˜“æ—¥ï¼Œä¸¦å›ºå®šæŒæœ‰ ${holdDays} å€‹äº¤æ˜“æ—¥ã€‚åœ¨ç¸½è¨ˆ ${totalScenarios} å€‹æ¸¬è©¦æ¨£æœ¬ä¸­ï¼Œæœ‰ ${upCount} æ¬¡åœ¨æŒæœ‰çµæŸå¾Œè‚¡åƒ¹é«˜æ–¼è²·å…¥åƒ¹ã€‚
        </p>`;
    document.getElementById(`safety_analysis_${symbol}`).innerHTML = `
        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--danger);">ğŸ›¡ï¸ å®‰å…¨æ€§åˆ†æ (æŒæœ‰æœŸå…§é¢¨éšª)</h4>
        <div class="stats-panel" style="grid-template-columns: repeat(2, 1fr);">
            <div class="stat-box" style="background: #fff5f5;">
                <span class="stat-label">æ›¾è§¸åŠ KI ä¹‹æ©Ÿç‡</span>
                <span class="stat-num" style="color: var(--danger)">${kiProb}%</span>
            </div>
            <div class="stat-box" style="background: #fff9f0;">
                <span class="stat-label">åˆ°æœŸä½æ–¼ Strike æ©Ÿç‡</span>
                <span class="stat-num" style="color: var(--warning)">${strikeProb}%</span>
            </div>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-sub); margin-top: 10px; line-height: 1.4;">
            ğŸ’¡ <b>é¢¨éšªè©•ä¼°ï¼š</b> åŸºæ–¼ ${totalScenarios} å€‹æ­·å²é€²å ´é»ã€‚æ›¾è§¸åŠ KI è¡¨ç¤ºè©²æœŸé–“å…§è‚¡åƒ¹æ›¾è·Œè‡³é€²å ´åƒ¹çš„ ${document.getElementById('kiPct').value}% ä»¥ä¸‹ï¼›è€Œåˆ°æœŸä½æ–¼ Strike è¡¨ç¤ºå›æ¸¬è³‡æ–™å…§è‚¡åƒ¹åœ¨åˆ°æœŸæ—¥è·Œç ´ ${document.getElementById('strikePct').value}% ä»¥ä¸‹çš„æ¦‚ç‡ã€‚
        </p>`;
    document.getElementById(`recovery_analysis_${symbol}`).innerHTML = `
        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: #673ab7;">ğŸ’Š æ¢å¾©åŠ›åˆ†æ (è‹¥åˆ°æœŸä½æ–¼ Strike éœ€å¤šä¹…è§£å¥—)</h4>
        <div class="stats-panel" style="grid-template-columns: repeat(2, 1fr);">
            <div class="stat-box" style="background: #f3e5f5;">
                <span class="stat-label">å¹³å‡è§£å¥—å¤©æ•¸ (åˆ°æœŸå¾Œ)</span>
                <span class="stat-num" style="color: #673ab7">${avgRecoveryDays} å¤©</span>
            </div>
            <div class="stat-box" style="background: #fafafa;">
                <span class="stat-label">è‡³ä»Šä»æœªæ¼²å›æ¯”ä¾‹</span>
                <span class="stat-num" style="color: #444">${stillUnrecoveredPct}%</span>
            </div>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-sub); margin-top:8px;">ğŸ’¡ åŸºæ–¼ ${totalScenarios} æ¬¡å›æ¸¬è³‡æ–™å…§ï¼Œåˆ†æç•¶åˆ°æœŸè‚¡åƒ¹ä½æ–¼å±¥ç´„åƒ¹æ™‚ï¼Œè¦é‡æ–°ç«™å›è©²å±¥ç´„åƒ¹æ‰€éœ€çš„å¤©æ•¸ã€‚</p>`;
    const ctx = document.getElementById(`chart_${symbol}`).getContext('2d');
    if(techChartInstances[symbol]) techChartInstances[symbol].destroy();
    techChartInstances[symbol] = new Chart(ctx, {
        type: 'line',
        data: { labels: displayLabels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales,
            plugins: {
                datalabels: { display: false },
                legend: { labels: { boxWidth: 10, font: { size: 11 } } },
                zoom: { pan: { enabled: true, mode: 'x' }, zoom: {wheel: { enabled: true },pinch: { enabled: true }, mode: 'x', overScaleMode: 'y'}} }} });}
document.getElementById('techOptions').addEventListener('change', (e) => {
    if (e.target.name === 'tech') {
        document.querySelectorAll('.tech-option:not(.level-toggle)').forEach(el => el.classList.remove('active'));
        e.target.closest('.tech-option').classList.add('active');}
    if (e.target.id === 'showPriceLevels') {
        document.getElementById('lvlBtn').classList.toggle('active', e.target.checked);
    }
    Object.keys(techChartInstances).forEach(s => updateSingleStockChart(s));});
document.getElementById('chartYears').addEventListener('change', () => {
    if (Object.keys(globalStockData).length > 0) {
        Object.keys(techChartInstances).forEach(s => updateSingleStockChart(s));}});
document.getElementById('months').addEventListener('change', () => {
    if (Object.keys(globalStockData).length > 0) {
        Object.keys(techChartInstances).forEach(s => updateSingleStockChart(s));}});
// åˆå§‹åŒ–å°æŒ‰éˆ•åˆ‡æ›é‚è¼¯
document.querySelectorAll('.mini-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const group = this.parentElement;
        const targetId = group.getAttribute('data-target');
        const val = this.getAttribute('data-value');
       
        // åˆ‡æ›è¦–è¦ºç‹€æ…‹
        group.querySelectorAll('.mini-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
       
        // åŒæ­¥æ•¸å€¼åˆ°åŸæœ¬çš„éš±è— Select
        const select = document.getElementById(targetId);
        if (select) {
            select.value = val;
            // è§¸ç™¼åŸæœ‰çš„è®Šæ›´äº‹ä»¶(å¦‚æœæœ‰çš„è©±)
            select.dispatchEvent(new Event('change'));
        }
    });
});
 
const apiKeyInput = document.getElementById('apiKey');
 
apiKeyInput.addEventListener('copy', (e) => {
    e.preventDefault();
    alert('ç‚ºäº†å®‰å…¨èµ·è¦‹ï¼ŒAPI Key ä¸å…è¨±è¤‡è£½ã€‚');
});
 
apiKeyInput.addEventListener('cut', (e) => {
    e.preventDefault();
});
 
apiKeyInput.addEventListener('paste', (e) => {
    console.log("API Key å·²æ›´æ–°");
});
 
// æ–°å¢ï¼šè™•ç† KI æ¬„ä½é€£å‹•åç°é‚è¼¯
function updateKIFieldStatus(val) {
    const kiInput = document.getElementById('kiPct');
    if (val === "NA") {
        kiInput.disabled = true;
        kiInput.style.backgroundColor = "#e9ecef"; // ç°åº•
        kiInput.style.cursor = "not-allowed";
        kiInput.style.opacity = "0.6";
    } else {
        kiInput.disabled = false;
        kiInput.style.backgroundColor = "#fff"; // ç™½åº•
        kiInput.style.cursor = "text";
        kiInput.style.opacity = "1";
    }
}
 
// åˆå§‹åŒ–èˆ‡ç›£è½æŒ‰éˆ•é»æ“Š
document.querySelectorAll('.mini-btn[data-value]').forEach(btn => {
    btn.addEventListener('click', function() {
        const group = this.parentElement;
        const targetId = group.getAttribute('data-target');
        const val = this.getAttribute('data-value');
       
        // å¦‚æœé»æ“Šçš„æ˜¯ kiType çš„åˆ‡æ›æŒ‰éˆ•ï¼ŒåŸ·è¡Œé€£å‹•é‚è¼¯
        if (targetId === "kiType") {
            updateKIFieldStatus(val);
        }
    });
});
 
// é é¢è¼‰å…¥æ™‚å…ˆåŸ·è¡Œä¸€æ¬¡æª¢æŸ¥ï¼ˆé é˜²é è¨­å€¼å°±æ˜¯ NAï¼‰
window.addEventListener('load', () => {
    const currentKiType = document.getElementById('kiType').value;
    updateKIFieldStatus(currentKiType);
});
 
document.getElementById('runBtn').addEventListener('click', async () => {
    const btn = document.getElementById('runBtn');
    const loader = document.getElementById('loading');
    const resSec = document.getElementById('result-section');
  
    // 1. åˆå§‹åŒ–ä»‹é¢
    btn.disabled = true;
    loader.style.display = 'block';
    resSec.style.display = 'none';
    if (window.mcScenarioChart) { window.mcScenarioChart.destroy(); window.mcScenarioChart = null; }
    if (window.mcWorstChart) { window.mcWorstChart.destroy(); window.mcWorstChart = null; }
    if (window.techChartInstances) {
        Object.values(window.techChartInstances).forEach(chart => { if (chart) chart.destroy(); });
        window.techChartInstances = {};
    }
    document.getElementById('loading').style.display = 'flex';
    try {
        // è®€å–æ‰‹å‹•è¼¸å…¥
        const manualVols = {};
        const existingInputs = document.querySelectorAll('.vol-input');
        existingInputs.forEach(input => {
            const sym = input.getAttribute('data-symbol');
            const val = parseFloat(input.value);
            if (sym && !isNaN(val)) {
                manualVols[sym] = val / 100;
            }
        });
 
        // 2. è®€å– UI åƒæ•¸
        const symbols = document.getElementById('symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
        const apiKey = document.getElementById('apiKey').value;
        const months = parseInt(document.getElementById('months').value);
        const gMonths = parseInt(document.getElementById('guaranteedMonths').value) || 0;
        const years = parseInt(document.getElementById('chartYears').value);
      
        const koFreq = document.getElementById('koFreq').value;
        const koMode = document.getElementById('koMode').value;
        const kiType = document.getElementById('kiType').value;
        const koStep = parseFloat(document.getElementById('koStep').value) || 0;
        const outputSize = Math.max(1000, years * 265 + (months * 21));
        const currentVolDays = months * 21;
        // 3. æŠ“å–è‚¡ç¥¨æ•¸æ“š
        await Promise.all(symbols.map(async (s) => {
            const res = await fetch(`https://api.twelvedata.com/time_series?symbol=${s}&interval=1day&outputsize=${outputSize}&apikey=${apiKey}`).then(r => r.json());
            if(!res.values) throw new Error(`API éŒ¯èª¤ (${s}): ${res.message || 'è«‹æª¢æŸ¥ Key'}`);
            const vals = res.values.reverse();
            globalStockData[s] = {
                labels: vals.map(v => v.datetime),
                prices: vals.map(v => parseFloat(v.close)),
                volumes: vals.map(v => parseFloat(v.volume)),
                name: s
            };
        }));
        // 4. è¨ˆç®—æ³¢å‹•åº¦
        const dim = symbols.length;
        const volSkewRaw = parseFloat(document.getElementById('volSkew').value) || 0;
        const volMultiplier = 1 + (volSkewRaw / 100);
      
        const calculatedVols = symbols.map(s => {
            const p = globalStockData[s].prices;
            const actualVolDays = Math.min(p.length - 1, currentVolDays);
            const sample = p.slice(-(actualVolDays + 1));
            let rets = [];
            for(let i = 1; i < sample.length; i++) { rets.push(Math.log(sample[i] / sample[i-1])); }
            return (math.std(rets) * Math.sqrt(252)) * volMultiplier;
        });
 
        // ã€æ–°å¢é‚è¼¯ã€‘ï¼šåˆ¤æ–·å“ªäº›è‚¡ç¥¨è¢«æ‰‹å‹•ä¿®æ”¹é
        const modifiedFlags = [];
        const finalVols = symbols.map((s, i) => {
            if (manualVols[s] !== undefined) {
                // æ¯”å°ï¼šå°‡å…©è€…éƒ½è½‰ç‚ºé¡¯ç¤ºç”¨çš„å­—ä¸² (å°æ•¸é»å¾Œå…©ä½) é€²è¡Œæ¯”è¼ƒ
                // é€™æ¨£å¯ä»¥é¿å…å› ç‚ºæµ®é»æ•¸èª¤å·®å°è‡´ç³»çµ±ä»¥ç‚ºè¢«ä¿®æ”¹äº†
                const manualStr = (manualVols[s] * 100).toFixed(2);
                const calcStr = (calculatedVols[i] * 100).toFixed(2);
               
                if (manualStr !== calcStr) {
                    modifiedFlags[i] = true; // æ•¸å€¼ä¸åŒï¼Œæ¨™è¨˜ç‚ºå·²ä¿®æ”¹
                } else {
                    modifiedFlags[i] = false; // æ•¸å€¼ç›¸åŒï¼Œè¦–ç‚ºæœªä¿®æ”¹
                }
                return manualVols[s];
            }
            modifiedFlags[i] = false;
            return calculatedVols[i];
        });
        // ç›¸é—œä¿‚æ•¸
        const retsMatrix = [];
        for (let i = 0; i < currentVolDays; i++) {
            let row = []; let isValid = true;
            for (let s of symbols) {
                const p = globalStockData[s].prices;
                if (p.length - 2 - i < 0) { isValid = false; break; }
                row.push(Math.log(p[p.length - 1 - i] / p[p.length - 2 - i]));
            }
            if (isValid) retsMatrix.push(row);
        }
        const corMat = Array.from({length: dim}, (_, i) =>
            Array.from({length: dim}, (_, j) => i === j ? 1 : getCorrelation(retsMatrix.map(r => r[i]), retsMatrix.map(r => r[j])))
        );
        // 5. å°è£åƒæ•¸
        const params = {
            symbols,
            S0: symbols.map(s => globalStockData[s].prices.slice(-1)[0]),
            KO: symbols.map(s => globalStockData[s].prices.slice(-1)[0] * (parseFloat(document.getElementById('koPct').value)/100)),
            AKI: symbols.map(s => globalStockData[s].prices.slice(-1)[0] * (parseFloat(document.getElementById('kiPct').value)/100)),
            K: symbols.map(s => globalStockData[s].prices.slice(-1)[0] * (parseFloat(document.getElementById('strikePct').value)/100)),
            V: finalVols,
            modifiedFlags: modifiedFlags, // å‚³éä¿®æ”¹ç‹€æ…‹
            COR: corMat,
            N: parseInt(document.getElementById('simN').value) || 5000,
            D: months * 21,
            R: (parseFloat(document.getElementById('coupon').value) / 100),
            r: (parseFloat(document.getElementById('riskFreeRate').value) / 100) || 0.05,
            totalMonths: months,
            gMonths: gMonths,
            koFreq: koFreq,
            koMode: koMode,
            kiType: kiType,
            koStep: koStep / 100
        };
       
        document.getElementById('volPeriodLabel').innerText = `(${params.D}å¤©)`;
       
        const mcResult = runSimulation(params);
        renderMCResults(mcResult, params);
        renderCorrelationHeatmap(params.symbols, params.COR);
        runBacktest(params);
        initTechCharts(symbols);
        resSec.style.display = 'block';
    } catch (e) {
        console.error(e);
        alert("åŸ·è¡Œå‡ºéŒ¯: " + e.message);
    } finally {
        btn.disabled = false;
        loader.style.display = 'none';
    }
});
 
 
 
 
 
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}
 
</script>
 
</body></html>
