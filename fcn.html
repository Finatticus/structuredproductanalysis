<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> FCN Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
   
    <style>
        :root {
            --bg-color: #f4f7fa;
            --card-bg: #ffffff;
            --primary: #1a73e8;
            --text-main: #202124;
            --text-sub: #5f6368;
            --border: #dadce0;
            --accent: #e8f0fe;
            --danger: #d93025;
            --success: #188038;
            --warning: #f29900;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-main); padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; }

        h1 { color: var(--primary); text-align: left; font-size: 1.8rem; margin-bottom: 25px; font-weight: 500; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        h3 { color: var(--text-main); font-weight: 500; margin-top: 0;}

        .config-panel { background: var(--card-bg); padding: 25px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(60,64,67,.3); border: 1px solid var(--border); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .input-group { display: flex; flex-direction: column; }

        label { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; }
        input, select { background: #fff; border: 1px solid var(--border); color: var(--text-main); padding: 10px; border-radius: 4px; font-size: 0.9rem; transition: border 0.2s; }

        button { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 1rem; font-weight: 600; margin-top: 20px; transition: background 0.2s; }
        button:hover { background: #1557b0; }
        #loading { display: none; text-align: center; margin: 20px 0; color: var(--primary); font-weight: bold; }

        .result-section { display: none; margin-top: 20px; }
       
        /* ç¾åŒ–æ ¸å¿ƒæ•¸æ“šæ¬„ä½ */
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.04);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        .metric-card:hover { transform: translateY(-2px); }
        .metric-card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary);
        }
        .metric-card.orange::before { background: var(--warning); }
        .metric-card.green::before { background: var(--success); }

        .metric-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .metric-title { font-size: 0.85rem; color: var(--text-sub); font-weight: 700; letter-spacing: 0.5px; }
        .metric-icon { font-size: 1.2rem; opacity: 0.7; }
        .metric-value { display: block; font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 5px 0; }
        .metric-subtext { font-size: 0.75rem; color: var(--text-sub); margin-top: 5px; font-weight: 400; }
       
        .vol-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border); }
        .vol-item { text-align: center; }
        .vol-symbol { font-size: 0.7rem; font-weight: 700; color: var(--text-sub); display: block; }
        .vol-num { font-size: 0.9rem; font-weight: 700; color: var(--primary); }

        .mc-main-charts { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .double-column-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
       
        .card-wrapper { background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(60,64,67,.1); position: relative;}
        .chart-h350 { height: 350px; }
        .chart-auto { min-height: 250px; }

        #techOptions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; margin-bottom: 25px; padding: 10px; background: #eee; border-radius: 8px; }
        .tech-option { background: #fff; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; color: var(--text-sub); border: 1px solid var(--border); font-weight: 500; transition: all 0.2s; }
        .tech-option.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .tech-option.level-toggle { border-color: var(--warning); color: var(--warning); }
        .tech-option.level-toggle.active { background: var(--warning); color: #fff; border-color: var(--warning); }
        .tech-option input { display: none; }

        .stock-charts-area { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .stock-card { background: var(--card-bg); padding: 25px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(60,64,67,.1); }
        .canvas-container { height: 420px; width: 100%; margin-top: 15px; cursor: crosshair; }

        .stats-panel { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-box { background: var(--accent); padding: 15px; border-radius: 6px; text-align: center; border: 1px solid rgba(26,115,232,0.1); }
        .stat-label { font-size: 0.75rem; color: var(--text-sub); display: block; margin-bottom: 5px; font-weight: 600; }
        .stat-num { font-size: 1.2rem; font-weight: bold; color: var(--text-main); }
       
        .heatmap-container { display: flex; justify-content: center; padding: 10px 0; width: 100%; }
        .heatmap-grid { display: grid; gap: 8px; }
        .heatmap-cell { width: 65px; height: 65px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; color: white; border-radius: 6px; }
        .heatmap-label { font-size: 0.8rem; font-weight: 600; color: var(--text-sub); text-align: center; padding: 5px; }

        .backtest-list { list-style: none; padding: 0; margin: 15px 0; }
        .backtest-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .backtest-item:last-child { border-bottom: none; }
        .bt-label { color: var(--text-sub); font-weight: 500; }
        .bt-value { font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Fixed Coupon Note (FCN) Analysis Terminal</h1>

    <div class="config-panel">
        <div class="grid">
            <div class="input-group"><label>API Key</label><input type="text" id="apiKey" value="d7de0902b30e47dead805e170f78bac6"></div>
            <div class="input-group"><label>è‚¡ç¥¨ä»£è™Ÿ (1-3æª”,ç”¨é€—è™Ÿåˆ†éš”)</label><input type="text" id="symbols" value="TSLA,TSM,NVDA"></div>
            <div class="input-group"><label>æå‰å‡ºå ´åƒ¹ KO (%)</label><input type="number" id="koPct" value="100"></div>
<div class="input-group"><label>ä¿è­‰é ˜æ¯æœŸé–“ (æœˆ)</label><input type="number"id="guaranteedMonths" value="1" min="1"></div>
            <div class="input-group"><label>ä¸‹é™åƒ¹ KI (%)</label><input type="number" id="kiPct" value="60"></div>
            <div class="input-group"><label>ä¸‹é™åƒ¹è§€å¯Ÿé »ç‡ KI Freq</label><select id="kiType"><option value="AKI">AKI(æ¯æ—¥è§€å¯Ÿ)</option><option value="EKI">EKI(åˆ°æœŸè§€å¯Ÿ)</option></select></div>
            <div class="input-group"><label>å±¥ç´„åƒ¹ Strike (%)</label><input type="number" id="strikePct" value="75"></div>
            <div class="input-group"><label>å¤©æœŸ (æœˆ)</label><input type="number" id="months" value="6"></div>
            <div class="input-group"><label>å¹´åŒ–é…æ¯ç‡ Coupon (%)</label><input type="number" id="coupon" value="15" step="0.01"></div>
            <div class="input-group"><label>æ¨¡æ“¬æ¬¡æ•¸ Simulations</label><input type="number" id="simN" value="50000"></div>
            <div class="input-group">
                <label>æŠ€è¡“åˆ†ææœŸé–“ (å¹´)</label>
                <select id="chartYears">
                    <option value="1">1 Year</option>
                    <option value="2">2 Years</option>
                    <option value="3">3 Years</option>
                    <option value="5">5 Years</option>
                    <option value="10">10 Years</option>
                </select>
            </div>
        </div>
        <button id="runBtn">Generate Quantitative Analysis</button>
        <div id="loading">Calculating volatility, correlation and history...</div>
    </div>

    <div id="result-section" class="result-section">
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">EXPECTED PAYOFF</span>
                    <span class="metric-icon">ğŸ’°</span>
                </div>
                <span id="avgReturn" class="metric-value">-</span>
                <div class="metric-subtext">é æœŸç¸½åƒ¹å€¼ (å«æ¯/æŠ˜ç¾)</div>
            </div>

            <div class="metric-card orange">
                <div class="metric-header">
                    <span class="metric-title">AVG DURATION</span>
                    <span class="metric-icon">â³</span>
                </div>
                <span id="avgPeriod" class="metric-value">-</span>
                <div class="metric-subtext">é æœŸå­˜çºŒå¤©æ•¸ (å«æå‰å‡ºå ´æ©Ÿç‡)</div>
            </div>

            <div class="metric-card green">
                <div class="metric-header">
                    <span class="metric-title">HISTORICAL VOLATILITY</span>
                    <span id="volPeriodLabel" style="font-size:0.7rem; color:var(--text-sub);">(-)</span>
                </div>
                <div id="volList" class="vol-grid">
                    <div class="vol-item"><span class="vol-symbol">N/A</span><span class="vol-num">-</span></div>
                </div>
                <div class="metric-subtext">å„æ¨™çš„å¹´åŒ–æ­·å²æ³¢å‹•ç‡ (å°æ‡‰ç”¢å“å¤©æœŸ)</div>
            </div>
        </div>

        <div class="mc-main-charts">
            <div class="card-wrapper chart-h350"><canvas id="scenarioChart"></canvas></div>
            <div class="card-wrapper chart-h350"><canvas id="worstChart"></canvas></div>
        </div>

        <div class="double-column-area">
            <div class="card-wrapper chart-auto">
                <h3 style="font-size: 1rem; text-align: left; border-left: 4px solid var(--primary); padding-left: 10px;">ç›¸é—œä¿‚æ•¸çŸ©é™£ Correlation (<span id="corPeriodLabel"></span>)</h3>
                <div id="heatmapArea" class="heatmap-container"></div>
                <p style="font-size: 0.7rem; color: var(--text-sub); text-align: center; margin-top: 5px;">ğŸ’¡ ç´…è‰²æ˜¯æ­£ç›¸é—œï¼Œè—è‰²æ˜¯è² ç›¸é—œï¼Œè¨ˆç®—æœŸé–“èˆ‡ç”¢å“ Duration åŒæ­¥</p>
            </div>

            <div class="card-wrapper chart-auto">
                <h3 style="font-size: 1rem; text-align: left; border-left: 4px solid var(--warning); padding-left: 10px;">æ­·å²å›æ¸¬ (Historical Backtest)</h3>
                <div id="backtestInfo">
                    <div class="backtest-list">
                        <div class="backtest-item"><span class="bt-label">èµ·å§‹æ—¥ Start Date</span><span id="btStart" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">åˆ°æœŸ/å‡ºå ´æ—¥ End Date</span><span id="btEnd" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">è½é»åˆ†å¸ƒ Event</span><span id="btStatus" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">å­˜çºŒæœŸé–“ Days to Event</span><span id="btDays" class="bt-value">-</span></div>
                        <div class="backtest-item"><span class="bt-label">ç¸½æç›Š Total Return</span><span id="btReturn" class="bt-value">-</span></div>
                    </div>
                </div>
                <p style="font-size: 0.7rem; color: var(--text-sub); text-align: center;">ğŸ’¡ ä¸€å€‹é€±æœŸ(æ¯”ç…§å¤©æœŸ)å‰ï¼Œé€²å…¥å¸‚å ´çš„å¯¦éš›è¡¨ç¾</p>
            </div>
        </div>

        <h3 style="margin-top:40px; margin-bottom:15px; border-left: 4px solid var(--primary); padding-left: 10px;">Technical Analysis Window</h3>
        <div id="techOptions">
            <label class="tech-option active"><input type="radio" name="tech" value="none" checked><span>çµ¦æˆ‘ä¹¾æ·¨çš„ç·šåœ–å°±å¥½</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="ma"><span>ç§»å‹•å¹³å‡ç·šMA (20/60/200)</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="bias"><span>ä¹–é›¢ç‡ BIAS 20</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="rsi"><span>ç›¸å°å¼·å¼±æŒ‡æ¨™ RSI 14</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="macd"><span>å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ç·šæŒ‡æ¨™ MACD</span></label>
            <label class="tech-option"><input type="radio" name="tech" value="hv"><span>æ­·å²æ³¢å‹•åº¦ Hist Vol</span></label>
            <label class="tech-option level-toggle" id="lvlBtn"><input type="checkbox" id="showPriceLevels"><span>é¡¯ç¤ºKO, Strike, KIç·š</span></label>
        </div>
        <div id="stockChartsArea" class="stock-charts-area"></div>
    </div>
</div>

<script>
let mcScenarioChart = null, mcWorstChart = null;
let techChartInstances = {};
let globalStockData = {};
let currentVolDays = 126;

class SeededRandom {
    constructor(seed = 12345) { this.seed = seed; }
    next() {
        this.seed = (this.seed * 1664525 + 1013904223) % 4294967296;
        return this.seed / 4294967296;
    }
}

function seededRandn(rng) {
    let u=0, v=0;
    while(u===0) u = rng.next();
    while(v===0) v = rng.next();
    return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
}

function getCorrelation(x, y) {
    const muX = math.mean(x), muY = math.mean(y);
    const stdX = math.std(x), stdY = math.std(y);
    let sum = 0;
    for (let i = 0; i < x.length; i++) sum += (x[i] - muX) * (y[i] - muY);
    return sum / ((x.length - 1) * stdX * stdY);
}

const Calc = {
    MA: (p, n) => p.map((_, i) => i < n - 1 ? null : parseFloat((p.slice(i - n + 1, i + 1).reduce((a, b) => a + b) / n).toFixed(2))),
    BIAS: (p, n = 20) => { const ma = Calc.MA(p, n); return p.map((v, i) => ma[i] ? parseFloat(((v - ma[i]) / ma[i] * 100).toFixed(2)) : null); },
    RSI: (p, n = 14) => {
        let r = [null], g = [], l = [];
        for (let i = 1; i < p.length; i++) {
            let d = p[i] - p[i - 1]; g.push(Math.max(d, 0)); l.push(Math.max(-d, 0));
            if (i < n) r.push(null);
            else {
                let ag = g.slice(i - n, i).reduce((a, b) => a + b) / n;
                let al = l.slice(i - n, i).reduce((a, b) => a + b) / n;
                r.push(parseFloat((100 - (100 / (1 + ag / (al || 1)))).toFixed(2)));
            }
        } return r;
    },
    MACD: (p) => {
        const ema = (data, n) => { let k = 2 / (n + 1), r = [data[0]]; for (let i = 1; i < data.length; i++) r.push(data[i] * k + r[i - 1] * (1 - k)); return r; };
        let s = ema(p, 12), l = ema(p, 26), m = s.map((v, i) => v - l[i]), sig = ema(m, 9);
        return { macd: m, signal: sig };
    },
    HV: (p, n) => p.map((_, i) => {
        if (i < n) return null;
        let slice = p.slice(i - n, i), rets = [];
        for (let j = 1; j < slice.length; j++) rets.push(Math.log(slice[j] / (slice[j - 1] || 1)));
        return parseFloat((Math.sqrt(math.variance(rets)) * Math.sqrt(252) * 100).toFixed(2));
    })
};

document.getElementById('runBtn').addEventListener('click', async () => {
    const btn = document.getElementById('runBtn'), loader = document.getElementById('loading'), resSec = document.getElementById('result-section');
    btn.disabled = true; loader.style.display = 'block'; resSec.style.display = 'none';
    try {
        const symbols = document.getElementById('symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
        const apiKey = document.getElementById('apiKey').value;
        const months = parseInt(document.getElementById('months').value);
        const gMonths = parseInt(document.getElementById('guaranteedMonths').value) || 1;
        const years = parseInt(document.getElementById('chartYears').value);
        const outputSize = Math.max(750, years * 265);

        currentVolDays = months * 21;

        await Promise.all(symbols.map(async (s) => {
            const res = await fetch(`https://api.twelvedata.com/time_series?symbol=${s}&interval=1day&outputsize=${outputSize}&apikey=${apiKey}`).then(r => r.json());
            if(!res.values) throw new Error(`API éŒ¯èª¤ (${s}): ${res.message || 'è«‹æª¢æŸ¥ Key'}`);
            const vals = res.values.reverse();
            globalStockData[s] = { labels: vals.map(v => v.datetime), prices: vals.map(v => parseFloat(v.close)), volumes: vals.map(v => parseFloat(v.volume)), name: s };
        }));

        const dim = symbols.length;
        const vols = symbols.map(s => {
            const p = globalStockData[s].prices.slice(-(currentVolDays + 1));
            let rets = [];
            for(let i=1; i<p.length; i++) rets.push(Math.log(p[i]/p[i-1]));
            return math.std(rets) * Math.sqrt(252);
        });

        const retsMatrix = [];
        const histLen = globalStockData[symbols[0]].prices.length;
        const corWindow = currentVolDays;
        document.getElementById('corPeriodLabel').innerText = `${months}M / ${corWindow}D`;

        for(let i=histLen-corWindow; i<histLen; i++) {
            retsMatrix.push(symbols.map(s => Math.log(globalStockData[s].prices[i] / (globalStockData[s].prices[i-1] || globalStockData[s].prices[i]))));
        }
        const corMat = Array.from({length: dim}, (_, i) => Array.from({length: dim}, (_, j) => i === j ? 1 : getCorrelation(retsMatrix.map(r => r[i]), retsMatrix.map(r => r[j]))));

        const inputCoupon = parseFloat(document.getElementById('coupon').value) / 100;
        const params = { symbols, S0: symbols.map(s => globalStockData[s].prices.slice(-1)[0]), KO: symbols.map((s,i) => globalStockData[s].prices.slice(-1)[0] * (document.getElementById('koPct').value/100)), AKI: symbols.map((s,i) => globalStockData[s].prices.slice(-1)[0] * (document.getElementById('kiPct').value/100)), K: symbols.map((s,i) => globalStockData[s].prices.slice(-1)[0] * (document.getElementById('strikePct').value/100)), V: vols, COR: corMat, N: parseInt(document.getElementById('simN').value), D: months * 21, R: inputCoupon, r: 0.03, CDS: 0.005, totalMonths: months, kiType: document.getElementById('kiType').value,gMonths: gMonths };

        const mcResult = runSimulation(params);
        renderMCResults(mcResult, params);
        renderCorrelationHeatmap(params.symbols, params.COR);
        runBacktest(params);
        initTechCharts(symbols);
        resSec.style.display = 'block';
    } catch (e) { alert("éŒ¯èª¤: " + e.message); }
    finally { btn.disabled = false; loader.style.display = 'none'; }
});

function runBacktest(p) {
    const {symbols, D, R, totalMonths, kiType} = p;
    const histLen = globalStockData[symbols[0]].prices.length;
   
    // è¨ˆç®—å›æ¸¬èµ·å§‹é» (å¾æœ€å¾Œä¸€ç­†æ•¸æ“šå¾€å‰å›æ¨ä¸€å€‹ç”¢å“å¤©æœŸ)
    const startIndex = histLen - D - 1;
    if (startIndex < 0) {
        document.getElementById('btStatus').innerText = "æ•¸æ“šä¸è¶³ç„¡æ³•å›æ¸¬";
        return;
    }

    const startPrices = symbols.map(s => globalStockData[s].prices[startIndex]);
    const KO = startPrices.map(s => s * (document.getElementById('koPct').value / 100));
    const AKI = startPrices.map(s => s * (document.getElementById('kiPct').value / 100));
    const K = startPrices.map(s => s * (document.getElementById('strikePct').value / 100));
   
    let kiTouched = false;
    let event = "Maturity (åˆ°æœŸ)";
    let daysToEvent = D;
    let finalPayoff = 0;

    // --- ä¿®æ”¹è™•ï¼šå»ºç«‹ä¸€å€‹è¿½è¹¤å™¨ï¼Œè¨˜éŒ„æ¯æ”¯è‚¡ç¥¨æ˜¯å¦æ›¾ç¶“è§¸åŠé KO ---
    let koTrackers = new Array(symbols.length).fill(false);

    for (let d = 1; d <= D; d++) {
        const currentIndex = startIndex + d;
        const currentPrices = symbols.map(s => globalStockData[s].prices[currentIndex]);

        // 1. KI ä¸‹é™è§¸ç™¼è§€å¯Ÿ (AKI ç‚ºæ¯æ—¥è§€å¯Ÿ)
        for (let i = 0; i < symbols.length; i++) {
            if (kiType === "AKI" && currentPrices[i] < AKI[i]) kiTouched = true;
           
            // --- ä¿®æ”¹è™•ï¼šæ›´æ–°æ¯æ”¯è‚¡ç¥¨çš„ KO è§¸åŠç‹€æ…‹ ---
            if (currentPrices[i] >= KO[i]) {
                koTrackers[i] = true;
            }
        }

        // --- ä¿®æ”¹è™•ï¼šKO æå‰å‡ºå ´é‚è¼¯ ---
        // æ¢ä»¶ï¼šç¬¬ä¸€å€‹æœˆ(21å¤©)ä¹‹å¾Œï¼Œä¸”ã€Œå…¨éƒ¨ã€è‚¡ç¥¨éƒ½æ›¾ç¶“(æ›¾ç¶“+ç•¶ä¸‹)è§¸åŠé KO
        const minKoDays = totalMonths === 1 ? 21 : (p.gMonths * 21);
if (d >= minKoDays && d % 21 === 0 && koTrackers.every(status => status === true)) {
        event = `Knock-Out (ç¬¬ ${d} å¤©æå‰å‡ºå ´)`
            daysToEvent = d;
            // æç›Šè¨ˆç®—ï¼š100% æœ¬é‡‘ + æŒ‰æŒæœ‰å¤©æ•¸æ¯”ä¾‹è¨ˆç®—çš„é…æ¯
            finalPayoff = 100 * (1 + (d / 252) * R);
            break;
        }

        // 2. åˆ°æœŸæ—¥é‚è¼¯ (è‹¥æœªæå‰å‡ºå ´)
        if (d === D) {
            // EKI åˆ°æœŸè§€å¯Ÿ
            if (kiType === "EKI" && currentPrices.some((s, i) => s < AKI[i])) kiTouched = true;
           
            // åˆ¤æ–·æ˜¯å¦å…¨é¡é€€é‚„æœ¬é‡‘ (æ²’ç¢°åˆ° KIï¼Œæˆ–ç¢°åˆ° KI ä½†æœ€å¾Œå…¨éƒ¨å›æ­¸ Strike ä»¥ä¸Š)
            if (!kiTouched || currentPrices.every((s, i) => s >= K[i])) {
                event = "Full Repayment (æ»¿æœŸè´–å›)";
                finalPayoff = 100 * (1 + (D / 252) * R);
            } else {
                // å¯¦ç‰©äº¤å‰²ï¼šæ‹¿å›æœ€å·®çš„é‚£æ”¯
                event = "KI Delivery (å¯¦ç‰©äº¤å‰²)";
                const perf = currentPrices.map((s, i) => s / K[i]);
                const worstPerf = Math.min(...perf);
                finalPayoff = 100 * (D / 252 * R) + (100 * worstPerf);
            }
        }
    }

    // UI æ›´æ–°
    document.getElementById('btStart').innerText = globalStockData[symbols[0]].labels[startIndex];
    document.getElementById('btEnd').innerText = globalStockData[symbols[0]].labels[startIndex + daysToEvent];
    document.getElementById('btStatus').innerText = event;
    document.getElementById('btDays').innerText = `${daysToEvent} Days`;
    document.getElementById('btReturn').innerText = (finalPayoff - 100).toFixed(2) + "%";
    document.getElementById('btReturn').style.color = (finalPayoff >= 100) ? "var(--success)" : "var(--danger)";
}

function renderCorrelationHeatmap(symbols, corMat) {
    const container = document.getElementById('heatmapArea');
    container.innerHTML = '';
    const size = symbols.length;
    const grid = document.createElement('div');
    grid.className = 'heatmap-grid';
    grid.style.gridTemplateColumns = `repeat(${size + 1}, auto)`;
    grid.appendChild(document.createElement('div'));
    symbols.forEach(s => {
        const label = document.createElement('div');
        label.className = 'heatmap-label';
        label.innerText = s;
        grid.appendChild(label);
    });
    for (let i = 0; i < size; i++) {
        const label = document.createElement('div');
        label.className = 'heatmap-label';
        label.style.display = 'flex'; label.style.alignItems = 'center';
        label.innerText = symbols[i];
        grid.appendChild(label);
        for (let j = 0; j < size; j++) {
            const val = corMat[i][j];
            const cell = document.createElement('div');
            cell.className = 'heatmap-cell';
            cell.innerText = val.toFixed(2);
            let r, g, b;
            if (val >= 0) { r = 234; g = Math.round(67 + (185 * (1 - val))); b = Math.round(53 + (200 * (1 - val))); }
            else { r = Math.round(26 + (200 * (1 + val))); g = Math.round(115 + (100 * (1 + val))); b = 232; }
            cell.style.backgroundColor = `rgb(${r},${g},${b})`;
            grid.appendChild(cell);
        }
    }
    container.appendChild(grid);
}

function runSimulation(p) {
    // 1. è§£æ§‹åƒæ•¸ï¼Œç¢ºä¿åŒ…å« gMonths
    const {S0, KO, AKI, K, V, COR, N, D, R, r, CDS, totalMonths, symbols, kiType, gMonths} = p;
    const dim = symbols.length, dt = 1/252, L = dynamicCholesky(COR);
    const rng = new SeededRandom(42);
   
    let payoffs = [],
        periods = [],
        scCounts = new Array(totalMonths + 2).fill(0),
        worstCounts = new Array(dim).fill(0);
       
    // è¨ˆç®—ä¿è­‰é ˜æ¯çš„ç¸½å¤©æ•¸ (ä¾‹å¦‚ 1å€‹æœˆ = 21å¤©)
    const minKoDays = gMonths * 21;

    for (let n = 0; n < N; n++) {
        let St = [...S0], kiTouched = false, ended = false;
       
        for (let d = 1; d <= D; d++) {
            // A. æ¨¡æ“¬è·¯å¾‘è®Šå‹•
            let dz = math.multiply(L, Array.from({length: dim}, () => seededRandn(rng)));
            for (let i = 0; i < dim; i++) {
                St[i] *= Math.exp((r - 0.5 * V[i]**2) * dt + V[i] * Math.sqrt(dt) * dz[i]);
                if (kiType === "AKI" && St[i] < AKI[i]) kiTouched = true;
            }

            // B. åˆ¤æ–· KO (å¤©å¤©è§€å¯Ÿ)
            // åªè¦å¤©æ•¸ d é”åˆ°ä¿è­‰æœŸï¼Œå°±é–‹æ”¾è§¸ç™¼ KO
            if (d >= minKoDays) {
                if (St.every((s, i) => s >= KO[i])) {
                    // è¨ˆç®—å«æ¯æŠ˜ç¾ç¾å€¼
                    payoffs.push(100 * (1 + (d/252)*R) * Math.exp(-(r+CDS)*(d/252)));
                    periods.push(d);
                   
                    /** * é‡è¦ä¿®æ­£ï¼šæœˆä»½åˆ†é¡é‚è¼¯
                     * ä½¿ç”¨ (d-1)/21 ç¢ºä¿ï¼š
                     * ç¬¬ 1-21 å¤©ç™¼ç”Ÿ -> monthIdx = 0 (1M)
                     * ç¬¬ 22-42 å¤©ç™¼ç”Ÿ -> monthIdx = 1 (2M)
                     */
                    let monthIdx = Math.floor((d - 1) / 21);
                    monthIdx = Math.max(0, Math.min(monthIdx, totalMonths - 1));
                   
                    scCounts[monthIdx]++;
                    ended = true;
                    break;
                }
            }

            // C. åˆ°æœŸçµç®— (Maturity)
            if (d === D && !ended) {
                if (kiType === "EKI" && St.some((s, i) => s < AKI[i])) kiTouched = true;
                let disc = Math.exp(-(r+CDS)*(D/252));
               
                if (!kiTouched || St.every((s, i) => s >= K[i])) {
                    // æƒ…æ³ 1ï¼šå®‰å…¨è´–å› (æœªè§¸åŠ KI æˆ– æœ€çµ‚å›å‡)
                    payoffs.push(100 * (1 + (D/252)*R) * disc);
                    scCounts[totalMonths]++;
                } else {
                    // æƒ…æ³ 2ï¼šå¯¦ç‰©äº¤å‰² (è§¸åŠ KI ä¸” æœ€çµ‚ä½æ–¼ Strike)
                    let perf = St.map((s, i) => s / K[i]);
                    let mP = Math.min(...perf);
                    worstCounts[perf.indexOf(mP)]++;
                    payoffs.push((100*(D/252*R) + 100*mP) * disc);
                    scCounts[totalMonths+1]++;
                }
                periods.push(D);
            }
        }
    }

    return {
        avgReturn: math.mean(payoffs),
        avgDay: math.mean(periods),
        scenarioProbs: scCounts.map(c => (c / N) * 100),
        worstAssetProbs: worstCounts.map(c => (c / N) * 100)
    };
}

function dynamicCholesky(A) {
    const n = A.length; let L = Array.from({length: n}, () => new Array(n).fill(0));
    for (let i = 0; i < n; i++) { for (let j = 0; j <= i; j++) {
        let s = 0; for (let k = 0; k < j; k++) s += L[i][k] * L[j][k];
        L[i][j] = (i === j) ? Math.sqrt(Math.max(A[i][i] - s, 0)) : (1.0 / L[j][j] * (A[i][j] - s));
    } } return L;
}

function renderMCResults(res, params) {
    document.getElementById('avgReturn').innerText = res.avgReturn.toFixed(4);
    document.getElementById('avgPeriod').innerText = res.avgDay.toFixed(1) + " Days";
    document.getElementById('volPeriodLabel').innerText = `(${currentVolDays}D)`;
   
    // æ›´æ–°ç¾åŒ–å¾Œçš„æ³¢å‹•ç‡æ¸…å–®
    const volList = document.getElementById('volList');
    volList.innerHTML = params.symbols.map((s, i) => `
        <div class="vol-item">
            <span class="vol-symbol">${s}</span>
            <span class="vol-num">${(params.V[i]*100).toFixed(2)}%</span>
        </div>
    `).join('');

    if(mcScenarioChart) mcScenarioChart.destroy();
    mcScenarioChart = new Chart(document.getElementById('scenarioChart'), { type: 'bar', data: { labels: [...Array(params.totalMonths).keys()].map(i => `KO M${i+1}`).concat(["åˆ°æœŸ-ç¾é‡‘", "å¯¦ç‰©å±¥ç´„"]), datasets: [{ label: 'Probability (%)', data: res.scenarioProbs, backgroundColor: '#1a73e8' }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{title:{display:true, text:'è’™åœ°å¡ç¾…æ¨¡æ“¬æ©Ÿç‡åˆ†å¸ƒ'}} } });
    if(mcWorstChart) mcWorstChart.destroy();
    mcWorstChart = new Chart(document.getElementById('worstChart'), { type: 'pie', data: { labels: params.symbols, datasets: [{ data: res.worstAssetProbs, backgroundColor: ['#ea4335', '#f9ab00', '#34a853'] }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{title:{display:true, text:'ULå¯¦ç‰©å±¥ç´„æ©Ÿç‡'}} } });
}

function initTechCharts(symbols) {
    const area = document.getElementById('stockChartsArea');
    area.innerHTML = '';
    symbols.forEach(s => {
        const card = document.createElement('div');
        card.className = 'stock-card';
        card.innerHTML = `<h3 style="color:var(--primary); margin-top:0;">${s} æ­·å²è‚¡åƒ¹è¡¨ç¾ (Performance History)</h3><div class="canvas-container"><canvas id="chart_${s}"></canvas></div><div id="stats_${s}" class="stats-panel"></div>`;
        area.appendChild(card);
        updateSingleStockChart(s);
    });
}

function updateSingleStockChart(symbol) {
    const data = globalStockData[symbol];
    const years = parseInt(document.getElementById('chartYears').value);
    const displayCount = years * 252;
    const prices = data.prices;
    const labels = data.labels.slice(-displayCount);
    const displayPrices = prices.slice(-displayCount);
    const displayVolumes = data.volumes.slice(-displayCount);
    const selectedTech = document.querySelector('input[name="tech"]:checked').value;
    const showLevels = document.getElementById('showPriceLevels').checked;
    const S0 = displayPrices[displayPrices.length - 1];
    const koPrice = S0 * (document.getElementById('koPct').value / 100);
    const strikePrice = S0 * (document.getElementById('strikePct').value / 100);
    const kiPrice = S0 * (document.getElementById('kiPct').value / 100);
    const datasets = [{ label: "Close Price", data: displayPrices, borderColor: "#1a73e8", borderWidth: 2, pointRadius: 0, fill: false, yAxisID: 'y' }];
    const scales = { y: { position: 'left', ticks:{color: '#202124'}, grid:{color:'#edf2f7'}, grace: '5%' }, yVol: { position: 'right', display: false }, x: { ticks:{color: '#5f6368'}, grid:{display:false} } };
    datasets.push({ type: 'bar', label: "Volume", data: displayVolumes, backgroundColor: 'rgba(26,115,232,0.08)', yAxisID: 'yVol' });
    if(showLevels) {
        const line = (val, label, color) => ({ label, data: new Array(displayPrices.length).fill(val), borderColor: color, borderDash: [4, 4], borderWidth: 1.5, pointRadius: 0, fill: false });
        datasets.push(line(koPrice, `KO (${koPrice.toFixed(1)})`, '#f29900'));
        datasets.push(line(strikePrice, `Strike (${strikePrice.toFixed(1)})`, '#188038'));
        datasets.push(line(kiPrice, `KI (${kiPrice.toFixed(1)})`, '#d93025'));
        const dStrike = displayPrices.filter(p => p < strikePrice).length;
        const dKI = displayPrices.filter(p => p < kiPrice).length;
        document.getElementById(`stats_${symbol}`).innerHTML = `<div class="stat-box"><span class="stat-label">Total Days (${years}Y)</span><span class="stat-num">${displayPrices.length}</span></div><div class="stat-box"><span class="stat-label">Days < Strike</span><span class="stat-num" style="color:var(--success)">${dStrike} (${(dStrike/displayPrices.length*100).toFixed(1)}%)</span></div><div class="stat-box"><span class="stat-label">Days < KI</span><span class="stat-num" style="color:var(--danger)">${dKI} (${(dKI/displayPrices.length*100).toFixed(1)}%)</span></div>`;
    }
    if(selectedTech !== 'none') {
        scales.yInd = { position: 'right', ticks:{color:'#5f6368'}, grid:{drawOnChartArea:false} };
        if(selectedTech === 'ma') {
            datasets.push({ label: "MA20", data: Calc.MA(prices, 20).slice(-displayCount), borderColor: "#f9ab00", borderWidth: 1, pointRadius: 0, yAxisID: 'yInd' });
            datasets.push({ label: "MA60", data: Calc.MA(prices, 60).slice(-displayCount), borderColor: "#34a853", borderWidth: 1, pointRadius: 0, yAxisID: 'yInd' });
            datasets.push({ label: "MA200", data: Calc.MA(prices, 200).slice(-displayCount), borderColor: "#a142f4", borderWidth: 1, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'bias') {
            datasets.push({ label: "BIAS(20)", data: Calc.BIAS(prices, 20).slice(-displayCount), borderColor: "#1a73e8", borderWidth: 2, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'rsi') {
            datasets.push({ label: "RSI(14)", data: Calc.RSI(prices).slice(-displayCount), borderColor: "#e67c73", borderWidth: 1.5, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'macd') {
            const m = Calc.MACD(prices);
            datasets.push({ label: "MACD", data: m.macd.slice(-displayCount), borderColor: "#a142f4", borderWidth: 1.5, pointRadius: 0, yAxisID: 'yInd' });
        } else if(selectedTech === 'hv') {
            datasets.push({ label: `HV`, data: Calc.HV(prices, currentVolDays).slice(-displayCount), borderColor: "#5f6368", borderWidth: 2, pointRadius: 0, yAxisID: 'yInd' });
        }
    }
    const ctx = document.getElementById(`chart_${symbol}`).getContext('2d');
    if(techChartInstances[symbol]) techChartInstances[symbol].destroy();
    techChartInstances[symbol] = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false}, scales, plugins:{ legend:{labels:{boxWidth: 10, font:{size:11}}}, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x', overScaleMode: 'y' } } } } });
}

document.getElementById('techOptions').addEventListener('change', (e) => {
    if(e.target.name === 'tech') {
        document.querySelectorAll('.tech-option:not(.level-toggle)').forEach(el => el.classList.remove('active'));
        e.target.closest('.tech-option').classList.add('active');
    }
    if(e.target.id === 'showPriceLevels') document.getElementById('lvlBtn').classList.toggle('active', e.target.checked);
    Object.keys(techChartInstances).forEach(s => updateSingleStockChart(s));
});

document.getElementById('chartYears').addEventListener('change', () => {
    if (Object.keys(globalStockData).length > 0) Object.keys(techChartInstances).forEach(s => updateSingleStockChart(s));
});
</script>
</body>
</html>
